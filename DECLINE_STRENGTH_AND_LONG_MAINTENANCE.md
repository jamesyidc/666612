# 下跌强度分级系统 & 多单维护功能

## 📋 功能概述

本次更新包含两个主要功能：
1. **下跌强度1-5级分级显示**：根据空单盈利数据实时判断市场下跌强度
2. **多单维护支持**：主账号维护守护进程现已支持多单维护

---

## 🎯 功能1：下跌强度分级系统

### 分级规则

#### 🔥 下跌强度1级 - 轻微下跌
**判断条件**：
- 空单盈利≥100%: ≥0个
- 空单盈利≥90%: ≥0个
- 空单盈利≥80%: ≥0个
- 空单盈利≥70%: =0个
- 空单盈利≥60%: =0个
- 空单盈利≥50%: =0个
- 空单盈利≥40%: ≤3个

**操作建议**：多单买入点在50%

**颜色**：浅黄色渐变
**图标**：🔥

---

#### 🔥🔥 下跌强度2级 - 中等强度下跌
**判断条件**：
- 空单盈利≥100%: ≥0个
- 空单盈利≥90%: ≥0个
- 空单盈利≥80%: ≤0个
- 空单盈利≥70%: =0个
- 空单盈利≥60%: ≤1个
- 空单盈利≥50%: ≤4个
- 空单盈利≥40%: ≤5个

**操作建议**：多单买入点在60%

**颜色**：橙色渐变
**图标**：🔥🔥

---

#### 🔥🔥🔥 下跌强度3级 - 高强度下跌
**判断条件**：
- 空单盈利≥100%: ≤2个
- 空单盈利≥90%: ≤6个
- 空单盈利≥80%: ≤8个
- 空单盈利≥70%: ≤2个
- 空单盈利≥60%: ≤5个
- 空单盈利≥50%: ≤8个
- 空单盈利≥40%: ≤11个

**操作建议**：多单买入点在70-80%

**颜色**：红色渐变
**图标**：🔥🔥🔥

---

#### 🔥🔥🔥🔥 下跌强度4级 - 超高强度下跌
**判断条件**：
- 空单盈利≥90%: ≤2个
- 空单盈利≥80%: ≤6个
- 空单盈利≥70%: ≤8个
- 空单盈利≥60%: ≤8个
- 空单盈利≥50%: ≤8个
- 空单盈利≥40%: ≤11个

**操作建议**：多单买入点在90%

**颜色**：深红色渐变
**图标**：🔥🔥🔥🔥

---

#### 🔥🔥🔥🔥🔥 下跌强度5级 - 极端下跌
**判断条件**：
- 空单盈利≥100%: ≤2个
- 空单盈利≥90%: ≤6个
- 空单盈利≥80%: ≤8个
- 空单盈利≥70%: ≤2个
- 空单盈利≥60%: ≤5个
- 空单盈利≥50%: ≤8个
- 空单盈利≥40%: ≤11个

**操作建议**：多单买入点在100%以上

**颜色**：暗红色渐变
**图标**：🔥🔥🔥🔥🔥

---

### 前端展示

#### 显示卡片
位于主页面顶部统计区域下方，包含：

1. **强度图标**：根据级别显示1-5个火焰图标
2. **强度标题**：显示具体级别和描述
3. **操作建议**：给出多单买入点建议
4. **统计数据**：显示当前各盈利级别的空单数量

#### 样式设计

```css
/* 级别0：市场正常 */
background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
icon: ✅

/* 级别1：轻微下跌 */
background: linear-gradient(135deg, #fbbf24 0%, #fcd34d 100%);
icon: 🔥

/* 级别2：中等强度下跌 */
background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
icon: 🔥🔥

/* 级别3：高强度下跌 */
background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
icon: 🔥🔥🔥

/* 级别4：超高强度下跌 */
background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%);
icon: 🔥🔥🔥🔥

/* 级别5：极端下跌 */
background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
icon: 🔥🔥🔥🔥🔥
```

---

### 技术实现

**文件**: `templates/anchor_system_real.html`

#### 1. HTML结构（第481行附近）
```html
<!-- 下跌强度分级显示 -->
<div class="card" style="margin-bottom: 30px; border: 3px solid #667eea;">
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-title" style="color: white;">
            <span>📉</span>
            市场下跌强度分析
        </div>
    </div>
    <div style="padding: 30px;">
        <div id="declineStrengthDisplay" style="text-align: center;">
            <div style="font-size: 48px;" id="strengthLevel">--</div>
            <div style="font-size: 24px;" id="strengthTitle">正在计算...</div>
            <div style="font-size: 18px;" id="strengthSuggestion">--</div>
            <div style="margin-top: 20px;">
                <strong>统计数据：</strong><br>
                空单盈利≥100%: <strong id="stat100">--</strong> 个 | 
                ≥90%: <strong id="stat90">--</strong> 个 | 
                ≥80%: <strong id="stat80">--</strong> 个 | 
                ≥70%: <strong id="stat70">--</strong> 个 | 
                ≥60%: <strong id="stat60">--</strong> 个 | 
                ≥50%: <strong id="stat50">--</strong> 个 | 
                ≥40%: <strong id="stat40">--</strong> 个
            </div>
        </div>
    </div>
</div>
```

#### 2. JavaScript计算逻辑（第1376行附近）
```javascript
// 计算下跌强度分级
function calculateDeclineStrength(stats) {
    const { profit100, profit90, profit80, profit70, profit60, profit50, profit40 } = stats;
    
    let level = 0;
    let title = '';
    let suggestion = '';
    let bgColor = '';
    let icon = '';
    
    // 按照规则判断级别（从高到低）
    if (/* 级别5条件 */) {
        level = 5;
        title = '下跌强度5级 - 极端下跌';
        suggestion = '多单买入点在100%以上';
        bgColor = 'linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%)';
        icon = '🔥🔥🔥🔥🔥';
    }
    // ... 其他级别判断
    
    // 更新显示
    document.getElementById('strengthLevel').textContent = icon;
    document.getElementById('strengthTitle').textContent = title;
    document.getElementById('strengthSuggestion').textContent = suggestion;
    // ... 更新统计数据
}
```

#### 3. 调用位置（第1677行附近）
```javascript
// 在renderCurrentPositions函数中调用
calculateDeclineStrength({
    profit100,
    profit90,
    profit80,
    profit70,
    profit60,
    profit50,
    profit40
});
```

---

## 🎯 功能2：多单维护支持

### 背景说明

之前主账号维护守护进程只监控空单锚点单，现在已支持多单和空单的维护。

### 守护进程逻辑

**文件**: `anchor_maintenance_daemon.py`

#### 收益率计算（第158行）
```python
def calculate_profit_rate(self, open_price: float, current_price: float, pos_side: str) -> float:
    """计算收益率（含10x杠杆）"""
    if pos_side == 'long':
        # 多单：(当前价 - 开仓价) / 开仓价 * 10 * 100
        return (current_price - open_price) / open_price * 10 * 100
    else:  # short
        # 空单：(开仓价 - 当前价) / 开仓价 * 10 * 100
        return (open_price - current_price) / open_price * 10 * 100
```

#### 维护触发条件
- **多单亏损≥10%**：触发维护
- **空单亏损≥10%**：触发维护

#### 维护策略
1. 补仓10倍底仓
2. 立即平掉大部分
3. 保留≥0.6U底仓（防止锚点单被完全平掉）

### 当前状态

✅ **多单支持已启用**
- 守护进程可以监控所有锚点单（包括多单和空单）
- 收益率计算逻辑已区分多单和空单
- 维护触发条件对多单和空单一致（亏损≥10%）
- 维护流程对多单和空单一致

### 测试验证

#### 多单示例
```
币种：STX-USDT-SWAP
方向：long（多单）
开仓价：0.2526
当前价：0.2433
收益率：(0.2433 - 0.2526) / 0.2526 * 10 * 100 = -36.82%

✅ 收益率-36.82% < -10%，应触发维护
```

#### 空单示例
```
币种：STX-USDT-SWAP
方向：short（空单）
开仓价：0.2673
当前价：0.2432
收益率：(0.2673 - 0.2432) / 0.2673 * 10 * 100 = +90.16%

✅ 收益率+90.16% > -10%，无需维护
```

---

## 📊 使用说明

### 下跌强度系统

1. **实时监控**
   - 系统每30秒自动更新数据
   - 实时计算空单盈利分布
   - 自动判断下跌强度级别

2. **操作参考**
   - 根据下跌强度建议选择多单买入点
   - 级别越高，建议买入点越高
   - 避免在高强度下跌时过早建仓

3. **风险提示**
   - 下跌强度仅供参考
   - 结合其他指标综合判断
   - 控制仓位，分批建仓

### 多单维护系统

1. **自动监控**
   - 守护进程每30秒扫描一次
   - 自动获取实时价格
   - 自动计算收益率

2. **维护触发**
   - 多单亏损≥10%自动触发
   - 空单亏损≥10%自动触发
   - 每个锚点单只维护一次

3. **维护流程**
   - 补仓10倍底仓数量
   - 立即平掉大部分
   - 保留≥0.6U底仓

---

## 📝 相关文件

### 前端
- `templates/anchor_system_real.html`
  - 新增下跌强度显示卡片（HTML）
  - 新增calculateDeclineStrength函数（JavaScript）
  - 集成到renderCurrentPositions函数

### 后端
- `anchor_maintenance_daemon.py`
  - calculate_profit_rate函数支持多单和空单
  - check_single_position函数统一处理
  - 维护流程对多单和空单一致

---

## 🎨 界面展示

### 下跌强度卡片示例

**级别0：市场正常**
```
✅
市场正常
暂无明显下跌信号

统计数据：
空单盈利≥100%: 0 个 | ≥90%: 0 个 | ≥80%: 0 个 | 
≥70%: 0 个 | ≥60%: 0 个 | ≥50%: 0 个 | ≥40%: 0 个
```

**级别3：高强度下跌**
```
🔥🔥🔥
下跌强度3级 - 高强度下跌
多单买入点在70-80%

统计数据：
空单盈利≥100%: 2 个 | ≥90%: 4 个 | ≥80%: 6 个 | 
≥70%: 2 个 | ≥60%: 5 个 | ≥50%: 8 个 | ≥40%: 10 个
```

**级别5：极端下跌**
```
🔥🔥🔥🔥🔥
下跌强度5级 - 极端下跌
多单买入点在100%以上

统计数据：
空单盈利≥100%: 2 个 | ≥90%: 6 个 | ≥80%: 8 个 | 
≥70%: 2 个 | ≥60%: 5 个 | ≥50%: 8 个 | ≥40%: 11 个
```

---

## ⚠️ 注意事项

### 下跌强度系统

1. **仅供参考**
   - 下跌强度是辅助指标
   - 不构成投资建议
   - 需结合其他因素综合判断

2. **数据依赖**
   - 基于空单盈利数据计算
   - 需要有足够的空单样本
   - 数据更新延迟30秒

3. **级别判断**
   - 级别从高到低依次判断
   - 优先匹配高级别
   - 未匹配任何级别显示"市场正常"

### 多单维护系统

1. **触发条件**
   - 只监控is_anchor=1的锚点单
   - 多单和空单统一为亏损≥10%
   - 每个锚点单只维护一次

2. **价格数据**
   - 优先使用OKEx实时API
   - API失败时降级到数据库
   - 确保价格数据准确性

3. **维护策略**
   - 固定10倍补仓
   - 保留≥0.6U底仓
   - 维护后不再二次维护

---

## 📊 Git记录

- **Commit**: 22ae63c
- **Message**: "添加下跌强度1-5级分级显示功能：根据空单盈利数据判断市场下跌强度并给出多单买入建议"
- **仓库**: https://github.com/jamesyidc/666612.git
- **分支**: main
- **文件修改**: `templates/anchor_system_real.html` (+132行)

---

## 🚀 部署状态

- ✅ 下跌强度分级系统已部署
- ✅ 前端显示卡片已添加
- ✅ JavaScript计算逻辑已实现
- ✅ 多单维护支持已启用
- ✅ Flask应用已重启
- ✅ 代码已提交并推送

---

## 🎯 总结

### 已完成功能

1. ✅ **下跌强度1-5级分级系统**
   - 5个级别的判断规则
   - 实时计算和显示
   - 多单买入点建议
   - 详细统计数据展示

2. ✅ **多单维护支持**
   - 守护进程支持多单
   - 收益率计算区分多单/空单
   - 维护流程统一处理
   - 实时价格获取

### 用户价值

1. **市场判断辅助**
   - 直观了解市场下跌强度
   - 及时把握买入时机
   - 减少盲目建仓风险

2. **自动化管理**
   - 多单自动维护
   - 减少人工监控
   - 提高资金效率

3. **风险控制**
   - 分级警示下跌风险
   - 建议合理买入点
   - 自动触发维护保护

---

**✅ 两项功能均已完成并部署上线！**
