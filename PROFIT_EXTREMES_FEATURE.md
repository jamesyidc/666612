# æŒä»“ç›ˆåˆ©æå€¼åŠŸèƒ½å®ç°æŠ¥å‘Š

## å®ç°æ—¶é—´
2026-01-02 00:10

## åŠŸèƒ½éœ€æ±‚

ç”¨æˆ·åé¦ˆï¼š"æå€¼æ˜¯æˆ‘çš„ç›ˆåˆ©æå€¼å’ŒäºæŸæå€¼ï¼Œå’Œokexçš„æå€¼æœ‰ä»€ä¹ˆå…³ç³»"

### éœ€æ±‚æ¾„æ¸…

ç”¨æˆ·éœ€è¦çš„**ä¸æ˜¯**OKExçš„24å°æ—¶å¸‚åœºæå€¼ï¼Œè€Œæ˜¯ï¼š
- **ç›ˆåˆ©æå€¼**ï¼šè¿™ä¸ªæŒä»“å¼€ä»“åè¾¾åˆ°è¿‡çš„æœ€é«˜ç›ˆåˆ©ç‡
- **äºæŸæå€¼**ï¼šè¿™ä¸ªæŒä»“å¼€ä»“åè¾¾åˆ°è¿‡çš„æœ€å¤§äºæŸç‡

### ä½¿ç”¨åœºæ™¯

å‡è®¾ç”¨æˆ·å¼€ä»“ FIL-USDT-SWAP åšå¤šï¼š
- å½“å‰ç›ˆäºç‡ï¼š-25.95%
- **æƒ³çŸ¥é“**ï¼š
  - è¿™ä¸ªæŒä»“æ›¾ç»ç›ˆåˆ©æœ€å¤šæ—¶è¾¾åˆ°è¿‡å¤šå°‘ï¼Ÿï¼ˆä¾‹å¦‚ï¼š+40%ï¼‰
  - è¿™ä¸ªæŒä»“äºæŸæœ€å¤šæ—¶è¾¾åˆ°è¿‡å¤šå°‘ï¼Ÿï¼ˆä¾‹å¦‚ï¼š-30%ï¼‰

è¿™äº›æ•°æ®å¯ä»¥å¸®åŠ©ç”¨æˆ·ï¼š
1. è®°å½•é”™è¿‡çš„æœ€ä½³å¹³ä»“æ—¶æœº
2. äº†è§£æ‰¿å—çš„æœ€å¤§å›æ’¤
3. åˆ†ææŒä»“çš„ç›ˆäºæ³¢åŠ¨æƒ…å†µ

---

## å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®åº“è¡¨ç»“æ„

åˆ›å»º `position_profit_extremes` è¡¨ï¼š

```sql
CREATE TABLE position_profit_extremes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    inst_id TEXT NOT NULL,
    pos_side TEXT NOT NULL,
    open_time TEXT NOT NULL,
    max_profit_rate REAL DEFAULT 0,      -- æœ€é«˜ç›ˆåˆ©ç‡ï¼ˆ%ï¼‰
    max_profit_time TEXT,                -- è¾¾åˆ°æœ€é«˜ç›ˆåˆ©ç‡çš„æ—¶é—´
    max_loss_rate REAL DEFAULT 0,        -- æœ€å¤§äºæŸç‡ï¼ˆ%ï¼‰
    max_loss_time TEXT,                  -- è¾¾åˆ°æœ€å¤§äºæŸç‡çš„æ—¶é—´
    current_profit_rate REAL DEFAULT 0,  -- å½“å‰ç›ˆäºç‡
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(inst_id, pos_side, open_time)
)
```

### 2. å®ˆæŠ¤è¿›ç¨‹

åˆ›å»º `position_profit_extremes_tracker.py`ï¼š

**åŠŸèƒ½**ï¼š
- æ¯60ç§’æ‰«æä¸€æ¬¡æ‰€æœ‰æŒä»“
- è·å–å½“å‰ç›ˆäºç‡
- å¦‚æœè¶…è¿‡å†å²æœ€é«˜ç›ˆåˆ©ç‡ â†’ æ›´æ–°æœ€é«˜ç›ˆåˆ©ç‡
- å¦‚æœä½äºå†å²æœ€å¤§äºæŸç‡ â†’ æ›´æ–°æœ€å¤§äºæŸç‡

**è¿è¡Œæ–¹å¼**ï¼š
```bash
pm2 start position_profit_extremes_tracker.py --name profit-extremes-tracker
```

### 3. APIè¿”å›æ•°æ®

åœ¨ `/api/anchor-system/current-positions` æ¥å£ä¸­æ·»åŠ å­—æ®µï¼š

```json
{
  "inst_id": "FIL-USDT-SWAP",
  "pos_side": "long",
  "profit_rate": -25.95,          // å½“å‰ç›ˆäºç‡
  
  // âœ¨ æ–°å¢å­—æ®µ
  "max_profit_rate": 15.5,        // æœ¬æ¬¡æŒä»“çš„æœ€é«˜ç›ˆåˆ©ç‡
  "max_profit_time": "2026-01-01 12:30:15",
  "max_loss_rate": -28.3,         // æœ¬æ¬¡æŒä»“çš„æœ€å¤§äºæŸç‡
  "max_loss_time": "2026-01-01 14:15:42",
  
  // é¢å¤–æä¾›çš„å¸‚åœºæ•°æ®ï¼ˆå‚è€ƒç”¨ï¼‰
  "market_high_24h": 1.522,       // 24å°æ—¶å¸‚åœºæœ€é«˜ä»·
  "market_low_24h": 1.255          // 24å°æ—¶å¸‚åœºæœ€ä½ä»·
}
```

---

## å®ç°ç»†èŠ‚

### å®ˆæŠ¤è¿›ç¨‹é€»è¾‘

```python
def update_profit_extremes(inst_id, pos_side, open_time, current_profit_rate):
    """æ›´æ–°ç›ˆåˆ©æå€¼è®°å½•"""
    # æŸ¥è¯¢ç°æœ‰è®°å½•
    SELECT max_profit_rate, max_loss_rate 
    FROM position_profit_extremes 
    WHERE inst_id = ? AND pos_side = ? AND open_time = ?
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æœ€é«˜ç›ˆåˆ©ç‡
    if current_profit_rate > max_profit_rate:
        UPDATE ... SET max_profit_rate = ?, max_profit_time = ?
        print(f"ğŸ“ˆ {inst_id} æ–°é«˜ç›ˆåˆ©: {current_profit_rate:.2f}%")
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æœ€å¤§äºæŸç‡
    elif current_profit_rate < max_loss_rate:
        UPDATE ... SET max_loss_rate = ?, max_loss_time = ?
        print(f"ğŸ“‰ {inst_id} æ–°ä½äºæŸ: {current_profit_rate:.2f}%")
```

### APIæŸ¥è¯¢é€»è¾‘

```python
# ä»æ•°æ®åº“è·å–å¼€ä»“æ—¶é—´
if db_record:
    open_time = db_record['created_at'] or db_record['updated_time']
    
    # æŸ¥è¯¢ç›ˆåˆ©æå€¼è®°å½•
    cursor.execute('''
        SELECT max_profit_rate, max_profit_time, max_loss_rate, max_loss_time
        FROM position_profit_extremes
        WHERE inst_id = ? AND pos_side = ? AND open_time = ?
    ''', (inst_id, pos_side, open_time))
    
    # è¿”å›æå€¼æ•°æ®
    if extreme_row:
        max_profit_rate = extreme_row['max_profit_rate']
        max_loss_rate = extreme_row['max_loss_rate']
```

---

## æµ‹è¯•ç»“æœ

### APIæµ‹è¯•

```bash
curl "http://localhost:5000/api/anchor-system/current-positions?trade_mode=real"
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "positions": [
    {
      "inst_id": "CFX-USDT-SWAP",
      "pos_side": "short",
      "profit_rate": -2.64,
      "max_profit_rate": null,       // å®ˆæŠ¤è¿›ç¨‹è¿˜æœªæ”¶é›†æ•°æ®
      "max_loss_rate": null,
      "market_high_24h": 0.0725,     // å¸‚åœº24hæœ€é«˜ä»· âœ…
      "market_low_24h": 0.06836      // å¸‚åœº24hæœ€ä½ä»· âœ…
    }
  ]
}
```

### å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€

```bash
pm2 status profit-extremes-tracker
```

**çŠ¶æ€**ï¼š
- âœ… å®ˆæŠ¤è¿›ç¨‹å·²å¯åŠ¨
- âš ï¸ é…ç½®è¯»å–éœ€è¦ä¿®å¤ï¼ˆä½¿ç”¨æ­£ç¡®çš„è´¦å·é…ç½®ï¼‰
- ğŸ“Š æ¯60ç§’æ‰«æä¸€æ¬¡æŒä»“

---

## å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ

1. åˆ›å»ºæ•°æ®åº“è¡¨ `position_profit_extremes` âœ…
2. åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ `position_profit_extremes_tracker.py` âœ…
3. åœ¨APIä¸­æ·»åŠ æå€¼æŸ¥è¯¢é€»è¾‘ âœ…
4. è¿”å›4ä¸ªæ–°å­—æ®µï¼š
   - `max_profit_rate` - æœ€é«˜ç›ˆåˆ©ç‡ âœ…
   - `max_profit_time` - è¾¾åˆ°æœ€é«˜ç›ˆåˆ©ç‡æ—¶é—´ âœ…
   - `max_loss_rate` - æœ€å¤§äºæŸç‡ âœ…
   - `max_loss_time` - è¾¾åˆ°æœ€å¤§äºæŸç‡æ—¶é—´ âœ…
5. é¢å¤–è¿”å›å¸‚åœºæå€¼ï¼š
   - `market_high_24h` - 24hå¸‚åœºæœ€é«˜ä»· âœ…
   - `market_low_24h` - 24hå¸‚åœºæœ€ä½ä»· âœ…

### âš ï¸ å¾…ä¼˜åŒ–

1. **å®ˆæŠ¤è¿›ç¨‹é…ç½®é—®é¢˜**ï¼š
   - å½“å‰æ— æ³•è¯»å–APIå¯†é’¥
   - éœ€è¦ä¿®å¤é…ç½®æ–‡ä»¶è¯»å–é€»è¾‘
   - æˆ–è€…ä½¿ç”¨ä¸»è´¦å·çš„API

2. **æ•°æ®åˆå§‹åŒ–**ï¼š
   - æ–°å¼€çš„æŒä»“éœ€è¦ç­‰å¾…å®ˆæŠ¤è¿›ç¨‹æ‰«æåæ‰æœ‰æ•°æ®
   - ç¬¬ä¸€æ¬¡æ‰«æå¯èƒ½éœ€è¦1-2åˆ†é’Ÿ

3. **å†å²æ•°æ®**ï¼š
   - ä¹‹å‰å¼€ä»“çš„æŒä»“æ²¡æœ‰å†å²æå€¼æ•°æ®
   - éœ€è¦ä»å½“å‰å¼€å§‹è®°å½•

---

## å­—æ®µè¯´æ˜

### ç›ˆåˆ©æå€¼å­—æ®µ

| å­—æ®µ | å«ä¹‰ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| `max_profit_rate` | æœ€é«˜ç›ˆåˆ©ç‡ | 40.5% | è¿™ä¸ªæŒä»“æ›¾ç»è¾¾åˆ°çš„æœ€é«˜ç›ˆåˆ© |
| `max_profit_time` | è¾¾åˆ°æ—¶é—´ | 2026-01-01 12:30:15 | è¾¾åˆ°æœ€é«˜ç›ˆåˆ©çš„æ—¶é—´ |
| `max_loss_rate` | æœ€å¤§äºæŸç‡ | -28.3% | è¿™ä¸ªæŒä»“æ›¾ç»è¾¾åˆ°çš„æœ€å¤§äºæŸ |
| `max_loss_time` | è¾¾åˆ°æ—¶é—´ | 2026-01-01 14:15:42 | è¾¾åˆ°æœ€å¤§äºæŸçš„æ—¶é—´ |

### å¸‚åœºæå€¼å­—æ®µï¼ˆå‚è€ƒï¼‰

| å­—æ®µ | å«ä¹‰ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| `market_high_24h` | 24hå¸‚åœºæœ€é«˜ä»· | 1.522 | OKExè¿‡å»24å°æ—¶çš„æœ€é«˜ä»· |
| `market_low_24h` | 24hå¸‚åœºæœ€ä½ä»· | 1.255 | OKExè¿‡å»24å°æ—¶çš„æœ€ä½ä»· |

### åŒºåˆ«

- **ç›ˆåˆ©æå€¼**ï¼šè®°å½•ä½ çš„æŒä»“ç›ˆäºç‡çš„æå€¼ï¼ˆä¸ä½ çš„å¼€ä»“ä»·æœ‰å…³ï¼‰
- **å¸‚åœºæå€¼**ï¼šè®°å½•å¸‚åœºä»·æ ¼çš„æå€¼ï¼ˆä¸ä½ çš„æŒä»“æ— å…³ï¼‰

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šè®°å½•é”™è¿‡çš„æœ€ä½³å¹³ä»“æ—¶æœº

```
FIL-USDT-SWAP long
- å¼€ä»“ä»·: $1.2661
- å½“å‰ä»·: $1.2990
- å½“å‰ç›ˆäº: -25.95%

- æœ€é«˜ç›ˆåˆ©: +40.5% (2026-01-01 12:30)  â† å½“æ—¶åº”è¯¥å¹³ä»“ï¼
- æœ€å¤§äºæŸ: -30.2% (2026-01-01 14:15)
```

**åˆ†æ**ï¼š
- æ›¾ç»ç›ˆåˆ©40%ä½†æ²¡æœ‰å¹³ä»“
- ç°åœ¨äºæŸ25.95%
- é”™è¿‡äº†æœ€ä½³å¹³ä»“æ—¶æœº

### åœºæ™¯2ï¼šäº†è§£æ‰¿å—çš„æœ€å¤§å›æ’¤

```
BTC-USDT-SWAP long
- å½“å‰ç›ˆäº: +15.3%

- æœ€é«˜ç›ˆåˆ©: +28.7% (æ˜¨å¤© 15:30)
- æœ€å¤§äºæŸ: -5.2% (ä»Šå¤© 08:00)
```

**åˆ†æ**ï¼š
- æŒä»“ç»å†äº†-5.2%çš„å›æ’¤
- ä»æœ€é«˜ç‚¹å›è½äº†13.4%
- ä»ç„¶ç›ˆåˆ©15.3%

---

## ä»£ç æäº¤

### æäº¤è®°å½•

1. `a8ce10a` - æ·»åŠ æŒä»“ç›ˆåˆ©æå€¼è·Ÿè¸ªï¼šè®°å½•æœ€é«˜ç›ˆåˆ©ç‡å’Œæœ€å¤§äºæŸç‡
2. `85d39c9` - ä¿®å¤é…ç½®æ–‡ä»¶è·¯å¾„ï¼šä½¿ç”¨sub_account_config.json
3. `cc04f29` - ä¿®å¤é…ç½®è¯»å–ï¼šä½¿ç”¨main_accountå­—æ®µ
4. `fe1ee8b` - ä¿®å¤sqlite3.Rowè®¿é—®ï¼šä½¿ç”¨æ–¹æ‹¬å·è€Œä¸æ˜¯getæ–¹æ³•
5. `aeff6af` - ä¿®å¤å¼€ä»“æ—¶é—´è·å–ï¼šä½¿ç”¨try-exceptå¤„ç†å¯èƒ½çš„NULLå€¼

### æ–‡ä»¶å˜æ›´

- `position_profit_extremes_tracker.py` - æ–°å¢å®ˆæŠ¤è¿›ç¨‹
- `app_new.py` - ä¿®æ”¹APIè¿”å›æ•°æ®
- `trading_decision.db` - æ–°å¢è¡¨ `position_profit_extremes`

---

## PM2 å®ˆæŠ¤è¿›ç¨‹ç®¡ç†

### å¯åŠ¨
```bash
pm2 start position_profit_extremes_tracker.py --name profit-extremes-tracker
```

### çŠ¶æ€æŸ¥çœ‹
```bash
pm2 status profit-extremes-tracker
```

### æ—¥å¿—æŸ¥çœ‹
```bash
pm2 logs profit-extremes-tracker --lines 50
```

### é‡å¯
```bash
pm2 restart profit-extremes-tracker
```

### åœæ­¢
```bash
pm2 stop profit-extremes-tracker
```

---

## ç›¸å…³æ–‡æ¡£

- `EXTREME_AND_MARGIN_FIXES.md` - æå€¼å’Œä¿è¯é‡‘æ˜¾ç¤ºé—®é¢˜ä¿®å¤
- `FINAL_FIX_SUMMARY_2026-01-01.md` - ä»Šæ—¥æ‰€æœ‰ä¿®å¤æ±‡æ€»
- `PROFIT_EXTREMES_FEATURE.md` - æœ¬æ–‡æ¡£

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¼˜å…ˆçº§1ï¼šä¿®å¤å®ˆæŠ¤è¿›ç¨‹
- [ ] ä¿®å¤APIå¯†é’¥è¯»å–é—®é¢˜
- [ ] ç¡®ä¿å®ˆæŠ¤è¿›ç¨‹èƒ½æ­£å¸¸è·å–æŒä»“æ•°æ®
- [ ] éªŒè¯æå€¼è®°å½•æ˜¯å¦æ­£ç¡®æ›´æ–°

### ä¼˜å…ˆçº§2ï¼šå‰ç«¯æ˜¾ç¤º
- [ ] åœ¨å‰ç«¯æ˜¾ç¤ºç›ˆåˆ©æå€¼
- [ ] æ·»åŠ æå€¼å˜åŒ–çš„æç¤º
- [ ] æ˜¾ç¤ºè·ç¦»æå€¼çš„ç™¾åˆ†æ¯”

### ä¼˜å…ˆçº§3ï¼šæ•°æ®åˆ†æ
- [ ] ç»Ÿè®¡æ‰€æœ‰æŒä»“çš„å¹³å‡æå€¼
- [ ] åˆ†æç›ˆåˆ©æå€¼å’ŒäºæŸæå€¼çš„åˆ†å¸ƒ
- [ ] ç”ŸæˆæŒä»“ç›ˆäºæ³¢åŠ¨æŠ¥å‘Š

---

**å®ç°å®Œæˆæ—¶é—´**: 2026-01-02 00:10  
**çŠ¶æ€**: åŸºç¡€åŠŸèƒ½å·²å®ç°ï¼Œå®ˆæŠ¤è¿›ç¨‹éœ€è¦ä¼˜åŒ–
