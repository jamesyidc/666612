# æŒä»“ç›ˆåˆ©æå€¼è·Ÿè¸ªç³»ç»Ÿ - å®Œæ•´å®ç°æŠ¥å‘Š

## ä¿®å¤æ—¶é—´
2026-01-01 16:10

## ğŸ“Š åŠŸèƒ½è¯´æ˜

### ä½ è¦çš„"æå€¼"æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸æ˜¯** OKExçš„24å°æ—¶æœ€é«˜æœ€ä½ä»·  
**è€Œæ˜¯** ä½ çš„æŒä»“åœ¨å¼€ä»“åè¾¾åˆ°è¿‡çš„**ç›ˆåˆ©æå€¼å’ŒäºæŸæå€¼**

## æ¦‚å¿µå¯¹æ¯”

| ç±»å‹ | å«ä¹‰ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|------|
| **ç›ˆåˆ©æå€¼** | è¿™ä¸ªæŒä»“å¼€ä»“åè¾¾åˆ°è¿‡çš„**æœ€é«˜ç›ˆåˆ©ç‡** | è®°å½•é”™è¿‡çš„æœ€ä½³å¹³ä»“æ—¶æœº | æ›¾ç»ç›ˆåˆ©è¿‡ +42% |
| **äºæŸæå€¼** | è¿™ä¸ªæŒä»“å¼€ä»“åè¾¾åˆ°è¿‡çš„**æœ€å¤§äºæŸç‡** | è®°å½•æ‰¿å—çš„æœ€å¤§å›æ’¤ | æœ€å¤§äºæŸè¿‡ -30% |
| å¸‚åœº24hæå€¼ | OKExå¸‚åœº24å°æ—¶æœ€é«˜æœ€ä½ä»· | å¸‚åœºè¡Œæƒ…å‚è€ƒ | é«˜1.522 ä½1.255 |

## ç¤ºä¾‹åœºæ™¯

å‡è®¾ä½ çš„ FIL-USDT-SWAP åšå¤šï¼š
- **å¼€ä»“æ—¶é—´**: 2026-01-01 10:00
- **å¼€ä»“ä»·æ ¼**: $1.26
- **å½“å‰ä»·æ ¼**: $1.29
- **å½“å‰ç›ˆäºç‡**: -25.95%

**ç³»ç»Ÿä¼šè·Ÿè¸ª**ï¼š
1. **æœ€é«˜ç›ˆåˆ©ç‡**: 15.5%ï¼ˆåœ¨ 2026-01-01 12:30 è¾¾åˆ°ï¼‰
   - å«ä¹‰ï¼šä½ æ›¾ç»æœ‰æœºä¼šåœ¨ç›ˆåˆ©15.5%æ—¶å¹³ä»“
2. **æœ€å¤§äºæŸç‡**: -28.3%ï¼ˆåœ¨ 2026-01-01 14:15 è¾¾åˆ°ï¼‰
   - å«ä¹‰ï¼šä½ æ‰¿å—çš„æœ€å¤§å›æ’¤æ˜¯-28.3%

## ç³»ç»Ÿæ¶æ„

### 1. æ•°æ®åº“è¡¨
```sql
CREATE TABLE position_profit_extremes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    inst_id TEXT NOT NULL,          -- å¸ç§
    pos_side TEXT NOT NULL,          -- æ–¹å‘ï¼ˆlong/shortï¼‰
    open_time TEXT NOT NULL,         -- å¼€ä»“æ—¶é—´
    max_profit_rate REAL DEFAULT 0,  -- æœ€é«˜ç›ˆåˆ©ç‡ï¼ˆ%ï¼‰
    max_profit_time TEXT,            -- è¾¾åˆ°æœ€é«˜ç›ˆåˆ©ç‡çš„æ—¶é—´
    max_loss_rate REAL DEFAULT 0,    -- æœ€å¤§äºæŸç‡ï¼ˆ%ï¼‰
    max_loss_time TEXT,              -- è¾¾åˆ°æœ€å¤§äºæŸç‡çš„æ—¶é—´
    current_profit_rate REAL DEFAULT 0,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(inst_id, pos_side, open_time)
);
```

### 2. å®ˆæŠ¤è¿›ç¨‹
**æ–‡ä»¶**: `position_profit_extremes_tracker.py`

**åŠŸèƒ½**ï¼š
- æ¯60ç§’æ‰«æä¸€æ¬¡æ‰€æœ‰æŒä»“
- ä»Flask APIè·å–å½“å‰ç›ˆäºç‡
- ä¸æ•°æ®åº“ä¸­çš„æå€¼å¯¹æ¯”
- å¦‚æœå½“å‰ç›ˆåˆ©ç‡ > å†å²æœ€é«˜ç›ˆåˆ©ç‡ â†’ æ›´æ–°æœ€é«˜ç›ˆåˆ©ç‡
- å¦‚æœå½“å‰äºæŸç‡ < å†å²æœ€å¤§äºæŸç‡ â†’ æ›´æ–°æœ€å¤§äºæŸç‡

**å·¥ä½œæµç¨‹**ï¼š
```
1. è°ƒç”¨ Flask API: /api/anchor-system/current-positions?trade_mode=real
2. è·å–æ¯ä¸ªæŒä»“çš„å½“å‰ç›ˆäºç‡
3. æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æå€¼è®°å½•
4. å¯¹æ¯”å¹¶æ›´æ–°ï¼š
   - å½“å‰ç›ˆäºç‡ > max_profit_rate â†’ æ›´æ–°å¹¶è®°å½•æ—¶é—´
   - å½“å‰ç›ˆäºç‡ < max_loss_rate â†’ æ›´æ–°å¹¶è®°å½•æ—¶é—´
5. ç­‰å¾…60ç§’åé‡å¤
```

### 3. APIè¿”å›æ•°æ®

**GET** `/api/anchor-system/current-positions?trade_mode=real`

**è¿”å›ç»“æ„**ï¼š
```json
{
  "success": true,
  "positions": [
    {
      "inst_id": "FIL-USDT-SWAP",
      "pos_side": "long",
      "profit_rate": -25.95,        // å½“å‰ç›ˆäºç‡
      
      // ç›ˆåˆ©æå€¼ï¼ˆä½ è¦çš„ï¼‰âœ¨
      "max_profit_rate": 15.5,      // æ›¾ç»è¾¾åˆ°çš„æœ€é«˜ç›ˆåˆ©ç‡
      "max_profit_time": "2026-01-01 12:30:15",
      "max_loss_rate": -28.3,       // æ›¾ç»è¾¾åˆ°çš„æœ€å¤§äºæŸç‡
      "max_loss_time": "2026-01-01 14:15:42",
      
      // å¸‚åœº24hæå€¼ï¼ˆä»…ä¾›å‚è€ƒï¼‰
      "market_high_24h": 1.522,     // OKEx 24å°æ—¶æœ€é«˜ä»·
      "market_low_24h": 1.255       // OKEx 24å°æ—¶æœ€ä½ä»·
    }
  ]
}
```

## å®ç°ç»†èŠ‚

### æå€¼æ›´æ–°é€»è¾‘

```python
def update_profit_extremes(inst_id, pos_side, open_time, current_profit_rate):
    # æŸ¥è¯¢ç°æœ‰è®°å½•
    record = db.query(inst_id, pos_side, open_time)
    
    if record:
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æœ€é«˜ç›ˆåˆ©ç‡
        if current_profit_rate > record.max_profit_rate:
            record.max_profit_rate = current_profit_rate
            record.max_profit_time = now()
            print(f"ğŸ“ˆ {inst_id} {pos_side} æ–°é«˜ç›ˆåˆ©: {current_profit_rate:.2f}%")
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æœ€å¤§äºæŸç‡
        elif current_profit_rate < record.max_loss_rate:
            record.max_loss_rate = current_profit_rate
            record.max_loss_time = now()
            print(f"ğŸ“‰ {inst_id} {pos_side} æ–°ä½äºæŸ: {current_profit_rate:.2f}%")
    else:
        # åˆ›å»ºæ–°è®°å½•
        db.insert(...)
```

### å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—ç¤ºä¾‹

```
============================================================
ğŸš€ æŒä»“ç›ˆåˆ©æå€¼è·Ÿè¸ªå®ˆæŠ¤è¿›ç¨‹å¯åŠ¨
============================================================
ğŸ“ å·¥ä½œç›®å½•: /home/user/webapp
ğŸ• æ‰«æé—´éš”: 60ç§’
ğŸ“Š åŠŸèƒ½: è·Ÿè¸ªæ¯ä¸ªæŒä»“çš„æœ€é«˜ç›ˆåˆ©ç‡å’Œæœ€å¤§äºæŸç‡
============================================================

============================================================
ğŸ” å¼€å§‹æ‰«ææŒä»“ç›ˆåˆ©æå€¼ - 2026-01-01 16:10:00
============================================================
ğŸ“Š å‘ç° 15 ä¸ªæŒä»“

âœ¨ FIL-USDT-SWAP long åˆ›å»ºæå€¼è®°å½•: -25.95%
ğŸ“ˆ BCH-USDT-SWAP short æ–°é«˜ç›ˆåˆ©: 53.33% (ä¹‹å‰: 40.00%)
ğŸ“‰ DOT-USDT-SWAP long æ–°ä½äºæŸ: -15.20% (ä¹‹å‰: -10.00%)

âœ… æˆåŠŸè·Ÿè¸ª 15 ä¸ªæŒä»“çš„ç›ˆåˆ©æå€¼

â° ç­‰å¾…60ç§’åè¿›è¡Œä¸‹ä¸€æ¬¡æ‰«æ...
```

## éƒ¨ç½²çŠ¶æ€

### PM2æœåŠ¡
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# ç›ˆåˆ©æå€¼è·Ÿè¸ªå™¨
â”‚ 9  â”‚ profit-extremes-tracker  â”‚ online  â”‚ 29.8mb  â”‚

# æŸ¥çœ‹æ—¥å¿—
pm2 logs profit-extremes-tracker --lines 30

# é‡å¯æœåŠ¡
pm2 restart profit-extremes-tracker
```

### æ•°æ®åº“
```bash
# æŸ¥çœ‹æå€¼è®°å½•
sqlite3 trading_decision.db

# æŸ¥è¯¢æ‰€æœ‰æå€¼è®°å½•
SELECT * FROM position_profit_extremes ORDER BY updated_at DESC LIMIT 10;

# æŸ¥è¯¢ç‰¹å®šå¸ç§çš„æå€¼
SELECT * FROM position_profit_extremes WHERE inst_id = 'FIL-USDT-SWAP';
```

## ä½¿ç”¨åœºæ™¯

### 1. ç›˜åå¤ç›˜
```
æŸ¥çœ‹æŒä»“çš„ç›ˆåˆ©æå€¼ï¼š
- FILåšå¤šï¼šæ›¾ç»ç›ˆåˆ©è¿‡15.5%ï¼Œæœ€å¤§äºæŸè¿‡-28.3%
- åæ€ï¼šä¸ºä»€ä¹ˆæ²¡æœ‰åœ¨15.5%æ—¶å¹³ä»“ï¼Ÿ
- å­¦ä¹ ï¼šä¸‹æ¬¡åˆ°15%æ—¶åº”è¯¥è€ƒè™‘éƒ¨åˆ†æ­¢ç›ˆ
```

### 2. æ­¢æŸè®¾ç½®
```
æŸ¥çœ‹æœ€å¤§äºæŸç‡ï¼š
- å¦‚æœæœ€å¤§äºæŸæ˜¯-30%ï¼Œè¯´æ˜ä½ çš„æ‰¿å—èƒ½åŠ›è‡³å°‘æ˜¯-30%
- å¯ä»¥æ®æ­¤è®¾ç½®åˆç†çš„æ­¢æŸä½
```

### 3. æŒä»“åˆ†æ
```
å¯¹æ¯”å½“å‰ç›ˆäºç‡ä¸æå€¼ï¼š
- å½“å‰: -25.95%
- æœ€é«˜ç›ˆåˆ©: +15.5%
- å›æ’¤å¹…åº¦: 41.45%ï¼ˆä»+15.5%åˆ°-25.95%ï¼‰
- åˆ¤æ–­ï¼šæ˜¯å¦åº”è¯¥å¹³ä»“æ­¢æŸï¼Ÿ
```

## æŠ€æœ¯è¦ç‚¹

### 1. å¼€ä»“æ—¶é—´çš„é‡è¦æ€§
- æ¯æ¬¡æŒä»“çš„æå€¼æ˜¯**ç‹¬ç«‹çš„**
- é€šè¿‡ `open_time` åŒºåˆ†ä¸åŒæ‰¹æ¬¡çš„æŒä»“
- åŒä¸€å¸ç§ã€åŒä¸€æ–¹å‘ï¼Œä½†ä¸åŒå¼€ä»“æ—¶é—´ â†’ ä¸åŒçš„æå€¼è®°å½•

### 2. æ•°æ®æ¥æº
- **ä¸è°ƒç”¨OKX API**ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
- é€šè¿‡Flaskå†…éƒ¨APIè·å–æ•°æ®
- åˆ©ç”¨å·²æœ‰çš„æŒä»“æ•°æ®å’Œç›ˆäºè®¡ç®—

### 3. æ€§èƒ½ä¼˜åŒ–
- 60ç§’æ‰«æé—´éš”ï¼ˆä¸ä¼šé€ æˆæ€§èƒ½é—®é¢˜ï¼‰
- åªæ›´æ–°æœ‰å˜åŒ–çš„æå€¼
- æ•°æ®åº“æœ‰å”¯ä¸€ç´¢å¼•ï¼ˆinst_id, pos_side, open_timeï¼‰

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå®ˆæŠ¤è¿›ç¨‹ä¸å·¥ä½œ
```bash
# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
pm2 status profit-extremes-tracker

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs profit-extremes-tracker --err --lines 50

# é‡å¯å®ˆæŠ¤è¿›ç¨‹
pm2 restart profit-extremes-tracker
```

### é—®é¢˜2ï¼šæå€¼å§‹ç»ˆä¸ºnull
```
å¯èƒ½åŸå› ï¼š
1. å®ˆæŠ¤è¿›ç¨‹åˆšå¯åŠ¨ï¼Œè¿˜æ²¡æœ‰æ‰«ææ•°æ®
2. Flask APIè¿”å›é”™è¯¯
3. æ•°æ®åº“ä¸­æ²¡æœ‰å¼€ä»“æ—¶é—´è®°å½•

è§£å†³æ–¹æ³•ï¼š
1. ç­‰å¾…60ç§’åå†æŸ¥çœ‹
2. æ£€æŸ¥Flask APIæ˜¯å¦æ­£å¸¸
3. æ£€æŸ¥æ•°æ®åº“ä¸­çš„position_opensè¡¨
```

### é—®é¢˜3ï¼šæå€¼æ›´æ–°ä¸åŠæ—¶
```
æ­£å¸¸æƒ…å†µï¼š
- å®ˆæŠ¤è¿›ç¨‹æ¯60ç§’æ‰«æä¸€æ¬¡
- æå€¼æ›´æ–°å¯èƒ½æœ‰æœ€å¤š60ç§’çš„å»¶è¿Ÿ

å¦‚éœ€å®æ—¶æ›´æ–°ï¼š
- å¯ä»¥ç¼©çŸ­æ‰«æé—´éš”ï¼ˆä¿®æ”¹sleepæ—¶é—´ï¼‰
- ä½†ä¼šå¢åŠ ç³»ç»Ÿè´Ÿè½½
```

## ç›¸å…³æ–‡ä»¶

### ä»£ç æ–‡ä»¶
- `position_profit_extremes_tracker.py` - å®ˆæŠ¤è¿›ç¨‹
- `app_new.py` - Flask APIï¼ˆè¿”å›æå€¼æ•°æ®ï¼‰
- `trading_decision.db` - æ•°æ®åº“

### æ–‡æ¡£æ–‡ä»¶
- `PROFIT_EXTREMES_TRACKER_GUIDE.md` - æœ¬æ–‡æ¡£
- `EXTREME_AND_MARGIN_FIXES.md` - æå€¼å’Œä¿è¯é‡‘ä¿®å¤æŠ¥å‘Š

## æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•APIè¿”å›
```bash
curl -s "http://localhost:5000/api/anchor-system/current-positions?trade_mode=real" | \
  python3 -c "
import json, sys
data = json.load(sys.stdin)
for pos in data['positions'][:2]:
    print(f\"{pos['inst_id']} {pos['pos_side']}:\")
    print(f\"  å½“å‰ç›ˆäºç‡: {pos['profit_rate']:.2f}%\")
    print(f\"  æœ€é«˜ç›ˆåˆ©ç‡: {pos['max_profit_rate']}\")
    print(f\"  æœ€å¤§äºæŸç‡: {pos['max_loss_rate']}\")
"
```

### 2. æµ‹è¯•æ•°æ®åº“
```bash
sqlite3 trading_decision.db << EOF
SELECT 
    inst_id,
    pos_side,
    max_profit_rate,
    max_loss_rate,
    current_profit_rate,
    updated_at
FROM position_profit_extremes
ORDER BY updated_at DESC
LIMIT 5;
EOF
```

### 3. æ¨¡æ‹Ÿæå€¼æ›´æ–°
```bash
# ç›‘æ§å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æå€¼æ›´æ–°
pm2 logs profit-extremes-tracker --lines 100 | grep "ğŸ“ˆ\|ğŸ“‰"
```

## ç³»ç»ŸçŠ¶æ€

### âœ… å·²å®Œæˆ
- [x] åˆ›å»ºæ•°æ®åº“è¡¨ `position_profit_extremes`
- [x] å®ç°å®ˆæŠ¤è¿›ç¨‹ `position_profit_extremes_tracker.py`
- [x] Flask APIè¿”å›æå€¼æ•°æ®
- [x] PM2æœåŠ¡é…ç½®å’Œå¯åŠ¨
- [x] æµ‹è¯•éªŒè¯

### ğŸŸ¢ æ­£å¸¸è¿è¡Œ
```
âœ… Flask API - æ­£å¸¸è¿”å›æå€¼æ•°æ®
âœ… å®ˆæŠ¤è¿›ç¨‹ - æ¯60ç§’æ‰«æä¸€æ¬¡
âœ… æ•°æ®åº“ - è®°å½•æå€¼æ•°æ®
âœ… 24hå¸‚åœºæå€¼ - æ­£å¸¸è¿”å›
```

### ğŸ“Š æ•°æ®ç¤ºä¾‹
```json
{
  "inst_id": "FIL-USDT-SWAP",
  "pos_side": "short",
  "current_profit_rate": 0.0,
  "max_profit_rate": null,  // ç­‰å¾…ç¬¬ä¸€æ¬¡æ‰«æ
  "max_loss_rate": null,    // ç­‰å¾…ç¬¬ä¸€æ¬¡æ‰«æ
  "market_high_24h": 1.522,
  "market_low_24h": 1.255
}
```

## ä¸‹ä¸€æ­¥

1. **ç­‰å¾…æ•°æ®ç§¯ç´¯**ï¼šå®ˆæŠ¤è¿›ç¨‹ä¼šåœ¨æ¥ä¸‹æ¥çš„æ‰«æä¸­å¼€å§‹è®°å½•æå€¼
2. **åˆ·æ–°å‰ç«¯**ï¼šç¡®ä¿å‰ç«¯æ˜¾ç¤ºç›ˆåˆ©æå€¼è€Œä¸æ˜¯å¸‚åœºæå€¼
3. **ç›‘æ§è¿è¡Œ**ï¼šè§‚å¯Ÿå®ˆæŠ¤è¿›ç¨‹æ—¥å¿—ï¼Œç¡®ä¿æ­£å¸¸å·¥ä½œ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-01 16:10  
**çŠ¶æ€**: ç³»ç»Ÿå·²éƒ¨ç½²ï¼Œç­‰å¾…æ•°æ®ç§¯ç´¯  
**é¢„è®¡ç”Ÿæ•ˆ**: 60ç§’åå¼€å§‹è®°å½•ç¬¬ä¸€æ‰¹æå€¼æ•°æ®
