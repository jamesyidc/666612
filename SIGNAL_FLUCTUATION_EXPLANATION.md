# 24小时信号数波动说明

## 问题描述

在历史记录页面中，24小时信号数出现规律性波动：
- 高值：870-880个信号
- 低值：690-700个信号  
- 波动幅度：±180个信号
- 波动频率：每3分钟左右

## 波动原因

### 1. 滚动窗口机制

24小时信号数的计算逻辑：
```sql
SELECT COUNT(*)
FROM support_resistance_snapshots
WHERE snapshot_time >= (当前时间 - 24小时)
  AND (scenario_3_count + scenario_4_count) >= 5
```

这是一个**滚动窗口**：
- 每次统计都基于"当前时间往前推24小时"
- 随着时间推移，旧的快照会超过24小时被排除
- 新的快照会进入统计范围

### 2. 历史数据特征

24小时前（2026-01-02 12:20-12:40）的市场状况：
- 这个时间段有大量逃顶信号
- 大约有180个快照满足条件（信号数≥5）
- 这些快照集中在3分钟左右的时间段

### 3. 波动模式

```
时间轴示意：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        24小时前              当前时间
        (2026-01-02 12:30)  (2026-01-03 12:30)
        
        [大量信号]           [统计窗口]
        ██████ (180个)       ←─── 24小时 ───┐
                                            │
        随着时间推移：                        │
        ├─ 12:33  窗口右移 →  这批信号仍在窗口内  → 880个
        ├─ 12:36  窗口右移 →  这批信号移出窗口外  → 700个
        └─ 12:39  窗口右移 →  新信号进入窗口    → 880个
```

### 4. 具体数据验证

从历史记录中观察到的波动模式：

| 时间 | 24H信号 | 变化 | 说明 |
|------|---------|------|------|
| 12:38:35 | 881 | - | 高值期 |
| 12:39:23 | 701 | ↓-180 | 突然下降 |
| 12:35:34 | 878 | - | 高值期 |
| 12:36:20 | 698 | ↓-180 | 突然下降 |
| 12:32:34 | 875 | - | 高值期 |
| 12:33:20 | 695 | ↓-180 | 突然下降 |

**规律**：
- 每3分钟出现一次大幅下降（-180）
- 说明24小时前的那段时间，每3分钟有一批信号被移出窗口

## 这是正常现象吗？

✅ **是正常现象**

1. **滚动窗口的固有特性**  
   24小时窗口会自然排除超过24小时的旧数据

2. **反映历史市场状况**  
   波动说明24小时前市场确实有过一段活跃期

3. **统计逻辑正确**  
   记录脚本正确地统计了过去24小时内满足条件的快照数量

## 如何理解这个数字？

### 正确理解

24小时信号数 = **过去24小时内，有多少个时刻出现了逃顶信号（信号数≥5）**

- 不是信号的总数
- 而是满足条件的**快照数量**
- 每分钟采集一次快照
- 所以最大值理论上是 1440（24小时×60分钟）

### 当前数值含义

- **880个信号** = 过去24小时内，有880个时刻（分钟）出现逃顶信号
- **700个信号** = 某个3分钟时间窗口移出后，剩余700个时刻有信号
- **波动幅度180** = 表示24小时前的那3分钟内，平均每分钟都有逃顶信号

## 如何避免误解？

### 1. 查看趋势而非绝对值

不要过分关注单个数值（880还是700），而应该关注：
- 整体趋势是上升还是下降
- 2小时信号数是否也在增加（更能反映近期市场状况）
- 极值数据的变化

### 2. 结合多个指标

建议同时查看：
- **24小时信号数**：长期趋势
- **2小时信号数**：短期状况  
- **下跌强度等级**：市场下跌程度
- **上涨强度等级**：市场上涨程度

### 3. 理解极值的意义

极值卡片显示：
- **24小时最大值：857** - 历史上24小时信号最多的记录
- **2小时最大值：117** - 历史上2小时信号最多的记录

这些是所有历史记录中的最大值，不是当前值。

## 优化建议

如果想要更平滑的数据：

### 选项1：使用移动平均
```python
# 计算最近10次记录的平均值
AVG(signal_24h_count) OVER (
    ORDER BY stat_time 
    ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
)
```

### 选项2：增加时间窗口
- 改为48小时窗口：波动会更平滑
- 但会降低对近期变化的敏感度

### 选项3：显示趋势线
- 在图表中添加趋势线
- 淡化短期波动的视觉影响

## 总结

🎯 **核心要点**：

1. ✅ **波动是正常的** - 这是滚动窗口的固有特性
2. ✅ **统计逻辑正确** - 代码按预期工作
3. ✅ **数据真实可靠** - 反映了真实的市场状况

📊 **如何使用**：

- 关注**趋势**而不是瞬时值
- 结合**多个时间窗口**（24H + 2H）
- 参考**市场强度等级**综合判断

⚠️ **注意事项**：

- 不要因为单次波动而过度解读
- 如果需要更平滑的数据，考虑添加移动平均
- 极值数据已修复为正确的857/117

---

**文档创建时间**：2026-01-03 12:45 UTC  
**相关文件**：
- `/home/user/webapp/escape_signal_recorder.py`
- `/home/user/webapp/templates/escape_stats_history.html`
- `/home/user/webapp/databases/crypto_data.db`
