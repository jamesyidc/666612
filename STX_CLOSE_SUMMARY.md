# STX平仓问题解决总结

## 问题描述
子账户Wu666666的STX-USDT-SWAP持仓亏损严重（-50.74%），需要完全平仓。

## 遇到的问题

### 问题1：保证金模式不匹配
**现象**：使用平仓接口时返回错误 `51023: Position doesn't exist`

**原因**：STX持仓是**逐仓模式（isolated）**，但平仓请求使用的是**全仓模式（cross）**

**解决方案**：将平仓请求的 `mgnMode` 从 `cross` 改为 `isolated`

### 问题2：为什么维护失败但平仓成功？
**维护失败原因（OKEx 51008错误）**：
- 子账户超级维护尝试**开新仓+平旧仓**
- 开新仓需要借币权限或更高保证金要求
- Wu666666账户的风险等级/借币权限不足

**平仓成功原因**：
- **只平仓不开仓**，不需要借币
- 直接使用平仓专用接口 `/api/v5/trade/close-position`
- 正确匹配保证金模式（isolated）

## 最终解决方案

### 代码示例
```python
close_body = {
    "instId": "STX-USDT-SWAP",
    "mgnMode": "isolated",  # 关键：使用逐仓模式
    "posSide": "long",
    "ccy": "USDT"
}
```

### 执行结果
- ✅ STX持仓从12张完全平仓
- ✅ 释放保证金约10.1 USDT
- ✅ 子账户现有10个持仓（不含STX）

## 关键经验教训

1. **保证金模式必须匹配**
   - 查询持仓时检查 `mgnMode` 字段
   - 平仓请求必须使用相同的 `mgnMode`

2. **开仓 vs 平仓的区别**
   - **开仓**：需要保证金、可能需要借币权限
   - **平仓**：只需要有持仓即可，无需额外权限

3. **维护策略的局限性**
   - 维护策略（开新仓+平旧仓）适合有足够权限的账户
   - 对于权限受限账户，直接平仓更简单可靠

## 后续建议

1. **修改子账户维护逻辑**
   - 在维护前检查持仓的 `mgnMode`
   - 使用匹配的保证金模式执行操作

2. **STX黑名单保留**
   - STX仍在黑名单中，避免自动维护失败
   - 如需重新启用，需先解决开仓权限问题

3. **监控其他币种**
   - CFX、APT等币种维护正常
   - 继续使用全仓模式维护

---
**日期**: 2026-01-01  
**状态**: ✅ 已解决  
**提交**: 待提交
