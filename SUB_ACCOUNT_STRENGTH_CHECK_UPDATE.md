# 子账户跟单强度等级检查功能更新

## 📅 更新时间
2026-01-03 01:43

## 🎯 更新内容

### 功能说明
在子账户跟单开仓逻辑中添加市场强度等级检查，确保只在市场出现极端行情时才允许跟单开仓。

### 核心逻辑

#### 1. 跟主账户空单亏损开单
- **原逻辑**: 主账户空单亏损时，子账户自动开相同方向的仓位
- **新逻辑**: 
  - ✅ 需要满足: **下跌强度等级 >= 5**
  - ❌ 如果下跌强度等级 < 5，跳过开单
  - 📊 下跌强度基于空单盈利情况判断

#### 2. 跟主账户多单亏损开单
- **原逻辑**: 主账户多单亏损时，子账户自动开相同方向的仓位
- **新逻辑**:
  - ✅ 需要满足: **上涨强度等级 >= 5**
  - ❌ 如果上涨强度等级 < 5，跳过开单
  - 📊 上涨强度基于多单盈利情况判断

### 强度等级判定规则

#### 下跌强度等级（空单盈利情况）
- **等级5**: 有1个及以上空单盈利≥100%
- **等级4**: 有1个空单盈利≥90% 且 有1个空单盈利≥80%
- **等级3**: 有1个空单盈利≥70% 且 有2个空单盈利≥60%
- **等级2**: 有2个空单盈利≥60%
- **等级1**: 有3个空单盈利≥40%
- **等级0**: 不满足以上条件

#### 上涨强度等级（多单盈利情况）
- **等级5**: 有1个及以上多单盈利≥100%
- **等级4**: 有1个多单盈利≥90% 且 有1个多单盈利≥80%
- **等级3**: 有1个多单盈利≥70% 且 有2个多单盈利≥60%
- **等级2**: 有2个多单盈利≥60%
- **等级1**: 有3个多单盈利≥40%
- **等级0**: 不满足以上条件

## 🔧 技术实现

### 新增函数

```python
def get_market_strength():
    """获取市场强度等级（上涨和下跌）"""
    # 1. 调用 /api/anchor/decline-strength 获取下跌强度
    # 2. 分析多单盈利情况计算上涨强度
    # 3. 返回 {'decline_level': 0-5, 'rise_level': 0-5}
```

### 修改位置
文件: `sub_account_opener_daemon.py`
- 第 111-180 行: 新增 `get_market_strength()` 函数
- 第 373-387 行: 在开单前添加强度等级检查

### 检查流程
```
1. 检查跟单开关（follow_short_loss_enabled / follow_long_loss_enabled）
   ↓
2. 【新增】获取市场强度等级
   ↓
3. 【新增】检查强度等级是否>=5
   - 空单亏损 → 检查下跌强度>=5
   - 多单亏损 → 检查上涨强度>=5
   ↓
4. 满足条件后执行开单
```

## 📊 日志输出

### 强度检查通过
```
✅ 下跌强度等级5满足条件（>=5）
✅ 上涨强度等级5满足条件（>=5）
```

### 强度检查不通过
```
⚠️ 下跌强度等级3不足（需要>=5），跳过 BTC-USDT-SWAP short
⚠️ 上涨强度等级2不足（需要>=5），跳过 ETH-USDT-SWAP long
```

## ✅ 验证方法

### 1. 查看守护进程日志
```bash
pm2 logs sub-account-opener --lines 50
```

### 2. 检查强度等级
- 下跌强度: 访问 `/api/anchor/decline-strength`
- 上涨强度: 查看守护进程计算的 rise_level

### 3. 测试场景
- **场景1**: 下跌强度<5，有空单亏损 → 不开单 ✓
- **场景2**: 下跌强度>=5，有空单亏损 → 开单 ✓
- **场景3**: 上涨强度<5，有多单亏损 → 不开单 ✓
- **场景4**: 上涨强度>=5，有多单亏损 → 开单 ✓

## 🎯 预期效果

1. **降低风险**: 只在极端行情时跟单，避免在普通波动中频繁开仓
2. **提高胜率**: 强度等级5代表极端行情，反转概率更高
3. **减少亏损**: 过滤掉不符合条件的跟单信号

## 📝 配置说明

配置文件: `/home/user/webapp/sub_account_config.json`

```json
{
  "follow_short_loss_enabled": true,  // 跟空单亏损开关
  "follow_long_loss_enabled": true,   // 跟多单亏损开关
  "main_account": {
    "enabled": true
  },
  "sub_accounts": [...]
}
```

## 🔄 重启服务

```bash
cd /home/user/webapp
pm2 restart sub-account-opener
pm2 logs sub-account-opener --lines 30
```

## 📌 注意事项

1. 强度等级检查是在跟单开关检查之后进行的
2. 两个条件必须同时满足才允许开单
3. 强度等级计算基于实时持仓数据，每次检查都会重新获取
4. 如果API调用失败，默认强度等级为0，不会开单

## 🔗 相关文件

- `sub_account_opener_daemon.py` - 子账户开单守护进程
- `sub_account_config.json` - 子账户配置文件
- `/api/anchor/decline-strength` - 下跌强度API
- `/api/anchor-system/current-positions` - 持仓数据API

## 📅 Git 提交

```
Commit: 3c7534b
Message: feat: 添加市场强度等级检查，跟单开仓需要满足上涨/下跌强度>=5级
Date: 2026-01-03 01:42
```

---

✅ **更新完成！守护进程已重启，新逻辑已生效。**
