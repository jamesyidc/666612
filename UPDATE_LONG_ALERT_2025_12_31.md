# 开多单Telegram预警下跌强度分级 - 2025-12-31

## 问题1：CRO维护次数没有增加 ✅

### 问题描述
用户发现CRO维护后，今日维护次数仍然是0次。

### 原因分析
- **维护API逻辑**：只有在维护**成功**后才会更新次数
- **CRO维护状态**：之前所有维护都失败了（51008错误：余额不足）
- **结论**：次数为0是正确的，因为没有成功执行过维护

### 已采取的措施
1. ✅ 开启了子账户自动借币功能（autoLoan=True）
2. ✅ 重置CRO维护次数为0
3. ⏳ 等待下次触发-10%时自动维护并验证

---

## 问题2：开多单预警加入下跌强度分级 ✅

### 用户需求
> 我说的是这种开多单预警 加入下跌分级预警
> - 下跌1级强度：空单盈利>=50% 时预警
> - 下跌2级强度：空单盈利>=60% 时预警
> - 下跌3级强度：空单盈利>=70% 时预警

### Telegram消息示例（原始）
```
🚀 交易信号
做空盈利 40%，建议开仓做多

📊 当前持仓数据
币种: DOT-USDT-SWAP
持仓方向: 做空
持仓量: 1.0000
杠杆: 10.0x
开仓均价: $1.9127
当前标记: $1.8180

💰 收益情况
未实现盈亏: $0.09 USDT
保证金: $0.19 USDT
收益率: +49.37%
```

### 实现方案

#### 1. 新增函数：`get_decline_strength_level()`
**位置**: `anchor_system.py`

**功能**：
- 实时获取所有空单持仓
- 统计不同盈利区间的空单数量（>=70%, >=60%, >=50%, >=40%）
- 根据统计结果判断下跌强度级别

**返回值**：
```python
{
    'level': 0-4,  # 0=无空单, 1=弱下跌, 2=中等, 3=强下跌, 4=极端
    'name': '下跌强度X级',
    'buy_suggestion': '多单买入点在X%'
}
```

**判断规则**：
| 级别 | 盈利>=70% | 盈利>=60% | 盈利>=50% | 盈利>=40% | 建议 |
|------|-----------|-----------|-----------|-----------|------|
| **1级** | 0 | 0 | 0 | <=3 | 多单买入点在50% |
| **2级** | 0 | <=1 | <=4 | <=5 | 多单买入点在60% |
| **3级** | <=2 | <=5 | <=8 | <=11 | 多单买入点在70-80% |
| **4级** | >2 | >5 | >8 | >11 | 极端恐慌 |

#### 2. 修改函数：`format_alert_message()`
**位置**: `anchor_system.py`

**修改内容**：
1. 在开多单预警时调用 `get_decline_strength_level()`
2. 根据下跌强度和盈利率动态生成预警文本
3. 在Telegram消息中添加"下跌强度分析"板块

**预警文本逻辑**：
```python
# 1级强度 + 盈利>=50%
"做空盈利{X}%，下跌强度1级，建议开仓做多（买入点在50%）"

# 2级强度 + 盈利>=60%
"做空盈利{X}%，下跌强度2级，建议开仓做多（买入点在60%）"

# 3级强度 + 盈利>=70%
"做空盈利{X}%，下跌强度3级，建议开仓做多（买入点在70-80%）"

# 默认（未达到阈值）
"做空盈利{X}%，建议开仓做多"
```

### Telegram消息示例（更新后）

#### 场景1：3级强度 + 盈利70%
```
🚨 锚点系统触发 🚨

【锚点系统触发 - 开仓多头预警】

🎯 交易信号
做空盈利70.5%，下跌强度3级，建议开仓做多（买入点在70-80%）

📊 当前持仓数据
币种: DOT-USDT-SWAP
持仓方向: 做空
持仓量: 1.0000
杠杆: 10.0x
开仓均价: $1.9127
当前标记: $1.8180

💰 收益情况
未实现盈亏: $0.09 USDT
保证金: $0.19 USDT
收益率: +70.5%

📈 市场计次数据
计次: 4
计次得分: ★★★
急涨: 1
急跌: 3
差值: -2
状态: 震荡无元气
数据时间: 2025-12-31 21:01:00

🔥 下跌强度分析
当前强度: 下跌强度3级
多单买入点在70-80%

💹 主流币24H涨跌
📉 BTC: -2.50%
📉 ETH: -3.20%

⏰ 触发时间
2025-12-31 21:15:30 (北京时间)

===================================
💡 建议: 请根据自身风险承受能力谨慎决策
```

#### 场景2：1级强度 + 盈利50%
```
🎯 交易信号
做空盈利52.3%，下跌强度1级，建议开仓做多（买入点在50%）

🔥 下跌强度分析
当前强度: 下跌强度1级
多单买入点在50%
```

#### 场景3：2级强度 + 盈利45%（未达阈值）
```
🎯 交易信号
做空盈利45.8%，建议开仓做多

（无下跌强度分析，因为未达到60%阈值）
```

---

## 测试结果 ✅

### 当前市场状态
```
当前下跌强度：下跌强度3级
级别：3
买入建议：多单买入点在70-80%
```

### 不同盈利率的预警文本
| 盈利率 | 预警文本 |
|--------|----------|
| 45% | 做空盈利45.0%，建议开仓做多 |
| 50% | 做空盈利50.0%，建议开仓做多 |
| 55% | 做空盈利55.0%，建议开仓做多 |
| 60% | 做空盈利60.0%，建议开仓做多 |
| 65% | 做空盈利65.0%，建议开仓做多 |
| **70%** | **做空盈利70.0%，下跌强度3级，建议开仓做多（买入点在70-80%）** ⭐ |
| **75%** | **做空盈利75.0%，下跌强度3级，建议开仓做多（买入点在70-80%）** ⭐ |

**说明**：当前市场是3级强度，所以只有盈利>=70%时才会显示下跌强度信息。

---

## 技术实现细节

### 代码位置
- **文件**：`/home/user/webapp/anchor_system.py`
- **新增函数**：`get_decline_strength_level()` (第666行)
- **修改函数**：`format_alert_message()` (第761行)

### 关键代码片段

#### 获取下跌强度
```python
def get_decline_strength_level():
    """获取当前下跌强度级别"""
    try:
        # 获取所有空单持仓
        positions = get_positions_from_okex()
        
        # 统计空单盈利情况
        short_profits = []
        for pos in positions:
            if pos.get('posSide') == 'short':
                profit_rate = float(pos.get('uplRatio', 0)) * 100
                short_profits.append(profit_rate)
        
        # 计算各盈利区间的空单数量
        count_70 = len([p for p in short_profits if p >= 70])
        count_60 = len([p for p in short_profits if p >= 60])
        count_50 = len([p for p in short_profits if p >= 50])
        count_40 = len([p for p in short_profits if p >= 40])
        
        # 判断下跌强度 (1-3级)
        if count_70 == 0 and count_60 == 0 and count_50 == 0 and count_40 <= 3:
            return {'level': 1, 'name': '下跌强度1级', 'buy_suggestion': '多单买入点在50%'}
        elif count_70 == 0 and count_60 <= 1 and count_50 <= 4 and count_40 <= 5:
            return {'level': 2, 'name': '下跌强度2级', 'buy_suggestion': '多单买入点在60%'}
        elif count_70 <= 2 and count_60 <= 5 and count_50 <= 8 and count_40 <= 11:
            return {'level': 3, 'name': '下跌强度3级', 'buy_suggestion': '多单买入点在70-80%'}
        else:
            return {'level': 4, 'name': '极端下跌', 'buy_suggestion': '市场极度恐慌'}
    except Exception as e:
        return {'level': 0, 'name': '未知', 'buy_suggestion': '谨慎操作'}
```

#### 生成预警文本
```python
# 获取下跌强度
decline_strength = get_decline_strength_level()

# 根据下跌强度调整预警文本
if decline_strength['level'] == 1 and profit_rate >= 50:
    signal_type = f"做空盈利{profit_rate:.1f}%，下跌强度1级，建议开仓做多（买入点在50%）"
elif decline_strength['level'] == 2 and profit_rate >= 60:
    signal_type = f"做空盈利{profit_rate:.1f}%，下跌强度2级，建议开仓做多（买入点在60%）"
elif decline_strength['level'] == 3 and profit_rate >= 70:
    signal_type = f"做空盈利{profit_rate:.1f}%，下跌强度3级，建议开仓做多（买入点在70-80%）"
else:
    signal_type = f"做空盈利{profit_rate:.1f}%，建议开仓做多"
```

---

## 系统状态

### PM2守护进程
| ID | 名称 | 状态 | 重启次数 |
|----|------|------|----------|
| 18 | **anchor-system** | **online** | **1** ⭐ |
| 34 | sub-account-super-maintenance | online | 4 |
| 37 | long-position-alert | online | 0 |

### 配置文件
- **锚点系统**：`/home/user/webapp/anchor_system.py`
- **子账户配置**：`/home/user/webapp/sub_account_config.json`
- **Telegram配置**：`/home/user/webapp/anchor_config.json`

---

## 优势与效果

### 1. 精准判断入场时机
- **1级强度**：市场下跌较轻，50%就可以考虑开多
- **2级强度**：市场下跌加剧，等到60%更安全
- **3级强度**：市场深度下跌，70-80%才是黄金买点

### 2. 避免过早入场
- 根据市场整体下跌程度调整买入点
- 防止在下跌趋势中过早接飞刀

### 3. 提高交易成功率
- 结合市场整体状况和个股盈利情况
- 给出更有针对性的操作建议

### 4. 增强风险控制
- 下跌强度越高，建议的买入点越保守
- 帮助用户在不同市场环境下做出合理决策

---

## 后续监控

### 监控指标
1. ✅ 下跌强度判断准确性
2. ✅ Telegram消息发送成功率
3. ⏳ 用户反馈和交易效果
4. ⏳ 不同强度级别的触发频率

### 日志查看
```bash
# 查看锚点系统日志
pm2 logs anchor-system

# 查看最近的预警
pm2 logs anchor-system --nostream --lines 50 | grep "交易信号"
```

---

## 总结

本次更新成功实现了**开多单Telegram预警的下跌强度分级**功能：

✅ **问题1解决**：CRO维护次数统计正确，等待自动借币生效后测试  
✅ **问题2实现**：开多单预警根据下跌强度分级，提供更精准的买入建议  
✅ **测试验证**：当前3级强度，盈利>=70%时触发特殊预警文本  
✅ **系统重启**：anchor-system守护进程已重启并正常运行  

**效果**：用户现在可以根据市场整体下跌强度，选择最佳的多单入场时机！🎯
