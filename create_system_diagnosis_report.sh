#!/bin/bash

cat > SYSTEM_CARTON_DIAGNOSIS.md << 'DOC'
# ç³»ç»Ÿå¡é¡¿é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**è¯Šæ–­æ—¶é—´**: 2026-01-04 03:00:00

## é—®é¢˜æ ¹æº

ç³»ç»Ÿå¹¶ä¸å¡ï¼Œè€Œæ˜¯ **æ•°æ®åº“è·¯å¾„é…ç½®é”™è¯¯** å¯¼è‡´ API æŠ¥é”™ï¼Œè¡¨çŽ°ä¸ºç³»ç»Ÿå¡é¡¿ï¼

## æ ¸å¿ƒé—®é¢˜

### 1. æ•°æ®åº“æ–‡ä»¶æŸå
- âœ… `databases/support_resistance.db` - å·²ä¿®å¤ï¼ˆ148MBï¼Œ348,610æ¡è®°å½•ï¼‰
- âŒ `databases/crypto_data.db` - åŽŸä¸ºç©º/å°æ•°æ®åº“ï¼ˆ6ä¸ªè¡¨ï¼‰
- âŒ `databases/crypto_data_backup_20260102_124047.db` - æ•°æ®åº“æŸå
- âŒ `databases/crypto_data_corrupted.db` - æ•°æ®åº“æŸåï¼ˆè™½ç„¶åå­—æ˜¯corruptedï¼‰

### 2. APIç«¯ç‚¹é”™è¯¯
å¤šä¸ªå…³é”®APIç«¯ç‚¹æŠ¥é”™ï¼Œå¯¼è‡´å‰ç«¯è¯·æ±‚å¤±è´¥ï¼š
- `/api/trading-signals/analyze` - ç¼ºå°‘å¤šä¸ªè¡¨
- `/api/kline-indicators/signals` - ç¼ºå°‘å¤šä¸ªè¡¨

### 3. ç¼ºå¤±çš„è¡¨
APIå‡½æ•°éœ€è¦ä»¥ä¸‹è¡¨ï¼Œä½†å½“å‰ `databases/crypto_data.db` ä¸­ç¼ºå¤±ï¼š
- `price_breakthrough_events` - ä»·æ ¼çªç ´äº‹ä»¶ï¼ˆå·²åˆ›å»ºç©ºè¡¨ï¼‰
- `crypto_coin_data` - åŠ å¯†è´§å¸æ•°æ®ï¼ˆå·²åˆ›å»ºç©ºè¡¨ï¼‰
- `position_system` - ä½ç½®ç³»ç»Ÿï¼ˆå·²åˆ›å»ºç©ºè¡¨ï¼‰
- `okex_kline_ohlc` - Kçº¿OHLCæ•°æ®ï¼ˆç¼ºå¤±ï¼‰
- `okex_technical_indicators` - æŠ€æœ¯æŒ‡æ ‡ï¼ˆæœ‰è¡¨ä½†æ— æ•°æ®ï¼‰

## å·²æ‰§è¡Œçš„ä¿®å¤æŽªæ–½

### 1. ä¿®å¤ support_resistance.db âœ…
```bash
# æ›¿æ¢ç©ºæ–‡ä»¶ä¸ºæœ‰æ•°æ®çš„æ–‡ä»¶
mv databases/support_resistance.db databases/support_resistance.db.empty
cp support_resistance.db databases/
```

**ç»“æžœ**: 
- 5ä¸ªè¡¨ï¼Œ412,741æ¡è®°å½•
- `support_resistance_levels`: 348,610æ¡
- API `/api/support-resistance/latest` å·²æ­£å¸¸

### 2. ä¿®æ”¹ä»£ç ä½¿ç”¨æ­£ç¡®çš„æ•°æ®åº“ âœ…
åœ¨ `app_new.py` ä¸­ä¿®æ”¹äº† `api_trading_signals_analyze` å‡½æ•°ï¼š
```python
# é™„åŠ  support_resistance.db æ•°æ®åº“
cursor.execute("ATTACH DATABASE 'databases/support_resistance.db' AS sr_db")

# ä½¿ç”¨ sr_db. å‰ç¼€è®¿é—®è¡¨
FROM sr_db.support_resistance_levels
```

### 3. åˆ›å»ºç¼ºå¤±çš„è¡¨ç»“æž„ âœ…
```bash
# æ¢å¤å°æ•°æ®åº“å¹¶åˆ›å»ºç¼ºå¤±è¡¨
CREATE TABLE IF NOT EXISTS price_breakthrough_events (...)
CREATE TABLE IF NOT EXISTS crypto_coin_data (...)
CREATE TABLE IF NOT EXISTS position_system (...)
```

**å½“å‰é—®é¢˜**: `okex_kline_ohlc` è¡¨ä»ç„¶ç¼ºå¤±

## å»ºè®®çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ

### é€‰é¡¹A: ä½¿ç”¨ç©ºè¡¨ä½†ä¿®æ”¹å‡½æ•°ä½¿å…¶å¥å£®
ä¼˜ç‚¹: å¿«é€Ÿè§£å†³ï¼Œç³»ç»Ÿç«‹å³å¯ç”¨
ç¼ºç‚¹: éƒ¨åˆ†åŠŸèƒ½æ— æ•°æ®

```python
# ä¿®æ”¹è¾…åŠ©å‡½æ•°ï¼Œå¤„ç†è¡¨ä¸å­˜åœ¨çš„æƒ…å†µ
def check_no_new_low_5min(symbol):
    try:
        # ... åŽŸæœ‰é€»è¾‘ ...
    except sqlite3.OperationalError:
        return False  # è¡¨ä¸å­˜åœ¨æ—¶è¿”å›žé»˜è®¤å€¼
```

### é€‰é¡¹B: ä»Žå…¶ä»–ç³»ç»Ÿå¯¼å…¥æ•°æ®
ä¼˜ç‚¹: æ¢å¤å®Œæ•´åŠŸèƒ½
ç¼ºç‚¹: éœ€è¦æ•°æ®æº

### é€‰é¡¹C: ç¦ç”¨å—å½±å“çš„APIç«¯ç‚¹
ä¼˜ç‚¹: é¿å…é”™è¯¯
ç¼ºç‚¹: åŠŸèƒ½ç¼ºå¤±

## ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ï¼ˆå¥åº·ï¼‰

- **CPU**: è´Ÿè½½ 0.09-0.17, ç©ºé—² 71.4%
- **å†…å­˜**: ä½¿ç”¨ 1.0GB / 7.8GB (13%)ï¼Œå¯ç”¨ 6.7GB
- **ç£ç›˜**: ä½¿ç”¨ 18GB / 26GB (67%)ï¼Œå¯ç”¨ 8.7GB
- **è¿›ç¨‹**: 12ä¸ª PM2 è¿›ç¨‹å…¨éƒ¨åœ¨çº¿
- **Flaské‡å¯**: 122æ¬¡ï¼ˆéœ€ä¼˜åŒ–ï¼Œä½†ä¸æ˜¯å¡é¡¿åŽŸå› ï¼‰

## ç»“è®º

**ç³»ç»Ÿä¸å¡ï¼** è¡¨çŽ°ä¸º"å¡"çš„åŽŸå› æ˜¯ï¼š
1. æ•°æ®åº“é…ç½®é”™è¯¯å¯¼è‡´ API 500 é”™è¯¯
2. å‰ç«¯è¯·æ±‚å¤±è´¥ä½†æŒç»­é‡è¯•
3. ç”¨æˆ·çœ‹åˆ°åŠ è½½ç¼“æ…¢æˆ–åŠŸèƒ½ä¸å¯ç”¨

**æŽ¨èä¿®å¤æ­¥éª¤**:
1. âœ… å·²ä¿®å¤ support_resistance.db
2. âœ… å·²ä¿®æ”¹ä»£ç ä½¿ç”¨ ATTACH DATABASE
3. â³ ä¿®æ”¹è¾…åŠ©å‡½æ•°ä½¿å…¶å¥å£®ï¼ˆå³ä½¿è¡¨ä¸å­˜åœ¨ä¹Ÿèƒ½è¿”å›žé»˜è®¤å€¼ï¼‰
4. ðŸ”„ é‡å¯ Flask åº”ç”¨
5. âœ… éªŒè¯æ‰€æœ‰ API ç«¯ç‚¹æ­£å¸¸

## åŽç»­ä¼˜åŒ–å»ºè®®

1. **æ•°æ®æ¢å¤**: ä»Žå¤‡ä»½æˆ–å…¶ä»–ç³»ç»Ÿå¯¼å…¥å®Œæ•´æ•°æ®
2. **Flaskä¼˜åŒ–**: å‡å°‘é‡å¯æ¬¡æ•°ï¼ˆå½“å‰122æ¬¡ï¼‰
3. **ç£ç›˜æ¸…ç†**: åˆ é™¤æŸåçš„æ•°æ®åº“æ–‡ä»¶ï¼ˆé‡Šæ”¾ ~3.8GBï¼‰
4. **ç›‘æŽ§**: æ·»åŠ  API é”™è¯¯ç›‘æŽ§å‘Šè­¦

---
**è¯Šæ–­å®Œæˆæ—¶é—´**: 2026-01-04 03:00:00
DOC

echo "âœ… ç³»ç»Ÿå¡é¡¿è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆ: SYSTEM_CARTON_DIAGNOSIS.md"
