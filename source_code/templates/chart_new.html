<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ symbol }} Kçº¿å›¾ [{{ cache_buster }}]</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0e1117;
            color: #e0e0e0;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #1a1d29;
            border-radius: 8px;
        }
        .nav-btn {
            padding: 10px 20px;
            background: #2d3348;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #00d4aa;
            color: #0e1117;
            transform: translateY(-2px);
        }
        .nav-btn-primary {
            background: #00d4aa;
            color: #0e1117;
            font-weight: bold;
        }
        .nav-btn-primary:hover {
            background: #00e5ba;
        }
        
        h1 { color: #00d4aa; margin-bottom: 20px; font-size: 24px; }
        #kline-chart { 
            width: 100%; 
            height: 600px; 
            background: #1a1d29;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #00d4aa;
        }
        .error {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #ff4444;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #2d3348;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        .tab-btn.active {
            background: #00d4aa;
            color: #0e1117;
            font-weight: bold;
        }
        .pagination {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #1a1d29;
            border-radius: 8px;
        }
        .page-btn {
            padding: 10px 20px;
            background: #2d3348;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        .page-btn:hover {
            background: #3d4358;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-info {
            color: #00d4aa;
            font-size: 14px;
            font-weight: bold;
        }
    
        .indicator-card {
            background: #2d3348;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #00d4aa;
        }
        .indicator-card h4 {
            color: #00d4aa;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .indicator-card .value {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        .indicator-card .label {
            font-size: 12px;
            color: #888;
        }
        .indicator-card.bullish { border-left-color: #00d4aa; }
        .indicator-card.bearish { border-left-color: #ff4444; }
</style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <div class="nav-bar">
            <button class="nav-btn" onclick="goBack()">
                <span>â—€</span>
                <span>è¿”å›ä¸Šä¸€é¡µ</span>
            </button>
            <button class="nav-btn nav-btn-primary" onclick="goHome()">
                <span>ğŸ </span>
                <span>è¿”å›é¦–é¡µ</span>
            </button>
        </div>
        
        <h1>{{ symbol }} - Kçº¿å›¾æŠ€æœ¯åˆ†æ</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTimeframe('5m')">5åˆ†é’Ÿ</button>
            <button class="tab-btn" onclick="switchTimeframe('1h')">1å°æ—¶</button>
        </div>
        
        <!-- ç¿»é¡µæ§åˆ¶ -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" id="prevPageBtn" onclick="prevPage()" disabled>â—€ ä¸Šä¸€é¡µ</button>
            <div class="page-info" id="pageInfo">ç¬¬1é¡µ / å…±1é¡µ</div>
            <button class="page-btn" id="nextPageBtn" onclick="nextPage()" disabled>ä¸‹ä¸€é¡µ â–¶</button>
        </div>
        
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div id="kline-chart"></div>

        
        <!-- æŠ€æœ¯æŒ‡æ ‡æ•°æ®é¢æ¿ -->
        <div id="indicator-panel" style="display: none; margin-top: 20px; background: #1a1d29; border-radius: 8px; padding: 20px;">
            <h3 style="color: #00d4aa; margin-bottom: 15px; font-size: 18px;">ğŸ“Š å½“å‰Kçº¿æŠ€æœ¯æŒ‡æ ‡</h3>
            <div id="indicator-data" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <!-- Indicator data will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const symbol = '{{ symbol }}';
        let klineChart = null;
        let currentTimeframe = '5m';
        
        // åˆ†é¡µç›¸å…³å˜é‡
        let allData = []; // å­˜å‚¨æ‰€æœ‰æ•°æ®
        let currentPage = 1;
        let itemsPerPage = 144; // æ¯é¡µ144æ¡æ•°æ®ï¼ˆ12å°æ—¶ Ã— 12æ¡/å°æ—¶ï¼‰
        let totalPages = 1;
        
        // å…¨å±€æ ‡è®°ç‚¹ï¼ˆåŸºäºå…¨éƒ¨10å¤©æ•°æ®è®¡ç®—ï¼‰
        let globalMarkPoints = [];
        
        // å¯¼èˆªå‡½æ•°
        function goBack() {
            window.location.href = 'https://5000-iz6uddj6rs3xe48ilsyqq-2e1b9533.sandbox.novita.ai/kline-indicators';
        }
        
        function goHome() {
            window.location.href = '/';
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('kline-chart');
            if (chartDom && typeof echarts !== 'undefined') {
                klineChart = echarts.init(chartDom);
                console.log('âœ… å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
                return true;
            }
            console.error('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥');
            return false;
        }
        
        // åŠ è½½æ•°æ®
        async function loadData(timeframe) {
            currentTimeframe = timeframe;
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                console.log('ğŸ“Š å¼€å§‹åŠ è½½æ•°æ®:', symbol, timeframe);
                
                const response = await fetch(`/api/symbol/${symbol}/kline?timeframe=${timeframe}&_=${Date.now()}`);
                const result = await response.json();
                
                if (!result.data || result.data.length === 0) {
                    throw new Error('æ²¡æœ‰æ•°æ®');
                }
                
                console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', result.data.length, 'æ¡');
                
                // ä¿å­˜æ‰€æœ‰æ•°æ®å¹¶è®¡ç®—æ€»é¡µæ•°
                allData = result.data;
                
                // è®¡ç®—ä»åå¾€å‰çš„åˆ†é¡µï¼Œç¡®ä¿æœ€åä¸€é¡µæ˜¯å®Œæ•´çš„144æ¡
                const remainder = allData.length % itemsPerPage;
                if (remainder === 0) {
                    // æ•°æ®é‡æ­£å¥½æ˜¯144çš„å€æ•°
                    totalPages = allData.length / itemsPerPage;
                } else {
                    // æœ‰ä½™æ•°ï¼Œæ€»é¡µæ•°å‘ä¸Šå–æ•´
                    totalPages = Math.ceil(allData.length / itemsPerPage);
                }
                
                currentPage = totalPages; // é»˜è®¤æ˜¾ç¤ºæœ€æ–°ä¸€é¡µï¼ˆæœ€åä¸€é¡µï¼‰
                
                console.log('ğŸ“„ åˆ†é¡µä¿¡æ¯:', {
                    æ€»æ•°æ®é‡: allData.length,
                    æ¯é¡µæ¡æ•°: itemsPerPage,
                    æ€»é¡µæ•°: totalPages,
                    å½“å‰é¡µ: currentPage
                });
                
                // åŸºäºå…¨éƒ¨æ•°æ®è®¡ç®—å…¨å±€æ ‡è®°ç‚¹
                globalMarkPoints = calculateGlobalMarkPoints(allData);
                
                console.log('ğŸ“ å…¨å±€æ ‡è®°ç‚¹ï¼ˆåŸºäºå…¨éƒ¨10å¤©æ•°æ®ï¼‰:', globalMarkPoints);
                
                // æ˜¾ç¤ºç¿»é¡µæ§åˆ¶å™¨
                document.getElementById('pagination').style.display = 'flex';
                
                // æ¸²æŸ“å½“å‰é¡µ
                renderCurrentPage();
                loading.style.display = 'none';
                
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
                loading.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ä»æ•°æ®åº“æ ‡è®°ä¸­æå–å…¨å±€æ ‡è®°ç‚¹
        function calculateGlobalMarkPoints(data) {
            const markPoints = [];
            
            console.log('ğŸ“Š ä»æ•°æ®åº“è¯»å–æ ‡è®°ç‚¹...');
            
            // éå†æ‰€æœ‰æ•°æ®ï¼Œä»æ•°æ®åº“æ ‡è®°ä¸­æå–é«˜ä½ç‚¹
            for (let i = 0; i < data.length; i++) {
                const markers = data[i].markers;
                if (!markers) continue;
                
                const [open, high, low, close] = data[i].data;
                
                // 7å¤©æœ€é«˜ç‚¹
                if (markers.is_7d_high) {
                    markPoints.push({
                        name: '7Dæœ€é«˜',
                        globalIdx: i,
                        value: high,
                        itemStyle: { color: '#ff4444' }
                    });
                }
                
                // 7å¤©æœ€ä½ç‚¹
                if (markers.is_7d_low) {
                    markPoints.push({
                        name: '7Dæœ€ä½',
                        globalIdx: i,
                        value: low,
                        itemStyle: { color: '#00d4aa' }
                    });
                }
                
                // 48å°æ—¶æœ€é«˜ç‚¹
                if (markers.is_48h_high) {
                    markPoints.push({
                        name: '48Hæœ€é«˜',
                        globalIdx: i,
                        value: high,
                        itemStyle: { color: '#ff9800' }
                    });
                }
                
                // 48å°æ—¶æœ€ä½ç‚¹
                if (markers.is_48h_low) {
                    markPoints.push({
                        name: '48Hæœ€ä½',
                        globalIdx: i,
                        value: low,
                        itemStyle: { color: '#2196f3' }
                    });
                }
            }
            
            console.log('ğŸ“Œ å…¨å±€æ ‡è®°ç‚¹è¯¦æƒ…ï¼ˆæ•°æ®åº“ï¼‰:', markPoints.map(m => ({
                åç§°: m.name,
                å…¨å±€ç´¢å¼•: m.globalIdx,
                å€¼: m.value ? m.value.toFixed(4) : 'N/A'
            })));
            
            return markPoints;
        }
        
        // ä»æ•°æ®åº“æ ‡è®°ä¸­æå–çª„å¹…éœ‡è¡Kçº¿åŒºåŸŸ
        function detectNarrowRangeKlines(data, pageStartIdx, pageEndIdx) {
            const markers = [];
            
            console.log('ğŸ”¶ ä»æ•°æ®åº“è¯»å–çª„å¹…éœ‡è¡Kçº¿æ ‡è®°...');
            
            let consecutiveCount = 0;
            let consecutiveStart = -1;
            
            // éå†å½“å‰é¡µçš„æ•°æ®ï¼Œä»æ•°æ®åº“æ ‡è®°ä¸­æå–çª„å¹…éœ‡è¡åŒºåŸŸ
            for (let i = pageStartIdx; i < pageEndIdx; i++) {
                if (i >= data.length) break;
                
                const markers_db = data[i].markers;
                const isNarrowRange = markers_db && markers_db.is_narrow_range;
                
                if (isNarrowRange) {
                    if (consecutiveCount === 0) {
                        consecutiveStart = i - pageStartIdx; // è½¬æ¢ä¸ºé¡µé¢å†…ç´¢å¼•
                    }
                    consecutiveCount++;
                } else {
                    // è¿ç»­ä¸­æ–­ï¼Œå¦‚æœä¹‹å‰æœ‰è¿ç»­çš„çª„å¹…éœ‡è¡ï¼ˆâ‰¥2æ ¹ï¼‰ï¼Œæ·»åŠ æ ‡è®°
                    if (consecutiveCount >= 2) {
                        markers.push({
                            start: consecutiveStart,
                            end: consecutiveStart + consecutiveCount - 1,
                            count: consecutiveCount
                        });
                    }
                    consecutiveCount = 0;
                    consecutiveStart = -1;
                }
            }
            
            // å¤„ç†æœ€åä¸€æ®µè¿ç»­éœ‡è¡
            if (consecutiveCount >= 2) {
                markers.push({
                    start: consecutiveStart,
                    end: consecutiveStart + consecutiveCount - 1,
                    count: consecutiveCount
                });
            }
            
            console.log('ğŸ”¶ çª„å¹…éœ‡è¡Kçº¿æ£€æµ‹ï¼ˆæ•°æ®åº“ï¼‰:', markers.map(m => ({
                èµ·å§‹ç´¢å¼•: m.start,
                ç»“æŸç´¢å¼•: m.end,
                è¿ç»­æ ¹æ•°: m.count
            })));
            
            return markers;
        }
        
        // æ£€æµ‹ç»„åˆæ ‡è®°ï¼šåŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶çš„Kçº¿
        function detectComboMarks(data, pageStartIdx, pageEndIdx) {
            const comboMarks = [];
            
            console.log('ğŸ¯ æ£€æµ‹ç»„åˆæ ‡è®°ï¼ˆé«˜ä½ç‚¹ + çª„å¹…éœ‡è¡ï¼‰...');
            
            for (let i = pageStartIdx; i < pageEndIdx; i++) {
                if (i >= data.length) break;
                
                const markers = data[i].markers;
                if (!markers) continue;
                
                const [open, high, low, close] = data[i].data;
                const pageIdx = i - pageStartIdx;
                
                // ç»Ÿè®¡æ»¡è¶³çš„æ¡ä»¶
                let conditions = [];
                let isHighPoint = false;
                let isLowPoint = false;
                
                if (markers.is_7d_high) {
                    conditions.push('7å¤©æœ€é«˜');
                    isHighPoint = true;
                }
                if (markers.is_7d_low) {
                    conditions.push('7å¤©æœ€ä½');
                    isLowPoint = true;
                }
                if (markers.is_48h_high) {
                    conditions.push('48å°æ—¶æœ€é«˜');
                    isHighPoint = true;
                }
                if (markers.is_48h_low) {
                    conditions.push('48å°æ—¶æœ€ä½');
                    isLowPoint = true;
                }
                if (markers.is_narrow_range) {
                    conditions.push('çª„å¹…éœ‡è¡');
                }
                
                // å¦‚æœåŒæ—¶æ»¡è¶³â‰¥2ä¸ªæ¡ä»¶ï¼Œæ·»åŠ ç»„åˆæ ‡è®°
                if (conditions.length >= 2) {
                    const markName = conditions.join(' + ');
                    const markValue = isLowPoint ? low : (isHighPoint ? high : close);
                    
                    comboMarks.push({
                        name: markName,
                        coord: [pageIdx, markValue],
                        value: markValue,
                        conditions: conditions,
                        itemStyle: { 
                            color: '#FFD700',  // é‡‘è‰²è¡¨ç¤ºç»„åˆæ ‡è®°
                            borderColor: '#FFA500',
                            borderWidth: 2
                        },
                        symbol: 'diamond',  // è±å½¢ç¬¦å·
                        symbolSize: 20
                    });
                    
                    console.log(`  ğŸ“ ç»„åˆæ ‡è®° @ ç´¢å¼•${i}: ${markName}, å€¼=${markValue.toFixed(4)}`);
                }
            }
            
            console.log(`ğŸ¯ å…±æ£€æµ‹åˆ° ${comboMarks.length} ä¸ªç»„åˆæ ‡è®°`);
            return comboMarks;
        }
        
        // å°†å…¨å±€æ ‡è®°ç‚¹è½¬æ¢ä¸ºå½“å‰é¡µçš„åæ ‡
        function getPageMarkPoints(pageStartIdx, pageEndIdx) {
            const pageMarkPoints = [];
            
            console.log(`ğŸ” æ£€æŸ¥æ ‡è®°ç‚¹æ˜¯å¦åœ¨å½“å‰é¡µ [${pageStartIdx}, ${pageEndIdx}) èŒƒå›´å†…:`);
            
            // éå†å…¨å±€æ ‡è®°ç‚¹ï¼Œåªæ˜¾ç¤ºåœ¨å½“å‰é¡µèŒƒå›´å†…çš„
            for (const mark of globalMarkPoints) {
                const inRange = mark.globalIdx >= pageStartIdx && mark.globalIdx < pageEndIdx;
                console.log(`  - ${mark.name}: å…¨å±€ç´¢å¼•=${mark.globalIdx}, åœ¨èŒƒå›´å†…=${inRange}`);
                
                if (inRange) {
                    // è½¬æ¢ä¸ºé¡µé¢å†…çš„ç›¸å¯¹ç´¢å¼•
                    const pageIdx = mark.globalIdx - pageStartIdx;
                    pageMarkPoints.push({
                        name: mark.name,
                        coord: [pageIdx, mark.value],
                        value: mark.value,
                        itemStyle: mark.itemStyle
                    });
                }
            }
            
            console.log('ğŸ“ å½“å‰é¡µæ ‡è®°ç‚¹:', pageMarkPoints.map(m => ({
                åç§°: m.name,
                å€¼: m.value.toFixed(4),
                é¡µå†…ç´¢å¼•: m.coord[0]
            })));
            
            return pageMarkPoints;
        }
        
        // æ¸²æŸ“å½“å‰é¡µæ•°æ®ï¼ˆä»åå¾€å‰åˆ†é¡µï¼Œç¡®ä¿æœ€åä¸€é¡µå®Œæ•´ï¼‰
        function renderCurrentPage() {
            let startIdx, endIdx;
            
            if (currentPage === totalPages) {
                // æœ€åä¸€é¡µï¼šå–æœ€æ–°çš„144æ¡
                endIdx = allData.length;
                startIdx = Math.max(0, endIdx - itemsPerPage);
            } else {
                // å…¶ä»–é¡µï¼šä»åå¾€å‰è®¡ç®—
                const itemsAfter = (totalPages - currentPage) * itemsPerPage;
                endIdx = allData.length - itemsAfter;
                startIdx = Math.max(0, endIdx - itemsPerPage);
            }
            
            const pageData = allData.slice(startIdx, endIdx);
            
            console.log('ğŸ“Š æ¸²æŸ“ç¬¬', currentPage, 'é¡µï¼Œæ•°æ®èŒƒå›´:', startIdx, '-', endIdx);
            
            renderChart(pageData);
            updatePagination();
        }
        
        // æ›´æ–°ç¿»é¡µæŒ‰é’®çŠ¶æ€
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `ç¬¬${currentPage}é¡µ / å…±${totalPages}é¡µ`;
            document.getElementById('prevPageBtn').disabled = (currentPage <= 1);
            document.getElementById('nextPageBtn').disabled = (currentPage >= totalPages);
        }
        
        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
            }
        }
        
        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderCurrentPage();
            }
        }
        
        // æ¸²æŸ“å›¾è¡¨
        function renderChart(data) {
            if (!klineChart) {
                console.error('âŒ å›¾è¡¨æœªåˆå§‹åŒ–');
                return;
            }
            
            // æå–æ•°æ®
            const times = data.map(item => {
                const date = new Date(parseInt(item.timestamp));
                return date.toLocaleString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });
            
            const ohlcData = data.map(item => item.data); // [open, high, low, close]
            const volumes = data.map(item => item.volume);
            
            // æå–æŠ€æœ¯æŒ‡æ ‡æ•°æ®
            const sarData = data.map(item => {
                const markers = item.markers;
                return markers && markers.sar ? markers.sar : null;
            });
            
            const rsiData = data.map(item => {
                const markers = item.markers;
                return markers && markers.rsi_14 ? markers.rsi_14 : null;
            });
            
            const bbUpperData = data.map(item => {
                const markers = item.markers;
                return markers && markers.bb_upper ? markers.bb_upper : null;
            });
            
            const bbMiddleData = data.map(item => {
                const markers = item.markers;
                return markers && markers.bb_middle ? markers.bb_middle : null;
            });
            
            const bbLowerData = data.map(item => {
                const markers = item.markers;
                return markers && markers.bb_lower ? markers.bb_lower : null;
            });
            
            // æå–SARå¤šç©ºæ ‡ç­¾å’Œä¹°ç‚¹4æ ‡è®°
            const sarLabels = [];
            const buyPoint4Marks = [];
            
            data.forEach((item, index) => {
                const markers = item.markers;
                if (markers) {
                    // SARæ ‡ç­¾
                    if (markers.sar_count_label) {
                        sarLabels.push({
                            coord: [index, item.data[1]],  // æ˜¾ç¤ºåœ¨Kçº¿æœ€é«˜ç‚¹ä¸Šæ–¹
                            value: markers.sar_count_label,
                            position: markers.sar_position === 'bullish' ? 'top' : 'bottom'
                        });
                    }
                    
                    // ä¹°ç‚¹4æ ‡è®°
                    if (markers.is_buy_point_4) {
                        buyPoint4Marks.push({
                            name: 'ä¹°ç‚¹4',
                            coord: [index, item.data[3]],  // æ˜¾ç¤ºåœ¨æ”¶ç›˜ä»·ä½ç½®
                            value: item.data[3],
                            itemStyle: { color: '#FFD700' }  // é‡‘è‰²
                        });
                    }
                }
            });
            
            console.log('ğŸ“Š æ¸²æŸ“æ•°æ®:', {
                æ¡æ•°: data.length,
                ç¬¬ä¸€æ¡: data[0],
                æœ€åä¸€æ¡: data[data.length - 1],
                SARæ•°æ®: sarData.filter(v => v !== null).length,
                RSIæ•°æ®: rsiData.filter(v => v !== null).length,
                å¸ƒæ—å¸¦æ•°æ®: bbUpperData.filter(v => v !== null).length,
                SARæ ‡ç­¾: sarLabels.length,
                ä¹°ç‚¹4: buyPoint4Marks.length
            });
            
            // ğŸ” è¯Šæ–­OHLCæ•°æ®
            console.log('ğŸ” OHLCæ•°æ®è¯Šæ–­:', {
                ç¬¬ä¸€æ¡OHLC: ohlcData[0],
                æœ€åä¸€æ¡OHLC: ohlcData[ohlcData.length - 1],
                OHLCç¤ºä¾‹å‰3æ¡: ohlcData.slice(0, 3),
                æ•°æ®æ¥æº: 'item.dataæ•°ç»„'
            });
            
            // è·å–å½“å‰é¡µèŒƒå›´ï¼ˆä¸renderCurrentPageä¿æŒä¸€è‡´ï¼‰
            let pageStartIdx, pageEndIdx;
            
            if (currentPage === totalPages) {
                // æœ€åä¸€é¡µï¼šå–æœ€æ–°çš„144æ¡
                pageEndIdx = allData.length;
                pageStartIdx = Math.max(0, pageEndIdx - itemsPerPage);
            } else {
                // å…¶ä»–é¡µï¼šä»åå¾€å‰è®¡ç®—
                const itemsAfter = (totalPages - currentPage) * itemsPerPage;
                pageEndIdx = allData.length - itemsAfter;
                pageStartIdx = Math.max(0, pageEndIdx - itemsPerPage);
            }
            
            // è·å–å½“å‰é¡µçš„æ ‡è®°ç‚¹
            const markPoints = getPageMarkPoints(pageStartIdx, pageEndIdx);
            
            // æ£€æµ‹ç»„åˆæ ‡è®°ï¼ˆé«˜ä½ç‚¹ + çª„å¹…éœ‡è¡ï¼‰
            const comboMarks = detectComboMarks(allData, pageStartIdx, pageEndIdx);
            
            // ä»æ•°æ®åº“æ ‡è®°ä¸­æ£€æµ‹çª„å¹…éœ‡è¡Kçº¿
            const narrowRangeMarkers = detectNarrowRangeKlines(allData, pageStartIdx, pageEndIdx);
            
            // é…ç½®å›¾è¡¨
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(26, 29, 41, 0.95)',
                    borderColor: '#2d3348',
                    textStyle: { color: '#e0e0e0' },
                    formatter: function(params) {
                        if (!params || params.length === 0) return '';
                        
                        const dataIndex = params[0].dataIndex;
                        const currentData = data[dataIndex];
                        const markers = currentData.markers || {};
                        const ohlc = currentData.data;
                        
                        let html = `<div style="padding: 5px;">`;
                        html += `<div style="margin-bottom: 8px; font-weight: bold;">${params[0].axisValue}</div>`;
                        
                        // Kçº¿æ•°æ®
                        html += `<div style="color: #00d4aa;">â— Kçº¿</div>`;
                        html += `<div style="margin-left: 15px; font-size: 12px;">`;
                        html += `open: <span style="color: #fff;">${ohlc[0].toFixed(2)}</span><br>`;
                        html += `close: <span style="color: #fff;">${ohlc[3].toFixed(2)}</span><br>`;
                        html += `lowest: <span style="color: #fff;">${ohlc[2].toFixed(2)}</span><br>`;
                        html += `highest: <span style="color: #fff;">${ohlc[1].toFixed(2)}</span><br>`;
                        html += `</div>`;
                        
                        // SAR
                        html += `<div style="color: #FF6B6B; margin-top: 5px;">â— SAR</div>`;
                        html += `<div style="margin-left: 15px; font-size: 12px;">`;
                        html += markers.sar ? `${markers.sar.toFixed(4)}` : '-';
                        html += `</div>`;
                        
                        // å¸ƒæ—å¸¦
                        html += `<div style="color: #9C27B0; margin-top: 5px;">â— å¸ƒæ—å¸¦ä¸Šè½¨</div>`;
                        html += `<div style="margin-left: 15px; font-size: 12px;">`;
                        html += markers.bb_upper ? `${markers.bb_upper.toFixed(4)}` : '-';
                        html += `</div>`;
                        
                        html += `<div style="color: #2196F3; margin-top: 5px;">â— å¸ƒæ—å¸¦ä¸­è½¨</div>`;
                        html += `<div style="margin-left: 15px; font-size: 12px;">`;
                        html += markers.bb_middle ? `${markers.bb_middle.toFixed(4)}` : '-';
                        html += `</div>`;
                        
                        html += `<div style="color: #9C27B0; margin-top: 5px;">â— å¸ƒæ—å¸¦ä¸‹è½¨</div>`;
                        html += `<div style="margin-left: 15px; font-size: 12px;">`;
                        html += markers.bb_lower ? `${markers.bb_lower.toFixed(4)}` : '-';
                        html += `</div>`;
                        
                        // RSI
                        html += `<div style="color: #FFC107; margin-top: 5px;">â— RSI</div>`;
                        html += `<div style="margin-left: 15px; font-size: 12px;">`;
                        html += markers.rsi_14 ? `${markers.rsi_14.toFixed(2)}` : '-';
                        html += `</div>`;
                        
                        // æˆäº¤é‡
                        const volumeParam = params.find(p => p.seriesName === 'æˆäº¤é‡');
                        if (volumeParam) {
                            html += `<div style="color: #888; margin-top: 5px;">â— æˆäº¤é‡</div>`;
                            html += `<div style="margin-left: 15px; font-size: 12px;">`;
                            html += `${volumeParam.value.toFixed(2)}`;
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                        return html;
                    }
                },
                legend: {
                    data: ['Kçº¿', 'SAR', 'å¸ƒæ—ä¸Šè½¨', 'å¸ƒæ—ä¸­è½¨', 'å¸ƒæ—ä¸‹è½¨', 'æˆäº¤é‡', 'RSI'],
                    textStyle: { color: '#888' },
                    top: '1%'
                },
                grid: [
                    { left: '5%', right: '3%', top: '10%', height: '50%' },  // Kçº¿ä¸»å›¾
                    { left: '5%', right: '3%', top: '65%', height: '13%' },   // æˆäº¤é‡
                    { left: '5%', right: '3%', top: '82%', height: '13%' }    // RSI
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: times,
                        gridIndex: 0,
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { show: false }
                    },
                    {
                        type: 'category',
                        data: times,
                        gridIndex: 1,
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { show: false }
                    },
                    {
                        type: 'category',
                        data: times,
                        gridIndex: 2,
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { 
                            color: '#888',
                            rotate: 0,
                            interval: 'auto',
                            formatter: function(value, index) {
                                return index % 24 === 0 ? value : '';
                            }
                        }
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        gridIndex: 0,
                        scale: true,
                        splitLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { color: '#888' }
                    },
                    {
                        type: 'value',
                        gridIndex: 1,
                        splitLine: { show: false },
                        axisLabel: { color: '#888' }
                    },
                    {
                        type: 'value',
                        gridIndex: 2,
                        min: 0,
                        max: 100,
                        splitLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { color: '#888' }
                    }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: ohlcData,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#00d4aa',
                            color0: '#ff4444',
                            borderColor: '#00d4aa',
                            borderColor0: '#ff4444'
                        },
                        markPoint: {
                            data: [...markPoints, ...buyPoint4Marks, ...comboMarks],
                            label: {
                                formatter: function(param) {
                                    return param.name + '\n' + param.value.toFixed(4);
                                },
                                fontSize: 11
                            }
                        },
                        markArea: {
                            silent: true,
                            data: narrowRangeMarkers.map(marker => {
                                return [
                                    {
                                        name: `éœ‡è¡${marker.count}æ ¹`,
                                        xAxis: marker.start,
                                        itemStyle: {
                                            color: 'rgba(255, 165, 0, 0.15)'
                                        },
                                        label: {
                                            show: true,
                                            position: 'top',
                                            formatter: `éœ‡è¡${marker.count}æ ¹`,
                                            fontSize: 10,
                                            color: '#ff9800'
                                        }
                                    },
                                    {
                                        xAxis: marker.end
                                    }
                                ];
                            })
                        }
                    },
                    {
                        name: 'SAR',
                        type: 'scatter',
                        data: sarData,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        symbol: 'circle',
                        symbolSize: 4,
                        itemStyle: {
                            color: '#FF6B6B'
                        }
                    },
                    {
                        name: 'å¸ƒæ—ä¸Šè½¨',
                        type: 'line',
                        data: bbUpperData,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 1,
                            type: 'dashed'
                        },
                        symbol: 'none'
                    },
                    {
                        name: 'å¸ƒæ—ä¸­è½¨',
                        type: 'line',
                        data: bbMiddleData,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        lineStyle: {
                            color: '#2196F3',
                            width: 1
                        },
                        symbol: 'none'
                    },
                    {
                        name: 'å¸ƒæ—ä¸‹è½¨',
                        type: 'line',
                        data: bbLowerData,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 1,
                            type: 'dashed'
                        },
                        symbol: 'none'
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        data: volumes,
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                if (dataIndex === 0) return 'rgba(0, 212, 170, 0.5)';
                                const current = ohlcData[dataIndex];
                                const prev = ohlcData[dataIndex - 1];
                                const isUp = current[3] >= prev[3];
                                return isUp ? 'rgba(0, 212, 170, 0.5)' : 'rgba(255, 68, 68, 0.5)';
                            }
                        }
                    },
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData,
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        lineStyle: {
                            color: '#FFC107',
                            width: 2
                        },
                        symbol: 'none',
                        markLine: {
                            silent: true,
                            data: [
                                { yAxis: 70, lineStyle: { color: '#ff4444', type: 'dashed' } },
                                { yAxis: 30, lineStyle: { color: '#00d4aa', type: 'dashed' } }
                            ]
                        }
                    }
                ]
            };
            
            klineChart.setOption(option);
            
            // Show indicator panel for the latest candle
            // Show indicator panel for the latest candle in current view
            if (data && data.length > 0) {
                updateIndicatorPanel(data.length - 1, data);
            }

            console.log('âœ… å›¾è¡¨æ¸²æŸ“æˆåŠŸ');
        }
        
        // åˆ‡æ¢æ—¶é—´å‘¨æœŸ
        function switchTimeframe(timeframe) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadData(timeframe);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            
            setTimeout(function() {
                if (initChart()) {
                    loadData('5m');
                } else {
                    document.getElementById('loading').innerHTML = '<div class="error">å›¾è¡¨åˆå§‹åŒ–å¤±è´¥</div>';
                }
            }, 300);
        });
    
        
        // Update indicator data panel
        function updateIndicatorPanel(dataIndex, dataArray) {
            const indicatorPanel = document.getElementById('indicator-panel');
            const indicatorData = document.getElementById('indicator-data');
            
            if (!dataArray || dataIndex >= dataArray.length) {
                indicatorPanel.style.display = 'none';
                return;
            }
            
            const currentData = dataArray[dataIndex];
            const markers = currentData.markers || {};
            const ohlc = currentData.data;
            
            // Format timestamp
            const date = new Date(parseInt(currentData.timestamp));
            const timeStr = date.toLocaleString('zh-CN', { 
                timeZone: 'Asia/Shanghai',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Build HTML for indicator cards
            let html = `
                <div class="indicator-card">
                    <h4>ğŸ• æ—¶é—´</h4>
                    <div class="value">${timeStr}</div>
                </div>
                
                <div class="indicator-card">
                    <h4>ğŸ“ˆ Kçº¿</h4>
                    <div class="value">${ohlc[3].toFixed(2)}</div>
                    <div class="label">å¼€: ${ohlc[0].toFixed(2)} | é«˜: ${ohlc[1].toFixed(2)}<br>ä½: ${ohlc[2].toFixed(2)} | æ”¶: ${ohlc[3].toFixed(2)}</div>
                </div>
                
                <div class="indicator-card ${markers.sar_position === 'bullish' ? 'bullish' : 'bearish'}">
                    <h4>ğŸ¯ SAR</h4>
                    <div class="value">${markers.sar ? markers.sar.toFixed(4) : '-'}</div>
                    <div class="label">
                        æŒä»“: ${markers.sar_position === 'bullish' ? 'å¤šå¤´ (bullish)' : markers.sar_position === 'bearish' ? 'ç©ºå¤´ (bearish)' : '-'}<br>
                        æ ‡ç­¾: ${markers.sar_count_label || '-'}
                    </div>
                </div>
                
                <div class="indicator-card">
                    <h4>ğŸ“Š RSI (14)</h4>
                    <div class="value">${markers.rsi_14 ? markers.rsi_14.toFixed(2) : '-'}</div>
                    <div class="label">
                        ${markers.rsi_14 ? (markers.rsi_14 > 70 ? 'è¶…ä¹°åŒº' : markers.rsi_14 < 30 ? 'è¶…å–åŒº' : 'æ­£å¸¸åŒº') : '-'}
                    </div>
                </div>
                
                <div class="indicator-card">
                    <h4>ğŸ“‰ å¸ƒæ—å¸¦</h4>
                    <div class="value">${markers.bb_middle ? markers.bb_middle.toFixed(2) : '-'}</div>
                    <div class="label">
                        ä¸Šè½¨: ${markers.bb_upper ? markers.bb_upper.toFixed(2) : '-'}<br>
                        ä¸‹è½¨: ${markers.bb_lower ? markers.bb_lower.toFixed(2) : '-'}
                    </div>
                </div>
                
                <div class="indicator-card">
                    <h4>ğŸ¨ è±¡é™</h4>
                    <div class="value">${markers.sar_quadrant || '-'}</div>
                    <div class="label">SARè±¡é™ä½ç½®</div>
                </div>
            `;
            
            // Add buy point 4 indicator if present
            if (markers.is_buy_point_4) {
                html += `
                <div class="indicator-card bullish">
                    <h4>â­ ä¹°ç‚¹4</h4>
                    <div class="value">âœ“ æ£€æµ‹åˆ°</div>
                    <div class="label">æ»¡è¶³ä¹°ç‚¹4æ¡ä»¶</div>
                </div>
                `;
            }
            
            // Add combo marks indicator (high/low + narrow range)
            const comboConditions = [];
            if (markers.is_7d_high) comboConditions.push('7å¤©æœ€é«˜');
            if (markers.is_7d_low) comboConditions.push('7å¤©æœ€ä½');
            if (markers.is_48h_high) comboConditions.push('48å°æ—¶æœ€é«˜');
            if (markers.is_48h_low) comboConditions.push('48å°æ—¶æœ€ä½');
            if (markers.is_narrow_range) comboConditions.push('çª„å¹…éœ‡è¡');
            
            if (comboConditions.length >= 2) {
                const comboLabel = comboConditions.join(' + ');
                html += `
                <div class="indicator-card" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000;">
                    <h4>ğŸ’ ç»„åˆæ ‡è®°</h4>
                    <div class="value">${comboConditions.length} ä¸ªæ¡ä»¶</div>
                    <div class="label" style="color: #333;">${comboLabel}</div>
                </div>
                `;
            }
            
            // Add narrow range details
            if (markers.is_narrow_range) {
                const changePercent = markers.change_percent ? markers.change_percent.toFixed(3) : '-';
                const rangePercent = markers.range_percent ? markers.range_percent.toFixed(3) : '-';
                const consecutive = markers.consecutive_count || 0;
                
                html += `
                <div class="indicator-card" style="border: 2px solid #FFA500;">
                    <h4>ğŸ”¶ çª„å¹…éœ‡è¡</h4>
                    <div class="value">è¿ç»­ ${consecutive} æ ¹</div>
                    <div class="label">
                        æ¶¨è·Œ: ${changePercent}%<br>
                        éœ‡è¡: ${rangePercent}%
                    </div>
                </div>
                `;
            }
            
            indicatorData.innerHTML = html;
            indicatorPanel.style.display = 'block';
        }
</script>
</body>
</html>
