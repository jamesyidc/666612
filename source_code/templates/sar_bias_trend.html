<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARåå‘è¶‹åŠ¿å›¾ - 12å°æ—¶åˆ†é¡µ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #1e2139;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 28px;
            color: #00d4ff;
        }
        
        .back-btn {
            background: rgba(59, 125, 255, 0.2);
            border: 1px solid rgba(59, 125, 255, 0.4);
            color: #00d4ff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(59, 125, 255, 0.3);
            border-color: rgba(59, 125, 255, 0.6);
        }
        
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(42, 45, 71, 0.8);
            border: 1px solid rgba(59, 125, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
        }
        
        .page-btn {
            background: rgba(59, 125, 255, 0.2);
            border: 1px solid rgba(59, 125, 255, 0.4);
            color: #00d4ff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        .page-btn:hover:not(:disabled) {
            background: rgba(59, 125, 255, 0.3);
            border-color: rgba(59, 125, 255, 0.6);
        }
        
        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .page-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .page-number {
            font-size: 20px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .page-time-range {
            font-size: 12px;
            color: #8b92b8;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(42, 45, 71, 0.8);
            border: 1px solid rgba(59, 125, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #8b92b8;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-value.bullish {
            color: #26d639;
        }
        
        .stat-value.bearish {
            color: #ff4757;
        }
        
        .stat-trend {
            font-size: 12px;
            color: #8b92b8;
            margin-top: 5px;
        }
        
        .chart-container {
            background: rgba(42, 45, 71, 0.8);
            border: 1px solid rgba(59, 125, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 18px;
            color: #00d4ff;
            margin-bottom: 15px;
        }
        
        #trendChart {
            width: 100%;
            height: 500px;
        }
        
        .symbol-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .symbol-list {
            background: rgba(42, 45, 71, 0.8);
            border: 1px solid rgba(59, 125, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
        }
        
        .list-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .list-title.bullish {
            color: #26d639;
        }
        
        .list-title.bearish {
            color: #ff4757;
        }
        
        .symbol-item {
            background: rgba(30, 33, 57, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .symbol-name {
            font-weight: bold;
            color: #00d4ff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b92b8;
        }
        
        .update-info {
            text-align: center;
            color: #8b92b8;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .timezone-badge {
            display: inline-block;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.4);
            color: #00d4ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                SARåå‘è¶‹åŠ¿å›¾ - 12å°æ—¶åˆ†é¡µ
                <span class="timezone-badge">ğŸ• åŒ—äº¬æ—¶é—´ (UTC+8)</span>
            </h1>
            <a href="/sar-slope" class="back-btn">â† è¿”å›åˆ—è¡¨</a>
        </div>
        
        <div class="pagination-container">
            <button class="page-btn" id="prevBtn" onclick="previousPage()">
                â† ä¸Šä¸€é¡µ (æ›´æ—©)
            </button>
            
            <div class="page-info">
                <div class="page-number">
                    ç¬¬ <span id="currentPage">1</span> é¡µ / å…± <span id="totalPages">1</span> é¡µ
                </div>
                <div class="page-time-range" id="timeRangeDisplay">
                    åŠ è½½ä¸­...
                </div>
            </div>
            
            <button class="page-btn" id="nextBtn" onclick="nextPage()">
                ä¸‹ä¸€é¡µ (æ›´æ–°) â†’
            </button>
        </div>
        
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-label">å½“å‰åå¤šå¸ç§ (>80%)</div>
                <div class="stat-value bullish" id="currentBullish">-</div>
                <div class="stat-trend" id="bullishTrend">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">å½“å‰åç©ºå¸ç§ (>80%)</div>
                <div class="stat-value bearish" id="currentBearish">-</div>
                <div class="stat-trend" id="bearishTrend">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">æ€»ç›‘æ§å¸ç§</div>
                <div class="stat-value" id="totalSymbols">27</div>
                <div class="stat-trend">å®æ—¶æ›´æ–°ä¸­</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
                <div class="stat-value" id="dataPoints">-</div>
                <div class="stat-trend" id="timeRange">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">ğŸ“Š åå¤š/åç©ºæ•°é‡è¶‹åŠ¿ (æœ¬é¡µ12å°æ—¶)</div>
            <div id="trendChart"></div>
        </div>
        
        <div class="symbol-lists">
            <div class="symbol-list">
                <div class="list-title bullish">
                    â¬†ï¸ å½“å‰åå¤šå¸ç§ (>80%)
                </div>
                <div id="bullishList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <div class="symbol-list">
                <div class="list-title bearish">
                    â¬‡ï¸ å½“å‰åç©ºå¸ç§ (>80%)
                </div>
                <div id="bearishList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="update-info">
            æœ€åæ›´æ–°: <span id="lastUpdate">-</span> (åŒ—äº¬æ—¶é—´) | 
            æ•°æ®æ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼Œæ¯é¡µæ˜¾ç¤º12å°æ—¶æ•°æ®
        </div>
    </div>
    
    <script>
        let chart = null;
        let currentPage = 1;
        let totalPages = 1;
        let updateInterval = null;
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('trendChart');
            chart = echarts.init(chartDom);
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(30, 33, 57, 0.9)',
                    borderColor: 'rgba(59, 125, 255, 0.4)',
                    textStyle: {
                        color: '#fff'
                    },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(item => {
                            const color = item.seriesName.includes('åå¤š') ? '#26d639' : '#ff4757';
                            result += `<span style="color:${color}">â— ${item.seriesName}: ${item.value}</span><br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['åå¤šå¸ç§ (>80%)', 'åç©ºå¸ç§ (>80%)'],
                    textStyle: {
                        color: '#8b92b8'
                    },
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: [],
                    axisLabel: {
                        color: '#8b92b8',
                        rotate: 45
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(59, 125, 255, 0.3)'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å¸ç§æ•°é‡',
                    nameTextStyle: {
                        color: '#8b92b8'
                    },
                    axisLabel: {
                        color: '#8b92b8'
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(59, 125, 255, 0.3)'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(59, 125, 255, 0.1)'
                        }
                    }
                },
                series: [
                    {
                        name: 'åå¤šå¸ç§ (>80%)',
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: {
                            color: '#26d639',
                            width: 2
                        },
                        itemStyle: {
                            color: '#26d639'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(38, 214, 57, 0.3)' },
                                    { offset: 1, color: 'rgba(38, 214, 57, 0.05)' }
                                ]
                            }
                        },
                        data: []
                    },
                    {
                        name: 'åç©ºå¸ç§ (>80%)',
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: {
                            color: '#ff4757',
                            width: 2
                        },
                        itemStyle: {
                            color: '#ff4757'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(255, 71, 87, 0.3)' },
                                    { offset: 1, color: 'rgba(255, 71, 87, 0.05)' }
                                ]
                            }
                        },
                        data: []
                    }
                ]
            };
            
            chart.setOption(option);
            
            // å“åº”å¼
            window.addEventListener('resize', () => {
                chart.resize();
            });
        }
        
        // åŠ è½½è¶‹åŠ¿æ•°æ®
        async function loadTrendData(page = 1) {
            try {
                const response = await fetch(`/api/sar-slope/bias-trend?page=${page}`);
                const data = await response.json();
                
                if (data.success) {
                    currentPage = data.page;
                    totalPages = data.total_pages;
                    
                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    document.getElementById('currentPage').textContent = currentPage;
                    document.getElementById('totalPages').textContent = totalPages;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('prevBtn').disabled = !data.has_prev;
                    document.getElementById('nextBtn').disabled = !data.has_next;
                    
                    // æ›´æ–°æ—¶é—´èŒƒå›´æ˜¾ç¤º
                    if (data.time_range.start && data.time_range.end) {
                        document.getElementById('timeRangeDisplay').textContent = 
                            `${data.time_range.start} ~ ${data.time_range.end}`;
                    }
                    
                    if (data.data.length > 0) {
                        // å‡†å¤‡å›¾è¡¨æ•°æ®
                        const times = [];
                        const bullishData = [];
                        const bearishData = [];
                        
                        data.data.forEach(item => {
                            // ä½¿ç”¨å®Œæ•´æ—¶é—´ (åŒ—äº¬æ—¶é—´å·²åœ¨åç«¯å¤„ç†)
                            times.push(item.timestamp);
                            bullishData.push(item.bullish_count);
                            bearishData.push(item.bearish_count);
                        });
                        
                        // æ›´æ–°å›¾è¡¨
                        chart.setOption({
                            xAxis: {
                                data: times
                            },
                            series: [
                                { data: bullishData },
                                { data: bearishData }
                            ]
                        });
                        
                        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                        const latest = data.data[data.data.length - 1];
                        document.getElementById('currentBullish').textContent = latest.bullish_count;
                        document.getElementById('currentBearish').textContent = latest.bearish_count;
                        document.getElementById('dataPoints').textContent = data.data.length;
                        
                        // è®¡ç®—è¶‹åŠ¿
                        if (data.data.length >= 2) {
                            const prev = data.data[data.data.length - 2];
                            const bullishChange = latest.bullish_count - prev.bullish_count;
                            const bearishChange = latest.bearish_count - prev.bearish_count;
                            
                            document.getElementById('bullishTrend').textContent = 
                                bullishChange > 0 ? `â†‘ +${bullishChange}` : 
                                bullishChange < 0 ? `â†“ ${bullishChange}` : 'â†’ æŒå¹³';
                            
                            document.getElementById('bearishTrend').textContent = 
                                bearishChange > 0 ? `â†‘ +${bearishChange}` : 
                                bearishChange < 0 ? `â†“ ${bearishChange}` : 'â†’ æŒå¹³';
                        }
                        
                        // æ—¶é—´èŒƒå›´
                        const startTime = data.data[0].timestamp;
                        const endTime = latest.timestamp;
                        document.getElementById('timeRange').textContent = 
                            `${startTime.substring(5)} - ${endTime.substring(5)}`;
                        
                        // æ›´æ–°å¸ç§åˆ—è¡¨
                        updateSymbolLists(latest.bullish_symbols, latest.bearish_symbols);
                        
                        // æ›´æ–°æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
                        const now = new Date();
                        const beijingTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
                        document.getElementById('lastUpdate').textContent = 
                            beijingTime.toISOString().substring(0, 19).replace('T', ' ');
                        
                        console.log(`âœ… æ•°æ®å·²æ›´æ–°: ç¬¬${currentPage}é¡µ, ${data.data.length} ä¸ªæ•°æ®ç‚¹`);
                    } else {
                        console.log('âš ï¸  æœ¬é¡µæš‚æ— æ•°æ®');
                        // æ¸…ç©ºå›¾è¡¨
                        chart.setOption({
                            xAxis: { data: [] },
                            series: [{ data: [] }, { data: [] }]
                        });
                    }
                } else {
                    console.error('âŒ APIè¿”å›é”™è¯¯:', data.error);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å¸ç§åˆ—è¡¨
        function updateSymbolLists(bullishSymbols, bearishSymbols) {
            // åå¤šåˆ—è¡¨
            const bullishList = document.getElementById('bullishList');
            if (bullishSymbols && bullishSymbols.length > 0) {
                bullishList.innerHTML = bullishSymbols.map(symbol => `
                    <div class="symbol-item">
                        <span class="symbol-name">${symbol}</span>
                        <span style="color: #26d639;">â¬†ï¸</span>
                    </div>
                `).join('');
            } else {
                bullishList.innerHTML = '<div class="loading">æš‚æ— å¸ç§</div>';
            }
            
            // åç©ºåˆ—è¡¨
            const bearishList = document.getElementById('bearishList');
            if (bearishSymbols && bearishSymbols.length > 0) {
                bearishList.innerHTML = bearishSymbols.map(symbol => `
                    <div class="symbol-item">
                        <span class="symbol-name">${symbol}</span>
                        <span style="color: #ff4757;">â¬‡ï¸</span>
                    </div>
                `).join('');
            } else {
                bearishList.innerHTML = '<div class="loading">æš‚æ— å¸ç§</div>';
            }
        }
        
        // ä¸Šä¸€é¡µ (æ›´æ—©çš„æ•°æ®)
        function previousPage() {
            if (currentPage < totalPages) {
                // åœæ­¢è‡ªåŠ¨æ›´æ–°
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
                loadTrendData(currentPage + 1);
            }
        }
        
        // ä¸‹ä¸€é¡µ (æ›´æ–°çš„æ•°æ®)
        function nextPage() {
            if (currentPage > 1) {
                loadTrendData(currentPage - 1);
                
                // å¦‚æœå›åˆ°ç¬¬1é¡µï¼Œé‡æ–°å¼€å¯è‡ªåŠ¨æ›´æ–°
                if (currentPage - 1 === 1 && !updateInterval) {
                    updateInterval = setInterval(() => loadTrendData(1), 30000);
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“Š SARåå‘è¶‹åŠ¿å›¾åŠ è½½ä¸­...');
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // é¦–æ¬¡åŠ è½½æ•°æ®ï¼ˆç¬¬1é¡µ = æœ€æ–°æ•°æ®ï¼‰
            loadTrendData(1);
            
            // åªåœ¨ç¬¬1é¡µæ—¶è‡ªåŠ¨æ›´æ–°
            updateInterval = setInterval(() => {
                if (currentPage === 1) {
                    loadTrendData(1);
                }
            }, 30000);
            
            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œç¬¬1é¡µæ¯30ç§’è‡ªåŠ¨æ›´æ–°');
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (chart) {
                chart.dispose();
            }
        });
    </script>
</body>
</html>
