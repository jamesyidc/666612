<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”šç‚¹å•è‡ªåŠ¨å¼€ä»“ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: rgba(255,255,255,0.8);
        }
        
        .control-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2563eb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-label {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4ade80;
        }
        
        .section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .section h2 {
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        th {
            background: rgba(255,255,255,0.15);
            font-weight: bold;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-created { background: #10b981; color: white; }
        .badge-monitored { background: #3b82f6; color: white; }
        .badge-skipped { background: #6b7280; color: white; }
        .badge-failed { background: #ef4444; color: white; }
        .badge-new { background: #8b5cf6; color: white; }
        .badge-maintain { background: #f59e0b; color: white; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.7);
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.5);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #4ade80;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        .signal-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #8b5cf6;
        }
        
        .signal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .signal-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }
        
        .auto-scan-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 15px;
        }
        
        .status-running {
            background: #10b981;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .status-stopped {
            background: #6b7280;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš“ é”šç‚¹å•è‡ªåŠ¨å¼€ä»“ç›‘æ§</h1>
        <p class="subtitle">å®æ—¶ç›‘æ§é€ƒé¡¶ä¿¡å·ï¼Œè‡ªåŠ¨åˆ›å»ºå’Œç»´æŠ¤é”šç‚¹å•</p>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <button class="btn btn-primary" onclick="manualScan()">ğŸ” æ‰‹åŠ¨æ‰«æ</button>
            <button class="btn btn-secondary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn btn-secondary" onclick="window.location.href='/trading-manager'">âš™ï¸ äº¤æ˜“é…ç½®</button>
            <span id="scan-status" class="auto-scan-status status-stopped">â¸ï¸ æ‰‹åŠ¨æ¨¡å¼</span>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">é€ƒé¡¶ä¿¡å·æ•°</div>
                <div class="stat-value" id="signal-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥åˆ›å»º</div>
                <div class="stat-value" id="today-created">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥ç›‘æ§</div>
                <div class="stat-value" id="today-monitored">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ´»è·ƒé”šç‚¹å•</div>
                <div class="stat-value" id="active-anchors">-</div>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message"></div>
        
        <!-- å½“å‰é€ƒé¡¶ä¿¡å· -->
        <div class="section">
            <h2>ğŸ“Š å½“å‰é€ƒé¡¶ä¿¡å·</h2>
            <div id="current-signals" class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- è§¦å‘å†å² -->
        <div class="section">
            <h2>ğŸ“œ è§¦å‘å†å²è®°å½•ï¼ˆæœ€è¿‘20æ¡ï¼‰</h2>
            <div id="trigger-history" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let refreshInterval = null;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = () => {
            refreshData();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            refreshInterval = setInterval(refreshData, 30000);
        };
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshData() {
            await loadSignals();
            await loadHistory();
            await loadStats();
        }
        
        // åŠ è½½é€ƒé¡¶ä¿¡å·
        async function loadSignals() {
            try {
                const response = await fetch('/api/trading/anchor/signals');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('signal-count').textContent = data.count;
                    displaySignals(data.signals);
                } else {
                    showError('åŠ è½½ä¿¡å·å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('åŠ è½½ä¿¡å·å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºä¿¡å·åˆ—è¡¨
        function displaySignals(signals) {
            const container = document.getElementById('current-signals');
            
            if (!signals || signals.length === 0) {
                container.innerHTML = '<div class="empty">ğŸ“­ æš‚æ— é€ƒé¡¶ä¿¡å·</div>';
                return;
            }
            
            let html = '';
            for (const signal of signals) {
                html += `
                    <div class="signal-item">
                        <div class="signal-header">
                            ${signal.inst_id}
                            <button class="btn btn-secondary" style="float:right; padding:5px 15px; font-size:12px;" 
                                    onclick="checkAnchorStatus('${signal.inst_id}')">
                                æ£€æŸ¥çŠ¶æ€
                            </button>
                        </div>
                        <div class="signal-details">
                            <div>ğŸ’° å½“å‰ä»·: ${signal.current_price.toFixed(4)}</div>
                            <div>ğŸ“ å‹åŠ›çº¿1: ${signal.pressure1.toFixed(4)} (${signal.distance_to_resistance_1.toFixed(2)}%)</div>
                            <div>ğŸ“ å‹åŠ›çº¿2: ${signal.pressure2.toFixed(4)} (${signal.distance_to_resistance_2.toFixed(2)}%)</div>
                            <div>ğŸ“Š 7æ—¥ä½ç½®: ${signal.position_7d.toFixed(1)}%</div>
                            <div>ğŸ“Š 48hä½ç½®: ${signal.position_48h.toFixed(1)}%</div>
                            <div>â° æ—¶é—´: ${signal.timestamp}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // åŠ è½½è§¦å‘å†å²
        async function loadHistory() {
            try {
                const response = await fetch('/api/trading/anchor/trigger-history?limit=20');
                const data = await response.json();
                
                if (data.success) {
                    displayHistory(data.history);
                } else {
                    document.getElementById('trigger-history').innerHTML = 
                        '<div class="empty">åŠ è½½å¤±è´¥: ' + data.error + '</div>';
                }
            } catch (error) {
                document.getElementById('trigger-history').innerHTML = 
                    '<div class="empty">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistory(history) {
            const container = document.getElementById('trigger-history');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty">ğŸ“­ æš‚æ— è§¦å‘è®°å½•</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>å¸ç§</th>
                            <th>ç±»å‹</th>
                            <th>å·²æœ‰é”šç‚¹å•</th>
                            <th>å‹åŠ›çº¿1</th>
                            <th>å‹åŠ›çº¿2</th>
                            <th>å½“å‰ä»·</th>
                            <th>å¼€ä»“é‡‘é¢</th>
                            <th>æ‰§è¡ŒåŠ¨ä½œ</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const record of history) {
                const actionBadge = getActionBadge(record.action_taken);
                const typeBadge = record.trigger_type === 'new' ? 
                    '<span class="badge badge-new">æ–°å»º</span>' : 
                    '<span class="badge badge-maintain">ç»´æŠ¤</span>';
                
                html += `
                    <tr>
                        <td>${record.timestamp}</td>
                        <td><strong>${record.inst_id}</strong></td>
                        <td>${typeBadge}</td>
                        <td>${record.has_existing_anchor ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                        <td>${record.pressure1.toFixed(4)}</td>
                        <td>${record.pressure2.toFixed(4)}</td>
                        <td>${record.current_price.toFixed(4)}</td>
                        <td>${record.open_amount ? record.open_amount.toFixed(2) + ' USDT' : '-'}</td>
                        <td>${actionBadge}</td>
                        <td style="font-size:12px;">${record.skip_reason || '-'}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // è·å–åŠ¨ä½œå¾½ç« 
        function getActionBadge(action) {
            const badges = {
                'created': '<span class="badge badge-created">âœ… å·²åˆ›å»º</span>',
                'monitored': '<span class="badge badge-monitored">ğŸ‘ï¸ ç›‘æ§</span>',
                'skipped': '<span class="badge badge-skipped">â­ï¸ è·³è¿‡</span>',
                'failed': '<span class="badge badge-failed">âŒ å¤±è´¥</span>'
            };
            return badges[action] || action;
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç»Ÿè®¡APIè°ƒç”¨
            // æš‚æ—¶ç”¨è§¦å‘å†å²æ¥è®¡ç®—ç»Ÿè®¡
            try {
                const response = await fetch('/api/trading/anchor/trigger-history?limit=100');
                const data = await response.json();
                
                if (data.success) {
                    const history = data.history;
                    const today = new Date().toISOString().split('T')[0];
                    
                    const todayRecords = history.filter(r => 
                        r.timestamp && r.timestamp.startsWith(today)
                    );
                    
                    const created = todayRecords.filter(r => r.action_taken === 'created').length;
                    const monitored = todayRecords.filter(r => r.action_taken === 'monitored').length;
                    
                    document.getElementById('today-created').textContent = created;
                    document.getElementById('today-monitored').textContent = monitored;
                }
                
                // è·å–æ´»è·ƒé”šç‚¹å•æ•°é‡
                const anchorsResponse = await fetch('/api/trading/positions/opens?is_anchor=1&limit=100');
                const anchorsData = await anchorsResponse.json();
                if (anchorsData.success) {
                    document.getElementById('active-anchors').textContent = anchorsData.total;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // æ‰‹åŠ¨æ‰«æ
        async function manualScan() {
            showMessage('ğŸ” å¼€å§‹æ‰«æ...', 'info');
            
            try {
                const response = await fetch('/api/trading/anchor/auto-scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(
                        `âœ… æ‰«æå®Œæˆ: ${data.summary}`,
                        'success'
                    );
                    
                    // åˆ·æ–°æ•°æ®
                    setTimeout(refreshData, 1000);
                } else {
                    showError('æ‰«æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('æ‰«æå¤±è´¥: ' + error.message);
            }
        }
        
        // æ£€æŸ¥é”šç‚¹å•çŠ¶æ€
        async function checkAnchorStatus(instId) {
            try {
                const response = await fetch(`/api/trading/anchor/check-existing?inst_id=${instId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.has_anchor) {
                        const info = data.anchor_info;
                        alert(`${instId} å·²æœ‰é”šç‚¹å•:\n` +
                              `å¼€ä»“ä»·: ${info.open_price}\n` +
                              `é‡‘é¢: ${info.open_size} USDT\n` +
                              `æ—¶é—´: ${info.timestamp}`);
                    } else {
                        alert(`${instId} æ²¡æœ‰é”šç‚¹å•\nå¯ä»¥æ–°å»ºé”šç‚¹å•`);
                    }
                } else {
                    alert('æ£€æŸ¥å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg, type = 'info') {
            const msgDiv = document.getElementById('message');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            msgDiv.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`;
            
            setTimeout(() => {
                msgDiv.innerHTML = '';
            }, 5000);
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(msg) {
            showMessage('âŒ ' + msg, 'error');
        }
    </script>
</body>
</html>
