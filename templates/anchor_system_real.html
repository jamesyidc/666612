<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ç¦ç”¨ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2.0.2026-01-02-extreme-margin-fix -->
    <title>ğŸ”´ å®ç›˜é”šç‚¹ç³»ç»Ÿ - OKExæŒä»“ç›‘æ§ v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-subvalue {
            font-size: 14px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 350px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-profit {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-loss {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-short {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-long {
            background: #bee3f8;
            color: #2c5282;
        }

        .badge-sent {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-pending {
            background: #e2e8f0;
            color: #4a5568;
        }

        .badge-normal {
            background: #e6fffa;
            color: #234e52;
        }

        .alert-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .alert-item.profit {
            border-left-color: #48bb78;
        }

        .alert-item.loss {
            border-left-color: #f56565;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .alert-title {
            font-weight: 600;
            color: #2d3748;
        }

        .alert-time {
            color: #a0aec0;
            font-size: 12px;
        }

        .alert-details {
            font-size: 13px;
            color: #4a5568;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        /* é¢„è­¦æ ·å¼ */
        .warning-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .warning-badge.critical {
            background: #fed7d7;
            color: #c53030;
        }

        .warning-badge.warning {
            background: #feebc8;
            color: #dd6b20;
        }

        .warning-badge.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .profit-rate.warning-level {
            color: #dd6b20;
            font-weight: 600;
        }

        .profit-rate.critical-level {
            color: #c53030;
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- ç‰ˆæœ¬æ£€æµ‹æ ‡è®° -->
        <div id="page-version" data-version="2025-12-29-v2" style="display: none;"></div>
        
        <div class="header">
            <h1>
                <span>ğŸ”´</span>
                å®ç›˜é”šç‚¹ç³»ç»Ÿ
            </h1>
            <div class="subtitle">
                <span>OKExå®ç›˜æŒä»“ç›‘æ§ï¼ˆReal Tradingï¼‰</span>
                <span>â€¢</span>
                <span id="updateTime">--</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>ğŸ”„</span>
                    åˆ·æ–°æ•°æ®
                </button>
                <a href="/" class="btn btn-secondary" style="text-decoration: none;">
                    <span>ğŸ </span>
                    è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-label">æ€»ç›‘æ§æ¬¡æ•°</div>
                <div class="stat-value" id="totalMonitors">--</div>
                <div class="stat-subvalue">ç´¯è®¡æ£€æµ‹è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ””</div>
                <div class="stat-label">å‘Šè­¦è§¦å‘æ¬¡æ•°</div>
                <div class="stat-value" id="totalAlerts">--</div>
                <div class="stat-subvalue">ç›ˆåˆ© + æ­¢æŸæé†’</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-label">å»ºä»“å¤šå•é¢„è­¦</div>
                <div class="stat-value" id="profitTarget">--</div>
                <div class="stat-subvalue">åšç©ºç›ˆåˆ©è¾¾æ ‡æé†’</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-label">å»ºä»“ç©ºå•é¢„è­¦</div>
                <div class="stat-value" id="lossLimit">--</div>
                <div class="stat-subvalue">åšç©ºäºæŸè§¦å‘æé†’</div>
            </div>
            <div class="stat-card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <div class="stat-icon">ğŸ”¢</div>
                <div class="stat-label" style="color: #92400e;">å½“å‰è®¡æ¬¡</div>
                <div class="stat-value" id="currentCount" style="color: #b45309; font-size: 48px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #92400e;">æœ€æ–°15åˆ†é’Ÿæ•°æ®</div>
            </div>
        </div>

        <!-- ç©ºå•ç›ˆåˆ©åˆ†çº§ç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="border: 2px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="stat-icon">ğŸ”¥</div>
                <div class="stat-label" style="color: #991b1b;">ç©ºå•ç›ˆåˆ©â‰¥70%</div>
                <div class="stat-value" id="profit70Plus" style="color: #dc2626; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #991b1b;" id="profit70Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #ea580c; background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);">
                <div class="stat-icon">âš¡</div>
                <div class="stat-label" style="color: #9a3412;">ç©ºå•ç›ˆåˆ©â‰¥60%</div>
                <div class="stat-value" id="profit60Plus" style="color: #ea580c; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #9a3412;" id="profit60Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <div class="stat-icon">ğŸ’«</div>
                <div class="stat-label" style="color: #92400e;">ç©ºå•ç›ˆåˆ©â‰¥50%</div>
                <div class="stat-value" id="profit50Plus" style="color: #f59e0b; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #92400e;" id="profit50Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #10b981; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                <div class="stat-icon">âœ¨</div>
                <div class="stat-label" style="color: #065f46;">ç©ºå•ç›ˆåˆ©â‰¥40%</div>
                <div class="stat-value" id="profit40Plus" style="color: #10b981; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #065f46;" id="profit40Increase">1å°æ—¶å†…: --</div>
            </div>
        </div>

        <!-- ç©ºå•ä½ç›ˆåˆ©/äºæŸç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="border: 2px solid #8b5cf6; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);">
                <div class="stat-icon">ğŸ“‰</div>
                <div class="stat-label" style="color: #5b21b6;">ç©ºå•ç›ˆåˆ©â‰¤20%</div>
                <div class="stat-value" id="profitBelow20" style="color: #8b5cf6; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #5b21b6;" id="profitBelow20Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #6366f1; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-label" style="color: #3730a3;">ç©ºå•ç›ˆåˆ©â‰¤10%</div>
                <div class="stat-value" id="profitBelow10" style="color: #6366f1; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #3730a3;" id="profitBelow10Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #ef4444; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="stat-icon">âŒ</div>
                <div class="stat-label" style="color: #991b1b;">ç©ºå•äºæŸ</div>
                <div class="stat-value" id="lossCount" style="color: #ef4444; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #991b1b;" id="lossCountIncrease">1å°æ—¶å†…: --</div>
            </div>
        </div>

        <!-- æ”¯æ’‘é˜»åŠ›ä¿¡å·ç›‘æ§ -->
        <div class="stats-container" style="margin-top: 20px;">
            <div class="stat-card" style="border: 2px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); cursor: pointer;" onclick="window.location.href='/support-resistance'">
                <div class="stat-icon">ğŸ”´</div>
                <div class="stat-label" style="color: #991b1b;">24å°æ—¶é¡¶ä¿¡å·ç»Ÿè®¡</div>
                <div class="stat-value" id="topSignalCount" style="color: #dc2626; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #991b1b;" id="topSignalTime">ä¸ªè¿›é¡¶åŒºå·ï¼š(æœ€è¿‘24å°æ—¶)</div>
            </div>
            <div class="stat-card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); cursor: pointer;" onclick="window.location.href='/support-resistance'">
                <div class="stat-icon">âš¡</div>
                <div class="stat-label" style="color: #92400e;">2å°æ—¶åº•ä¿¡å·ç»Ÿè®¡</div>
                <div class="stat-value" id="bottomSignalCount" style="color: #f59e0b; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #92400e;" id="bottomSignalTime">ä¸ªè¿›åº•åŒºå·ï¼š(æœ€è¿‘2å°æ—¶)</div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-grid">
            <!-- æ”¶ç›Šç‡è¶‹åŠ¿å›¾ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ“ˆ</span>
                        æ”¶ç›Šç‡è¶‹åŠ¿
                    </div>
                </div>
                <div class="chart-container" id="profitChart"></div>
            </div>

            <!-- æœ€æ–°å‘Šè­¦ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ””</span>
                        æœ€æ–°å‘Šè­¦
                    </div>
                </div>
                <div class="alert-list" id="alertList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å½“å‰é¢„è­¦ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>âš ï¸</span>
                        å½“å‰é¢„è­¦ (äºæŸ >= -8%)
                    </div>
                    <div class="update-time" id="warningsUpdateTime" style="font-size: 14px; color: #718096;">
                        æœ€åæ›´æ–°: --
                    </div>
                </div>
                <div class="table-container">
                    <table id="warningsTable">
                        <thead>
                            <tr>
                                <th>å¸ç§</th>
                                <th>æ–¹å‘</th>
                                <th>å¼€ä»“ä»·</th>
                                <th>å½“å‰ä»·</th>
                                <th>ç›ˆäºç‡</th>
                                <th>æŒä»“é‡</th>
                                <th>é¢„è­¦çº§åˆ«</th>
                                <th>é¢„è­¦æ¶ˆæ¯</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="warningsBody">
                            <tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ”¯æ’‘é˜»åŠ›ä¿¡å·å†å²è®°å½• -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ“Š</span>
                    æ”¯æ’‘é˜»åŠ›ä¿¡å·å†å²è®°å½• (æœ€è¿‘30æ¡)
                </div>
                <div class="update-time" id="signalHistoryUpdateTime" style="font-size: 14px; color: #718096;">
                    æœ€åæ›´æ–°: --
                </div>
            </div>
            <div class="table-container">
                <table id="signalHistoryTable">
                    <thead>
                        <tr>
                            <th style="width: 200px;">æ—¶é—´</th>
                            <th style="width: 150px;">ğŸ”´ 24å°æ—¶é¡¶ä¿¡å·</th>
                            <th style="width: 150px;">âš¡ 2å°æ—¶åº•ä¿¡å·</th>
                        </tr>
                    </thead>
                    <tbody id="signalHistoryBody">
                        <tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å†å²æå€¼è®°å½• -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ†</span>
                    å†å²æå€¼è®°å½•
                </div>
            </div>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>ç±»å‹</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>æŒä»“é‡</th>
                            <th>å¼€ä»“ä»·</th>
                            <th>æ ‡è®°ä»·</th>
                            <th>æ—¶é—´</th>
                            <th>æŒç»­æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr><td colspan="10" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ“ä½œæç¤ºçŠ¶æ€æ  -->
        <div id="operationStatusBar" style="display: none; margin-bottom: 20px; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                <div style="font-size: 32px;" id="statusIcon">ğŸ“Š</div>
                <div style="text-align: left;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="statusTitle">--</div>
                    <div style="font-size: 16px; font-weight: 600;" id="statusHint">--</div>
                </div>
            </div>
        </div>

        <!-- å½“å‰æŒä»“æƒ…å†µ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ’¼</span>
                    å½“å‰æŒä»“æƒ…å†µ
                    <span id="positionStats" style="margin-left: 15px; font-size: 14px; font-weight: normal; color: #718096;">
                        <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </span>
                </div>
                <div class="update-time" id="currentPositionTime" style="font-size: 14px; color: #718096;">
                    æœ€åæ›´æ–°: --
                </div>
            </div>
            <div class="table-container">
                <table id="currentPositionTable">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>æŒä»“é‡</th>
                            <th>å¼€ä»“å‡ä»·</th>
                            <th>æ ‡è®°ä»·æ ¼</th>
                            <th>æ æ†</th>
                            <th>æœªå®ç°ç›ˆäº</th>
                            <th>ä¿è¯é‡‘</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>æå€¼</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="currentPositionBody">
                        <tr><td colspan="13" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>


        <!-- å†å²ç›‘æ§è®°å½• -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ“‹</span>
                    å†å²ç›‘æ§è®°å½•
                </div>
            </div>
            <div class="table-container">
                <table id="monitorTable">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>æŒä»“é‡</th>
                            <th>å¼€ä»“å‡ä»·</th>
                            <th>æ ‡è®°ä»·æ ¼</th>
                            <th>æ æ†</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>å‘Šè­¦ç±»å‹</th>
                            <th>é€šçŸ¥çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="monitorBody">
                        <tr><td colspan="10" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å›¾è¡¨
        const profitChart = echarts.init(document.getElementById('profitChart'));

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // åŠ è½½çŠ¶æ€
                const statusRes = await fetch('/api/anchor-system/status');
                const statusData = await statusRes.json();
                
                if (statusData.success) {
                    document.getElementById('totalMonitors').textContent = statusData.status.total_monitors;
                    document.getElementById('totalAlerts').textContent = statusData.status.total_alerts;
                    document.getElementById('profitTarget').textContent = '+' + statusData.status.config.profit_target + '%';
                    document.getElementById('lossLimit').textContent = statusData.status.config.loss_limit + '%';
                }

                // åŠ è½½æœ€æ–°è®¡æ¬¡æ•°æ®
                const countRes = await fetch('/api/latest');
                const countData = await countRes.json();
                
                if (countData && countData.count !== undefined) {
                    document.getElementById('currentCount').textContent = countData.count;
                    console.log('âœ… è®¡æ¬¡æ•°æ®åŠ è½½:', countData.count);
                } else {
                    document.getElementById('currentCount').textContent = '0';
                }

                // åŠ è½½ç›‘æ§è®°å½•
                const monitorsRes = await fetch('/api/anchor-system/monitors?limit=50');
                const monitorsData = await monitorsRes.json();
                
                if (monitorsData.success) {
                    renderMonitorTable(monitorsData.data);
                    renderProfitChart(monitorsData.data);
                }

                // åŠ è½½å‘Šè­¦è®°å½•
                const alertsRes = await fetch('/api/anchor-system/alerts?limit=10');
                const alertsData = await alertsRes.json();
                
                if (alertsData.success) {
                    renderAlerts(alertsData.data);
                }

                // åŠ è½½å†å²æå€¼è®°å½•ï¼ˆå®ç›˜ï¼‰
                const recordsRes = await fetch('/api/anchor-system/profit-records?trade_mode=real');
                const recordsData = await recordsRes.json();
                
                console.log('ğŸ“Š å†å²æå€¼è®°å½•æ•°æ®:', recordsData);
                console.log('ğŸ“Š è®°å½•æ•°é‡:', recordsData.records ? recordsData.records.length : 0);
                
                if (recordsData.success) {
                    renderRecordsTable(recordsData.records);
                } else {
                    console.error('âŒ å†å²æå€¼è®°å½•åŠ è½½å¤±è´¥:', recordsData);
                }

                // åŠ è½½å½“å‰æŒä»“æƒ…å†µï¼ˆå®ç›˜æ¨¡å¼ï¼‰
                const positionsRes = await fetch('/api/anchor-system/current-positions?trade_mode=real');
                const positionsData = await positionsRes.json();
                
                if (positionsData.success) {
                    renderCurrentPositions(positionsData.positions);
                }

                // åŠ è½½å½“å‰é¢„è­¦ï¼ˆå®ç›˜æ¨¡å¼ï¼‰
                const warningsRes = await fetch('/api/anchor-system/warnings?trade_mode=real');
                const warningsData = await warningsRes.json();
                
                console.log('ğŸš¨ é¢„è­¦æ•°æ®åŠ è½½:', warningsData);
                
                if (warningsData.success) {
                    renderWarnings(warningsData.warnings);
                }

                // æ›´æ–°æ—¶é—´
                const now = new Date();
                document.getElementById('updateTime').textContent = 
                    `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
                document.getElementById('currentPositionTime').textContent = 
                    `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ”¯æ’‘é˜»åŠ›ä¿¡å·æ•°æ®
        async function loadSignalData() {
            try {
                const res = await fetch('/api/signal-monitor/latest');
                const data = await res.json();
                
                if (data.success) {
                    const latest = data.data.latest;
                    
                    // æ›´æ–°é¡¶ä¿¡å·
                    document.getElementById('topSignalCount').textContent = latest.top_signal || 0;
                    
                    // æ›´æ–°åº•ä¿¡å·
                    document.getElementById('bottomSignalCount').textContent = latest.bottom_signal || 0;
                    
                    // æ¸²æŸ“ä¿¡å·å†å²è®°å½•è¡¨æ ¼
                    renderSignalHistory(data.data.history);
                    
                    // æ›´æ–°æ—¶é—´
                    const now = new Date();
                    document.getElementById('signalHistoryUpdateTime').textContent = 
                        `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
                    
                    console.log('ğŸ“Š ä¿¡å·æ•°æ®æ›´æ–°:', latest);
                } else {
                    console.warn('âš ï¸ ä¿¡å·æ•°æ®åŠ è½½å¤±è´¥:', data.message);
                    document.getElementById('topSignalCount').textContent = '--';
                    document.getElementById('bottomSignalCount').textContent = '--';
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ä¿¡å·æ•°æ®å¤±è´¥:', error);
                document.getElementById('topSignalCount').textContent = '--';
                document.getElementById('bottomSignalCount').textContent = '--';
            }
        }

        // æ¸²æŸ“ä¿¡å·å†å²è®°å½•è¡¨æ ¼
        function renderSignalHistory(history) {
            const tbody = document.getElementById('signalHistoryBody');
            
            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #718096;">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }
            
            // åªæ˜¾ç¤ºæœ€è¿‘30æ¡ï¼Œå€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const recentHistory = history.slice(-30).reverse();
            
            let html = '';
            
            for (let i = 0; i < recentHistory.length; i++) {
                const item = recentHistory[i];
                
                html += `
                    <tr>
                        <td style="font-weight: 600; color: #1e293b; padding: 12px;">${item.timestamp}</td>
                        <td style="font-weight: 700; font-size: 18px; color: #dc2626; text-align: center; padding: 12px;">${item.top_signal}</td>
                        <td style="font-weight: 700; font-size: 18px; color: #f59e0b; text-align: center; padding: 12px;">${item.bottom_signal}</td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨å½“å‰è®°å½•æ•°æ®
        let currentRecordsData = [];

        // è®¡ç®—æŒç»­æ—¶é—´çš„å‡½æ•°ï¼ˆç‹¬ç«‹æŠ½å–ï¼Œæ–¹ä¾¿å®šæ—¶æ›´æ–°ï¼‰
        function calculateDuration(timestamp) {
            if (!timestamp) return '--';
            
            try {
                const now = new Date();
                const recordTime = new Date(timestamp.replace(' ', 'T') + '+08:00');
                const diffMs = now - recordTime;
                const totalHours = diffMs / (1000 * 60 * 60);
                
                if (totalHours < 0) {
                    return '<span style="color: #718096;">åˆšåˆš</span>';
                }
                
                const hours = Math.floor(totalHours);
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const days = Math.floor(hours / 24);
                const remainHours = hours % 24;
                
                let color, text;
                
                if (hours < 1) {
                    color = '#10b981';
                    text = `${minutes}åˆ†é’Ÿ`;
                } else if (hours < 24) {
                    color = '#3b82f6';
                    text = `${hours}å°æ—¶${minutes}åˆ†`;
                } else if (days === 1) {
                    color = '#f59e0b';
                    text = `${days}å¤©${remainHours}å°æ—¶`;
                } else if (days === 2) {
                    color = '#f97316';
                    text = `${days}å¤©${remainHours}å°æ—¶`;
                } else {
                    color = '#ef4444';
                    text = `${days}å¤©${remainHours}å°æ—¶`;
                }
                
                return `<span style="color: ${color}; font-weight: 600;">${text}</span>`;
            } catch (e) {
                console.error('æ—¶é—´è§£æé”™è¯¯:', e, timestamp);
                return '--';
            }
        }

        // å­˜å‚¨å†å²ç›ˆåˆ©æ•°æ®ç”¨äºè®¡ç®—1å°æ—¶å†…å¢é‡
        let profitHistoryData = {
            profit70: [],
            profit60: [],
            profit50: [],
            profit40: [],
            profitBelow20: [],
            profitBelow10: [],
            lossCount: [],
            lastUpdate: null
        };

        // æ›´æ–°æ“ä½œæç¤ºçŠ¶æ€æ 
        function updateOperationStatusBar(stats) {
            const statusBar = document.getElementById('operationStatusBar');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusHint = document.getElementById('statusHint');
            
            if (!statusBar || !statusIcon || !statusTitle || !statusHint) return;
            
            // å¸‚åœºä¸‹è·Œç­‰çº§åˆ†æï¼ˆåŸºäºç©ºå•ç›ˆåˆ©â‰¥40%çš„æ€»æ•°ï¼‰
            let marketDownLevel = 0;
            let marketDownLevelText = '';
            let marketDownIcon = '';
            
            if (stats.profit40 >= 10) {
                // 5çº§å’Œ4çº§ï¼šç©ºå•ç›ˆåˆ©â‰¥40%çš„æ€»æ•°å¤§äºç­‰äº10
                // éœ€è¦é¢å¤–åˆ¤æ–­æ¡ä»¶æ¥åŒºåˆ†5çº§å’Œ4çº§
                if (stats.profit50 >= 8 && stats.profit60 >= 5) {
                    marketDownLevel = 5;
                    marketDownLevelText = '5çº§ä¸‹è·Œ - æ·±åº¦ä¸‹è·Œ';
                    marketDownIcon = 'ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´';
                } else {
                    marketDownLevel = 4;
                    marketDownLevelText = '4çº§ä¸‹è·Œ - é‡åº¦ä¸‹è·Œ';
                    marketDownIcon = 'ğŸ”´ğŸ”´ğŸ”´ğŸ”´';
                }
            } else if (stats.profit40 >= 8) {
                marketDownLevel = 3;
                marketDownLevelText = '3çº§ä¸‹è·Œ - ä¸­åº¦ä¸‹è·Œ';
                marketDownIcon = 'ğŸ”´ğŸ”´ğŸ”´';
            } else if (stats.profit40 >= 5) {
                marketDownLevel = 2;
                marketDownLevelText = '2çº§ä¸‹è·Œ - è½»åº¦ä¸‹è·Œ';
                marketDownIcon = 'ğŸ”´ğŸ”´';
            }
            
            // æ–°çš„è§¦å‘è§„åˆ™
            // è§¦åº•åå¼¹ï¼šprofit70 >= 1 AND profit60 >= 2 AND profit50 >= 5 AND profit40 >= 8
            const isBottomRebound = stats.profit70 >= 1 && stats.profit60 >= 2 && stats.profit50 >= 5 && stats.profit40 >= 8;
            
            // å¤šè½¬ç©ºï¼šprofit70 == 0 AND profit50 >= 1 AND profit40 >= 3
            const isLongToShort = stats.profit70 === 0 && stats.profit50 >= 1 && stats.profit40 >= 3;
            
            // å¤šå¤´è¡Œæƒ…ï¼šprofitBelow20 >= 8 AND profitBelow10 >= 6 AND lossCount >= 2
            const isBullMarket = stats.profitBelow20 >= 8 && stats.profitBelow10 >= 6 && stats.lossCount >= 2;
            
            // ä¼˜å…ˆæ˜¾ç¤ºå¸‚åœºä¸‹è·Œç­‰çº§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (marketDownLevel >= 2) {
                // æ˜¾ç¤ºå¸‚åœºä¸‹è·Œç­‰çº§
                statusBar.style.display = 'block';
                statusBar.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
                statusBar.style.border = '3px solid #991b1b';
                statusIcon.textContent = marketDownIcon;
                statusTitle.textContent = `å¸‚åœºä¸‹è·Œç­‰çº§åˆ†æï¼š${marketDownLevelText}`;
                statusTitle.style.color = '#ffffff';
                statusHint.textContent = `ç©ºå•ç›ˆåˆ©â‰¥40%æ•°é‡: ${stats.profit40} | æ“ä½œæç¤ºï¼šæŒæœ‰ç©ºå•`;
                statusHint.style.color = '#fee2e2';
                console.log('ğŸ”´ çŠ¶æ€æ : å¸‚åœºä¸‹è·Œç­‰çº§', marketDownLevel, stats);
            } else if (isBullMarket) {
                // æ˜¾ç¤ºï¼šå¤šå¤´è¡Œæƒ… - é€‚åˆåšå¤š
                statusBar.style.display = 'block';
                statusBar.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                statusBar.style.border = '3px solid #1d4ed8';
                statusIcon.textContent = 'ğŸš€';
                statusTitle.textContent = 'å¤šå¤´è¡Œæƒ…';
                statusTitle.style.color = '#ffffff';
                statusHint.textContent = 'æ“ä½œæç¤ºï¼šé€‚åˆåšå¤š';
                statusHint.style.color = '#dbeafe';
                console.log('âœ… çŠ¶æ€æ : å¤šå¤´è¡Œæƒ…', stats);
            } else if (isBottomRebound) {
                // æ˜¾ç¤ºï¼šè§¦åº•åå¼¹ - ç¦æ­¢ç©ºå•
                statusBar.style.display = 'block';
                statusBar.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                statusBar.style.border = '3px solid #2f855a';
                statusIcon.textContent = 'ğŸ“ˆ';
                statusTitle.textContent = 'è§¦åº•åå¼¹';
                statusTitle.style.color = '#ffffff';
                statusHint.textContent = 'æ“ä½œæç¤ºï¼šç¦æ­¢ç©ºå•';
                statusHint.style.color = '#e6fffa';
                console.log('âœ… çŠ¶æ€æ : è§¦åº•åå¼¹', stats);
            } else if (isLongToShort) {
                // æ˜¾ç¤ºï¼šå¤šè½¬ç©º - ç¦æ­¢å¤šå•
                statusBar.style.display = 'block';
                statusBar.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                statusBar.style.border = '3px solid #c53030';
                statusIcon.textContent = 'ğŸ”„';
                statusTitle.textContent = 'å¤šè½¬ç©º';
                statusTitle.style.color = '#ffffff';
                statusHint.textContent = 'æ“ä½œæç¤ºï¼šç¦æ­¢å¤šå•';
                statusHint.style.color = '#fed7d7';
                console.log('âš ï¸ çŠ¶æ€æ : å¤šè½¬ç©º', stats);
            } else {
                // éšè—çŠ¶æ€æ 
                statusBar.style.display = 'none';
                console.log('â„¹ï¸ çŠ¶æ€æ éšè—', stats);
            }
        }

        // ä»…æ›´æ–°æŒç»­æ—¶é—´åˆ—ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼ï¼‰
        function updateDurations() {
            const tbody = document.getElementById('recordsBody');
            if (!tbody || currentRecordsData.length === 0) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (index < currentRecordsData.length) {
                    const item = currentRecordsData[index];
                    const durationCell = row.querySelector('td:nth-child(9)'); // ç¬¬9åˆ—æ˜¯æŒç»­æ—¶é—´
                    if (durationCell && item.timestamp) {
                        durationCell.innerHTML = calculateDuration(item.timestamp);
                    }
                }
            });
            
            console.log('â° æŒç»­æ—¶é—´å·²æ›´æ–°');
        }

        // æ¸²æŸ“å†å²æå€¼è®°å½•è¡¨
        function renderRecordsTable(data) {
            currentRecordsData = data; // ä¿å­˜æ•°æ®ä¾›æŒç»­æ—¶é—´æ›´æ–°ä½¿ç”¨
            const tbody = document.getElementById('recordsBody');
            
            console.log('ğŸ” renderRecordsTable è¢«è°ƒç”¨');
            console.log('  æ•°æ®ç±»å‹:', typeof data);
            console.log('  æ•°æ®é•¿åº¦:', data ? data.length : 'null');
            console.log('  å‰2æ¡æ•°æ®:', data ? data.slice(0, 2) : 'null');
            
            if (!data || data.length === 0) {
                console.log('âš ï¸ å†å²è®°å½•æ•°æ®ä¸ºç©º');
                tbody.innerHTML = '<tr><td colspan="10" class="empty">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }
            
            console.log('âœ… å¼€å§‹æ¸²æŸ“å†å²è®°å½•...');
            
            // å¸ç§ç¼–å·æ˜ å°„
            const coinNumbers = {
                'CFX-USDT-SWAP': 'NO.1',
                'FIL-USDT-SWAP': 'NO.2',
                'CRO-USDT-SWAP': 'NO.3',
                'UNI-USDT-SWAP': 'NO.4',
                'CRV-USDT-SWAP': 'NO.5',
                'LDO-USDT-SWAP': 'NO.6'
            };
            
            try {
                tbody.innerHTML = data.map(item => {
                    // è®¡ç®—æŒç»­æ—¶é—´
                    const durationHtml = calculateDuration(item.timestamp);
                    // è·å–ç¼–å·
                    const coinNumber = coinNumbers[item.inst_id] || '--';
                    
                    return `
                    <tr>
                        <td style="font-weight: 700; color: #667eea;">${coinNumber}</td>
                        <td>${item.inst_id || '--'}</td>
                        <td>
                            <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                                ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${item.record_type === 'max_profit' ? 'badge-profit' : 'badge-loss'}">
                                ${item.record_type === 'max_profit' ? 'ğŸ† æœ€é«˜ç›ˆåˆ©' : 'ğŸ“‰ æœ€å¤§äºæŸ'}
                            </span>
                        </td>
                        <td style="color: ${(item.profit_rate || 0) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 16px;">
                            ${(item.profit_rate || 0) >= 0 ? '+' : ''}${(item.profit_rate || 0).toFixed(2)}%
                        </td>
                        <td>${Math.abs(item.pos_size || 0).toFixed(4)}</td>
                        <td>$${(item.avg_price || 0).toFixed(4)}</td>
                        <td>$${(item.mark_price || 0).toFixed(4)}</td>
                        <td>${item.timestamp}</td>
                        <td>${durationHtml}</td>
                    </tr>
                `;
                }).join('');
                
                console.log('âœ… å†å²è®°å½•æ¸²æŸ“å®Œæˆï¼Œå…±', data.length, 'æ¡');
            } catch (error) {
                console.error('âŒ æ¸²æŸ“å†å²è®°å½•å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="10" class="empty">æ¸²æŸ“å¤±è´¥ï¼Œè¯·æŸ¥çœ‹Console</td></tr>';
            }
        }

        // æ¸²æŸ“å½“å‰æŒä»“æƒ…å†µ
        function renderCurrentPositions(data) {
            const tbody = document.getElementById('currentPositionBody');
            const statsDiv = document.getElementById('positionStats');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="empty">å½“å‰æ— æŒä»“</td></tr>';
                statsDiv.innerHTML = '';
                // æ¸…ç©ºç›ˆåˆ©ç»Ÿè®¡æ˜¾ç¤º
                document.getElementById('profit70Plus').textContent = '0';
                document.getElementById('profit60Plus').textContent = '0';
                document.getElementById('profit50Plus').textContent = '0';
                document.getElementById('profit40Plus').textContent = '0';
                document.getElementById('profitBelow20').textContent = '0';
                document.getElementById('profitBelow10').textContent = '0';
                document.getElementById('lossCount').textContent = '0';
                document.getElementById('profit70Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit60Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit50Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit40Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profitBelow20Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profitBelow10Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('lossCountIncrease').textContent = '1å°æ—¶å†…: --';
                return;
            }

            // ç»Ÿè®¡åšç©ºæŒä»“å„ç›ˆåˆ©çº§åˆ«
            const shortPositions = data.filter(item => item.pos_side === 'short');
            const profit70 = shortPositions.filter(item => item.profit_rate >= 70).length;
            const profit60 = shortPositions.filter(item => item.profit_rate >= 60).length;
            const profit50 = shortPositions.filter(item => item.profit_rate >= 50).length;
            const profit40 = shortPositions.filter(item => item.profit_rate >= 40).length;
            const profitBelow20 = shortPositions.filter(item => item.profit_rate > 0 && item.profit_rate <= 20).length;
            const profitBelow10 = shortPositions.filter(item => item.profit_rate > 0 && item.profit_rate <= 10).length;
            const lossCount = shortPositions.filter(item => item.profit_rate < 0).length;
            const lossBelow10 = shortPositions.filter(item => item.profit_rate <= -10).length;
            
            // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
            document.getElementById('profit70Plus').textContent = profit70;
            document.getElementById('profit60Plus').textContent = profit60;
            document.getElementById('profit50Plus').textContent = profit50;
            document.getElementById('profit40Plus').textContent = profit40;
            document.getElementById('profitBelow20').textContent = profitBelow20;
            document.getElementById('profitBelow10').textContent = profitBelow10;
            document.getElementById('lossCount').textContent = lossCount;
            
            // è®¡ç®—1å°æ—¶å†…å¢é‡
            const now = Date.now();
            const oneHourAgo = now - 60 * 60 * 1000;
            
            // ä¿å­˜å½“å‰æ•°æ®åˆ°å†å²
            if (!profitHistoryData.lastUpdate || now - profitHistoryData.lastUpdate > 60000) {
                // æ¯åˆ†é’Ÿè®°å½•ä¸€æ¬¡
                profitHistoryData.profit70.push({ time: now, count: profit70 });
                profitHistoryData.profit60.push({ time: now, count: profit60 });
                profitHistoryData.profit50.push({ time: now, count: profit50 });
                profitHistoryData.profit40.push({ time: now, count: profit40 });
                profitHistoryData.profitBelow20.push({ time: now, count: profitBelow20 });
                profitHistoryData.profitBelow10.push({ time: now, count: profitBelow10 });
                profitHistoryData.lossCount.push({ time: now, count: lossCount });
                profitHistoryData.lastUpdate = now;
                
                // æ¸…ç†è¶…è¿‡1å°æ—¶çš„æ•°æ®
                profitHistoryData.profit70 = profitHistoryData.profit70.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit60 = profitHistoryData.profit60.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit50 = profitHistoryData.profit50.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit40 = profitHistoryData.profit40.filter(d => d.time > oneHourAgo);
                profitHistoryData.profitBelow20 = profitHistoryData.profitBelow20.filter(d => d.time > oneHourAgo);
                profitHistoryData.profitBelow10 = profitHistoryData.profitBelow10.filter(d => d.time > oneHourAgo);
                profitHistoryData.lossCount = profitHistoryData.lossCount.filter(d => d.time > oneHourAgo);
            }
            
            // è®¡ç®—å¢é‡
            function calcIncrease(historyArray, currentCount) {
                if (historyArray.length < 2) return '--';
                const oldestData = historyArray[0];
                const increase = currentCount - oldestData.count;
                if (increase > 0) {
                    return `+${increase}`;
                } else if (increase < 0) {
                    return `${increase}`;
                } else {
                    return '0';
                }
            }
            
            document.getElementById('profit70Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit70, profit70)}`;
            document.getElementById('profit60Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit60, profit60)}`;
            document.getElementById('profit50Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit50, profit50)}`;
            document.getElementById('profit40Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit40, profit40)}`;
            document.getElementById('profitBelow20Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profitBelow20, profitBelow20)}`;
            document.getElementById('profitBelow10Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profitBelow10, profitBelow10)}`;
            document.getElementById('lossCountIncrease').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.lossCount, lossCount)}`;
            
            // æ›´æ–°æ“ä½œæç¤ºçŠ¶æ€æ ï¼ˆä½¿ç”¨æ–°è§„åˆ™ï¼‰
            updateOperationStatusBar({
                profit70: profit70,
                profit60: profit60,
                profit50: profit50,
                profit40: profit40,
                profitBelow20: profitBelow20,
                profitBelow10: profitBelow10,
                lossCount: lossCount
            });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            statsDiv.innerHTML = `
                <span style="display: inline-flex; align-items: center; gap: 15px;">
                    <span style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
                                 color: white; 
                                 padding: 4px 12px; 
                                 border-radius: 12px; 
                                 font-size: 13px;
                                 font-weight: 600;
                                 box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);">
                        ğŸ¯ ç›ˆåˆ©â‰¥40%: ${profit40}
                    </span>
                    <span style="background: linear-gradient(135deg, ${lossBelow10 > 0 ? '#f56565' : '#a0aec0'} 0%, ${lossBelow10 > 0 ? '#e53e3e' : '#718096'} 100%); 
                                 color: white; 
                                 padding: 4px 12px; 
                                 border-radius: 12px; 
                                 font-size: 13px;
                                 font-weight: 600;
                                 box-shadow: 0 2px 4px ${lossBelow10 > 0 ? 'rgba(245, 101, 101, 0.3)' : 'rgba(160, 174, 192, 0.3)'};">
                        âš ï¸ äºæŸâ‰¤-10%: ${lossBelow10}
                    </span>
                </span>
            `;

            // è°ƒè¯•æ—¥å¿—
            console.log('ğŸ” æ¸²æŸ“å½“å‰æŒä»“æ•°æ®:', data);
            console.log('ğŸ“Š åšç©ºç»Ÿè®¡: â‰¥70%:', profit70, 'â‰¥60%:', profit60, 'â‰¥50%:', profit50, 'â‰¥40%:', profit40, 
                        'â‰¤20%:', profitBelow20, 'â‰¤10%:', profitBelow10, 'äºæŸ:', lossCount, 'â‰¤-10%:', lossBelow10);
            if (data.length > 0) {
                console.log('ğŸ“Š ç¬¬ä¸€æ¡æ•°æ® pos_size:', data[0].pos_size, 'type:', typeof data[0].pos_size);
                // è°ƒè¯•ä¿è¯é‡‘å€¼
                console.log('ğŸ’° å‰3ä¸ªæŒä»“çš„ä¿è¯é‡‘å€¼:');
                for (let i = 0; i < Math.min(3, data.length); i++) {
                    console.log(`  ${i+1}. ${data[i].inst_id} ${data[i].pos_side}: margin=${data[i].margin}, type=${typeof data[i].margin}`);
                }
            }

            // å¸ç§ç¼–å·æ˜ å°„
            const coinNumbers = {
                'CFX-USDT-SWAP': 'NO.1',
                'FIL-USDT-SWAP': 'NO.2',
                'CRO-USDT-SWAP': 'NO.3',
                'UNI-USDT-SWAP': 'NO.4',
                'CRV-USDT-SWAP': 'NO.5',
                'LDO-USDT-SWAP': 'NO.6'
            };
            
            tbody.innerHTML = data.map(item => {
                const coinNumber = coinNumbers[item.inst_id] || '--';
                // æ ¼å¼åŒ–æå€¼æ˜¾ç¤º
                let extremeHtml = '--';
                if (item.max_profit_rate !== null && item.max_profit_rate !== undefined) {
                    const maxProfit = item.max_profit_rate.toFixed(2);
                    const maxLoss = (item.max_loss_rate || 0).toFixed(2);
                    extremeHtml = `<div style="font-size: 12px;">
                        <div style="color: #48bb78;">ğŸ† ${maxProfit}%</div>
                        <div style="color: #f56565;">ğŸ“‰ ${maxLoss}%</div>
                    </div>`;
                }
                
                return `
                <tr>
                    <td style="font-weight: 700; color: #667eea;">${coinNumber}</td>
                    <td style="font-weight: 600;">${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>${(item.pos_size || 0).toFixed(4)}</td>
                    <td>$${item.avg_price.toFixed(4)}</td>
                    <td>$${item.mark_price.toFixed(4)}</td>
                    <td>${item.lever}x</td>
                    <td style="color: ${item.upl >= 0 ? '#48bb78' : '#f56565'}; font-weight: 600;">
                        ${item.upl >= 0 ? '+' : ''}${item.upl.toFixed(4)} USDT
                    </td>
                    <td>${item.margin.toFixed(4)} USDT</td>
                    <td style="color: ${item.profit_rate >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 16px;">
                        ${item.profit_rate >= 0 ? '+' : ''}${item.profit_rate.toFixed(2)}%
                    </td>
                    <td>${extremeHtml}</td>
                    <td>
                        <span class="badge ${
                            item.status_class === 'profit' ? 'badge-profit' : 
                            item.status_class === 'loss' ? 'badge-loss' : 
                            'badge-normal'
                        }">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                        <button onclick="manualMaintainPosition('${item.inst_id}', '${item.pos_side}', ${item.pos_size})" 
                                style="padding: 5px 10px; background: #f97316; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                            ğŸ”§ æ‰‹åŠ¨ç»´æŠ¤
                        </button>
                        <button onclick="showPositionDetail('${item.inst_id}', '${item.pos_side}')" 
                                style="padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                            ğŸ“Š è¯¦æƒ…
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // æ‰‹åŠ¨ç»´æŠ¤æŒä»“
        async function manualMaintainPosition(instId, posSide, posSize) {
            if (!confirm(`ç¡®è®¤æ‰‹åŠ¨ç»´æŠ¤ ${instId} ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'} æŒä»“ï¼Ÿ\n\nå°†æ‰§è¡Œï¼š\n1. å¼€10å€åº•ä»“æ•°é‡çš„æ–°ä»“ï¼ˆ10å€æ æ†ï¼‰\n2. ç«‹å³å¹³æ‰92%\n3. ä¿ç•™8%ä½œä¸ºæ–°çš„é”šç‚¹å•`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/anchor/maintain-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inst_id: instId,
                        pos_side: posSide,
                        pos_size: parseFloat(posSize),
                        auto_adjust: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ç»´æŠ¤æˆåŠŸï¼\n\n${result.message || 'ç»´æŠ¤å®Œæˆ'}`);
                    // åˆ·æ–°æŒä»“æ•°æ®
                    loadData();
                } else {
                    alert(`âŒ ç»´æŠ¤å¤±è´¥ï¼š${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('ç»´æŠ¤å¤±è´¥:', error);
                alert(`âŒ ç»´æŠ¤å¤±è´¥ï¼š${error.message}`);
            }
        }
        
        // æ˜¾ç¤ºæŒä»“è¯¦æƒ…
        async function showPositionDetail(instId, posSide) {
            try {
                // è¿™é‡Œå¯ä»¥è°ƒç”¨APIè·å–æŒä»“è¯¦ç»†ä¿¡æ¯
                // æš‚æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                const positionData = currentRecordsData.find(p => p.inst_id === instId && p.pos_side === posSide);
                if (!positionData) {
                    alert('æœªæ‰¾åˆ°æŒä»“æ•°æ®');
                    return;
                }
                
                const message = `ğŸ“Š æŒä»“è¯¦æƒ…\n\n` +
                    `å¸ç§: ${positionData.inst_id}\n` +
                    `æ–¹å‘: ${positionData.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}\n` +
                    `æŒä»“é‡: ${positionData.pos_size?.toFixed(4) || '--'}\n` +
                    `å¼€ä»“å‡ä»·: $${positionData.avg_price?.toFixed(4) || '--'}\n` +
                    `æ ‡è®°ä»·æ ¼: $${positionData.mark_price?.toFixed(4) || '--'}\n` +
                    `æ æ†: ${positionData.lever}x\n` +
                    `æœªå®ç°ç›ˆäº: ${positionData.upl >= 0 ? '+' : ''}${positionData.upl?.toFixed(4) || '--'} USDT\n` +
                    `ä¿è¯é‡‘: ${positionData.margin?.toFixed(4) || '--'} USDT\n` +
                    `æ”¶ç›Šç‡: ${positionData.profit_rate >= 0 ? '+' : ''}${positionData.profit_rate?.toFixed(2) || '--'}%\n` +
                    `\næå€¼ç»Ÿè®¡:\n` +
                    `æœ€é«˜ç›ˆåˆ©ç‡: ${positionData.max_profit_rate?.toFixed(2) || '--'}%\n` +
                    `æœ€å¤§äºæŸç‡: ${positionData.max_loss_rate?.toFixed(2) || '--'}%`;
                
                alert(message);
            } catch (error) {
                console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);
                alert(`âŒ è·å–è¯¦æƒ…å¤±è´¥ï¼š${error.message}`);
            }
        }

        // æ¸²æŸ“é¢„è­¦è¡¨
        function renderWarnings(data) {
            const tbody = document.getElementById('warningsBody');
            const updateTime = document.getElementById('warningsUpdateTime');
            
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            updateTime.textContent = `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty">âœ… å½“å‰æ— é¢„è­¦</td></tr>';
                return;
            }

            console.log('âš ï¸ æ¸²æŸ“é¢„è­¦æ•°æ®:', data);

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td style="font-weight: 600;">${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>$${item.open_price.toFixed(4)}</td>
                    <td>$${item.current_price.toFixed(4)}</td>
                    <td>
                        <span class="profit-rate ${
                            item.warning_level === 'critical' ? 'critical-level' : 
                            item.warning_level === 'warning' ? 'warning-level' : ''
                        }">
                            ${item.profit_rate.toFixed(2)}%
                        </span>
                    </td>
                    <td>${item.open_size.toFixed(4)}</td>
                    <td>
                        <span class="warning-badge ${item.warning_level}">
                            ${item.warning_level === 'critical' ? 'ğŸ”´ ä¸´ç•Œ' : 
                              item.warning_level === 'warning' ? 'ğŸŸ¡ é¢„è­¦' : 
                              'ğŸ”µ ä¿¡æ¯'}
                        </span>
                    </td>
                    <td style="max-width: 300px; white-space: normal;">${item.alert_message}</td>
                    <td style="font-size: 12px; color: #718096;">${item.created_at}</td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“ç›‘æ§è®°å½•è¡¨
        function renderMonitorTable(data) {
            const tbody = document.getElementById('monitorBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty">æš‚æ— ç›‘æ§è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.timestamp}</td>
                    <td>${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>${Math.abs(item.pos_size || 0).toFixed(4)}</td>
                    <td>$${(item.avg_price || 0).toFixed(4)}</td>
                    <td>$${(item.mark_price || 0).toFixed(4)}</td>
                    <td>${item.leverage}x</td>
                    <td style="color: ${(item.profit_rate || 0) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 600;">
                        ${(item.profit_rate || 0) >= 0 ? '+' : ''}${(item.profit_rate || 0).toFixed(2)}%
                    </td>
                    <td>
                        ${item.alert_type ? (() => {
                            if (item.alert_type === 'profit_target') {
                                return '<span class="badge badge-profit">ç›ˆåˆ©ç›®æ ‡</span>';
                            } else if (item.alert_type === 'loss_limit') {
                                return '<span class="badge badge-loss">æ­¢æŸè­¦å‘Š</span>';
                            } else if (item.alert_type === 'extreme_max_profit') {
                                return '<span class="badge badge-profit">æœ€é«˜ç›ˆåˆ©åˆ·æ–°</span>';
                            } else if (item.alert_type === 'extreme_max_loss') {
                                return '<span class="badge badge-loss">æœ€å¤§äºæŸåˆ·æ–°</span>';
                            } else {
                                return '<span class="badge badge-normal">å…¶ä»–å‘Šè­¦</span>';
                            }
                        })() : '--'}
                    </td>
                    <td>
                        ${item.alert_sent ? 
                            '<span class="badge badge-sent">å·²å‘é€</span>' : 
                            (item.alert_type ? '<span class="badge badge-pending">æœªå‘é€</span>' : '--')}
                    </td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“æ”¶ç›Šç‡å›¾è¡¨
        function renderProfitChart(data) {
            // åè½¬æ•°æ®é¡ºåºï¼ˆä»æ—§åˆ°æ–°ï¼‰
            const reversedData = [...data].reverse();
            
            const timestamps = reversedData.map(item => {
                const time = new Date(item.timestamp);
                return time.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            });
            
            const profitRates = reversedData.map(item => (item.profit_rate || 0).toFixed(2));

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `æ—¶é—´: ${data.name}<br/>æ”¶ç›Šç‡: ${data.value}%`;
                    }
                },
                grid: {
                    left: '50px',
                    right: '20px',
                    top: '20px',
                    bottom: '30px'
                },
                xAxis: {
                    type: 'category',
                    data: timestamps,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ”¶ç›Šç‡ (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'æ”¶ç›Šç‡',
                    type: 'line',
                    data: profitRates,
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: '#667eea'
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [
                                {offset: 0, color: 'rgba(102, 126, 234, 0.3)'},
                                {offset: 1, color: 'rgba(102, 126, 234, 0.05)'}
                            ]
                        }
                    }
                }]
            };

            profitChart.setOption(option);
        }

        // æ¸²æŸ“å‘Šè­¦åˆ—è¡¨
        function renderAlerts(data) {
            const alertList = document.getElementById('alertList');
            
            if (data.length === 0) {
                alertList.innerHTML = '<div class="empty">æš‚æ— å‘Šè­¦è®°å½•</div>';
                return;
            }

            alertList.innerHTML = data.map(alert => {
                // åˆ¤æ–­å‘Šè­¦ç±»å‹
                let alertTitle = '';
                let alertClass = '';
                
                if (alert.alert_type === 'profit_target') {
                    alertTitle = 'ğŸ‰ ç›ˆåˆ©ç›®æ ‡è¾¾æˆ';
                    alertClass = 'profit';
                } else if (alert.alert_type === 'loss_limit') {
                    alertTitle = 'âš ï¸ æ­¢æŸè­¦å‘Š';
                    alertClass = 'loss';
                } else if (alert.alert_type === 'extreme_max_profit') {
                    alertTitle = 'ğŸš€ æœ€é«˜ç›ˆåˆ©æå€¼åˆ·æ–°é¢„è­¦';
                    alertClass = 'profit';
                } else if (alert.alert_type === 'extreme_max_loss') {
                    alertTitle = 'ğŸ“‰ æœ€å¤§äºæŸæå€¼åˆ·æ–°é¢„è­¦';
                    alertClass = 'loss';
                } else {
                    alertTitle = 'ğŸ“¢ å‘Šè­¦';
                    alertClass = alert.profit_rate >= 0 ? 'profit' : 'loss';
                }
                
                return `
                    <div class="alert-item ${alertClass}">
                        <div class="alert-header">
                            <div class="alert-title">
                                ${alertTitle}
                            </div>
                            <div class="alert-time">${alert.timestamp}</div>
                        </div>
                        <div class="alert-details">
                            ${alert.inst_id} â€¢ ${alert.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'} â€¢ 
                            <strong style="color: ${alert.profit_rate >= 0 ? '#48bb78' : '#f56565'}">
                                ${alert.profit_rate >= 0 ? '+' : ''}${alert.profit_rate.toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            console.log('ğŸ”„ åˆ·æ–°æ•°æ®...', new Date().toLocaleString('zh-CN'));
            loadData();
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', () => {
            profitChart.resize();
        });

        // ============================================================
        // é¡µé¢åˆå§‹åŒ–
        // ============================================================
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“Š å¼€å§‹åŠ è½½é”šç‚¹ç³»ç»Ÿæ•°æ®...', new Date().toLocaleString('zh-CN'));
            
            // åˆå§‹åŠ è½½æ•°æ®
            loadData();
            loadSignalData();  // åŠ è½½ä¿¡å·æ•°æ®
            
            // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                console.log('â° è‡ªåŠ¨åˆ·æ–°æ•°æ®...', new Date().toLocaleString('zh-CN'));
                refreshData();
            }, 30000);
            
            // ä¿¡å·æ•°æ®åˆ·æ–°ï¼ˆæ¯60ç§’ï¼‰
            setInterval(() => {
                console.log('ğŸ“Š åˆ·æ–°ä¿¡å·æ•°æ®...', new Date().toLocaleString('zh-CN'));
                loadSignalData();
            }, 60000);
            
            // æŒç»­æ—¶é—´ç‹¬ç«‹æ›´æ–°ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                console.log('â° æ›´æ–°æŒç»­æ—¶é—´...', new Date().toLocaleString('zh-CN'));
                updateDurations();
            }, 30000);
            
            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œ30ç§’è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼ˆæ•°æ®+æŒç»­æ—¶é—´ï¼‰ï¼Œ60ç§’åˆ·æ–°ä¿¡å·æ•°æ®');
        });
    </script>
</body>
</html>
