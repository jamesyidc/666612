<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2026-01-01-02:00 ä¿®å¤ä¸‹è·Œå¼ºåº¦æ¨¡å—æ›´æ–° -->
    <title>ğŸ”´ å®ç›˜é”šç‚¹ç³»ç»Ÿ - OKExæŒä»“ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-subvalue {
            font-size: 14px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 350px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-profit {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-loss {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-short {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-long {
            background: #bee3f8;
            color: #2c5282;
        }

        .badge-sent {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-pending {
            background: #e2e8f0;
            color: #4a5568;
        }

        .badge-normal {
            background: #e6fffa;
            color: #234e52;
        }

        .alert-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .alert-item.profit {
            border-left-color: #48bb78;
        }

        .alert-item.loss {
            border-left-color: #f56565;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .alert-title {
            font-weight: 600;
            color: #2d3748;
        }

        .alert-time {
            color: #a0aec0;
            font-size: 12px;
        }

        .alert-details {
            font-size: 13px;
            color: #4a5568;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        /* é¢„è­¦æ ·å¼ */
        .warning-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .warning-badge.critical {
            background: #fed7d7;
            color: #c53030;
        }

        .warning-badge.warning {
            background: #feebc8;
            color: #dd6b20;
        }

        .warning-badge.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .profit-rate.warning-level {
            color: #dd6b20;
            font-weight: 600;
        }

        .profit-rate.critical-level {
            color: #c53030;
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* å†å²æ•°æ®æŒ‰é’®æ ·å¼ */
        .history-data-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .history-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #7c8ff0 0%, #8a5bb4 100%);
        }

        .history-data-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- ç‰ˆæœ¬æ£€æµ‹æ ‡è®° -->
        <div id="page-version" data-version="2025-12-29-v2" style="display: none;"></div>
        
        <div class="header">
            <h1>
                <span>ğŸ”´</span>
                å®ç›˜é”šç‚¹ç³»ç»Ÿ
            </h1>
            <div class="subtitle">
                <span>OKExå®ç›˜æŒä»“ç›‘æ§ï¼ˆReal Tradingï¼‰</span>
                <span>â€¢</span>
                <span id="updateTime">--</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>ğŸ”„</span>
                    åˆ·æ–°æ•°æ®
                </button>
                <button class="btn btn-primary" onclick="window.open('/anchor-snapshots', '_blank')">
                    <span>ğŸ“Š</span>
                    å†å²æ•°æ®
                </button>
                <a href="/" class="btn btn-secondary" style="text-decoration: none;">
                    <span>ğŸ </span>
                    è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>

        <!-- ä¸»è´¦æˆ·æŒä»“ç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card" style="border: 2px solid #48bb78; background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);">
                <div class="stat-icon">ğŸ’¼</div>
                <div class="stat-label" style="color: #22543d;">ä¸»è´¦æˆ·æ€»æŒä»“</div>
                <div class="stat-value" id="mainAccountTotalPositions" style="color: #22543d; font-size: 48px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #22543d;" id="mainAccountPositionDetail">å¤šå•: -- | ç©ºå•: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #4299e1; background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);">
                <div class="stat-icon">ğŸ¦</div>
                <div class="stat-label" style="color: #2c5282;">å­è´¦æˆ·æ€»æŒä»“</div>
                <div class="stat-value" id="subAccountTotalPositions" style="color: #2c5282; font-size: 48px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #2c5282;" id="subAccountPositionDetail">è´¦æˆ·æ•°: -- | æŒä»“: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #805ad5; background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%);">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-label" style="color: #44337a;">æ€»ç›ˆäº</div>
                <div class="stat-value" id="totalProfitLoss" style="color: #44337a; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #44337a;" id="totalProfitLossDetail">å¹³å‡æ”¶ç›Šç‡: --</div>
            </div>
        </div>

        <!-- ä»Šæ—¥ç»´æŠ¤ç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card" style="border: 2px solid #4299e1; background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);">
                <div class="stat-icon">ğŸ“‰</div>
                <div class="stat-label" style="color: #2c5282;">ç©ºå•ç›ˆåˆ©â‰¤20%</div>
                <div class="stat-value" id="todayProfitBelow20" style="color: #2c5282; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #2c5282;">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #667eea; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-label" style="color: #434190;">ç©ºå•ç›ˆåˆ©â‰¤10%</div>
                <div class="stat-value" id="todayProfitBelow10" style="color: #434190; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #434190;">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #fc8181; background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);">
                <div class="stat-icon">âŒ</div>
                <div class="stat-label" style="color: #742a2a;">ç©ºå•äºæŸ</div>
                <div class="stat-value" id="todayLossCount" style="color: #742a2a; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #742a2a;">1å°æ—¶å†…: --</div>
            </div>
        </div>

        <!-- å†å²æå€¼ç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card" style="border: 2px solid #48bb78; background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);">
                <div class="stat-icon">ğŸŸ¢</div>
                <div class="stat-label" style="color: #22543d;">å¤šå•ç›ˆåˆ©</div>
                <div class="stat-value" id="longProfitCount" style="color: #22543d; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #22543d;">å®æ—¶ç»Ÿè®¡</div>
            </div>
            <div class="stat-card" style="border: 2px solid #fc8181; background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);">
                <div class="stat-icon">ğŸ”´</div>
                <div class="stat-label" style="color: #742a2a;">å¤šå•äºæŸ</div>
                <div class="stat-value" id="longLossCount" style="color: #742a2a; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #742a2a;">å®æ—¶ç»Ÿè®¡</div>
            </div>
            <div class="stat-card" style="border: 2px solid #48bb78; background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);">
                <div class="stat-icon">ğŸŸ¢</div>
                <div class="stat-label" style="color: #22543d;">ç©ºå•ç›ˆåˆ©</div>
                <div class="stat-value" id="shortProfitCount" style="color: #22543d; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #22543d;">å®æ—¶ç»Ÿè®¡</div>
            </div>
            <div class="stat-card" style="border: 2px solid #fc8181; background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);">
                <div class="stat-icon">ğŸ”´</div>
                <div class="stat-label" style="color: #742a2a;">ç©ºå•äºæŸ</div>
                <div class="stat-value" id="shortLossCount" style="color: #742a2a; font-size: 42px; font-weight: 800;">0</div>
                <div class="stat-subvalue" style="color: #742a2a;">å®æ—¶ç»Ÿè®¡</div>
            </div>
        </div>

        <!-- ä¸‹è·Œå¼ºåº¦åˆ†çº§æ˜¾ç¤º -->
        <div class="card" style="margin-bottom: 30px; border: 3px solid #667eea; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span>ğŸ“‰</span>
                    å¸‚åœºä¸‹è·Œå¼ºåº¦åˆ†æ
                </div>
            </div>
            <div style="padding: 30px;">
                <div id="declineStrengthDisplay" style="text-align: center;">
                    <div style="font-size: 48px; font-weight: 800; margin-bottom: 15px;" id="strengthLevel">
                        --
                    </div>
                    <div style="font-size: 24px; font-weight: 600; margin-bottom: 10px;" id="strengthTitle">
                        æ­£åœ¨è®¡ç®—...
                    </div>
                    <div style="font-size: 18px; color: #4a5568; font-weight: 500;" id="strengthSuggestion">
                        --
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                        <div style="font-size: 14px; color: #4a5568; line-height: 1.8;">
                            <strong>ç»Ÿè®¡æ•°æ®ï¼š</strong><br>
                            ç©ºå•ç›ˆåˆ©â‰¥100%: <strong id="stat100">--</strong> ä¸ª | 
                            â‰¥90%: <strong id="stat90">--</strong> ä¸ª | 
                            â‰¥80%: <strong id="stat80">--</strong> ä¸ª | 
                            â‰¥70%: <strong id="stat70">--</strong> ä¸ª | 
                            â‰¥60%: <strong id="stat60">--</strong> ä¸ª | 
                            â‰¥50%: <strong id="stat50">--</strong> ä¸ª | 
                            â‰¥40%: <strong id="stat40">--</strong> ä¸ª
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-label">æ€»ç›‘æ§æ¬¡æ•°</div>
                <div class="stat-value" id="totalMonitors">--</div>
                <div class="stat-subvalue">ç´¯è®¡æ£€æµ‹è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ””</div>
                <div class="stat-label">å‘Šè­¦è§¦å‘æ¬¡æ•°</div>
                <div class="stat-value" id="totalAlerts">--</div>
                <div class="stat-subvalue">ç›ˆåˆ© + æ­¢æŸæé†’</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-label">å»ºä»“å¤šå•é¢„è­¦</div>
                <div class="stat-value" id="profitTarget">--</div>
                <div class="stat-subvalue">åšç©ºç›ˆåˆ©è¾¾æ ‡æé†’</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-label">å»ºä»“ç©ºå•é¢„è­¦</div>
                <div class="stat-value" id="lossLimit">--</div>
                <div class="stat-subvalue">åšç©ºäºæŸè§¦å‘æé†’</div>
            </div>
            <div class="stat-card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <div class="stat-icon">ğŸ”¢</div>
                <div class="stat-label" style="color: #92400e;">å½“å‰è®¡æ¬¡</div>
                <div class="stat-value" id="currentCount" style="color: #b45309; font-size: 48px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #92400e;">æœ€æ–°15åˆ†é’Ÿæ•°æ®</div>
            </div>
        </div>

        <!-- ç©ºå•ç›ˆåˆ©åˆ†çº§ç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="border: 2px solid #4c1d95; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);">
                <div class="stat-icon">ğŸ‘‘</div>
                <div class="stat-label" style="color: #4c1d95;">ç©ºå•ç›ˆåˆ©â‰¥110%</div>
                <div class="stat-value" id="profit110Plus" style="color: #4c1d95; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #4c1d95;" id="profit110Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #6b21a8; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);">
                <div class="stat-icon">â­</div>
                <div class="stat-label" style="color: #6b21a8;">ç©ºå•ç›ˆåˆ©â‰¥100%</div>
                <div class="stat-value" id="profit100Plus" style="color: #6b21a8; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #6b21a8;" id="profit100Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #7c2d12; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <div class="stat-icon">ğŸŒŸ</div>
                <div class="stat-label" style="color: #7c2d12;">ç©ºå•ç›ˆåˆ©â‰¥90%</div>
                <div class="stat-value" id="profit90Plus" style="color: #7c2d12; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #7c2d12;" id="profit90Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #b91c1c; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="stat-icon">ğŸ’</div>
                <div class="stat-label" style="color: #991b1b;">ç©ºå•ç›ˆåˆ©â‰¥80%</div>
                <div class="stat-value" id="profit80Plus" style="color: #b91c1c; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #991b1b;" id="profit80Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="stat-icon">ğŸ”¥</div>
                <div class="stat-label" style="color: #991b1b;">ç©ºå•ç›ˆåˆ©â‰¥70%</div>
                <div class="stat-value" id="profit70Plus" style="color: #dc2626; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #991b1b;" id="profit70Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #ea580c; background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);">
                <div class="stat-icon">âš¡</div>
                <div class="stat-label" style="color: #9a3412;">ç©ºå•ç›ˆåˆ©â‰¥60%</div>
                <div class="stat-value" id="profit60Plus" style="color: #ea580c; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #9a3412;" id="profit60Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <div class="stat-icon">ğŸ’«</div>
                <div class="stat-label" style="color: #92400e;">ç©ºå•ç›ˆåˆ©â‰¥50%</div>
                <div class="stat-value" id="profit50Plus" style="color: #f59e0b; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #92400e;" id="profit50Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #10b981; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                <div class="stat-icon">âœ¨</div>
                <div class="stat-label" style="color: #065f46;">ç©ºå•ç›ˆåˆ©â‰¥40%</div>
                <div class="stat-value" id="profit40Plus" style="color: #10b981; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #065f46;" id="profit40Increase">1å°æ—¶å†…: --</div>
            </div>
        </div>

        <!-- ç©ºå•ä½ç›ˆåˆ©/äºæŸç»Ÿè®¡ -->
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="border: 2px solid #8b5cf6; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);">
                <div class="stat-icon">ğŸ“‰</div>
                <div class="stat-label" style="color: #5b21b6;">ç©ºå•ç›ˆåˆ©â‰¤20%</div>
                <div class="stat-value" id="profitBelow20" style="color: #8b5cf6; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #5b21b6;" id="profitBelow20Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #6366f1; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-label" style="color: #3730a3;">ç©ºå•ç›ˆåˆ©â‰¤10%</div>
                <div class="stat-value" id="profitBelow10" style="color: #6366f1; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #3730a3;" id="profitBelow10Increase">1å°æ—¶å†…: --</div>
            </div>
            <div class="stat-card" style="border: 2px solid #ef4444; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="stat-icon">âŒ</div>
                <div class="stat-label" style="color: #991b1b;">ç©ºå•äºæŸ</div>
                <div class="stat-value" id="lossCount" style="color: #ef4444; font-size: 42px; font-weight: 800;">--</div>
                <div class="stat-subvalue" style="color: #991b1b;" id="lossCountIncrease">1å°æ—¶å†…: --</div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-grid">
            <!-- æ”¶ç›Šç‡è¶‹åŠ¿å›¾ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ“ˆ</span>
                        æ”¶ç›Šç‡è¶‹åŠ¿
                    </div>
                </div>
                <div class="chart-container" id="profitChart"></div>
            </div>

            <!-- æœ€æ–°å‘Šè­¦ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ””</span>
                        æœ€æ–°å‘Šè­¦
                    </div>
                </div>
                <div class="alert-list" id="alertList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å½“å‰é¢„è­¦ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>âš ï¸</span>
                        å½“å‰é¢„è­¦ (äºæŸ >= -8%)
                    </div>
                    <div class="update-time" id="warningsUpdateTime" style="font-size: 14px; color: #718096;">
                        æœ€åæ›´æ–°: --
                    </div>
                </div>
                <div class="table-container">
                    <table id="warningsTable">
                        <thead>
                            <tr>
                                <th>å¸ç§</th>
                                <th>æ–¹å‘</th>
                                <th>å¼€ä»“ä»·</th>
                                <th>å½“å‰ä»·</th>
                                <th>ç›ˆäºç‡</th>
                                <th>æŒä»“é‡</th>
                                <th>é¢„è­¦çº§åˆ«</th>
                                <th>é¢„è­¦æ¶ˆæ¯</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="warningsBody">
                            <tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å†å²æå€¼è®°å½• -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ†</span>
                    å†å²æå€¼è®°å½•
                    <span id="hourlyStats" style="margin-left: 20px; font-size: 13px; font-weight: normal; color: #718096;">
                        <!-- 1å°æ—¶ç»Ÿè®¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </span>
                </div>
            </div>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>ç±»å‹</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>æŒä»“é‡</th>
                            <th>å¼€ä»“ä»·</th>
                            <th>æ ‡è®°ä»·</th>
                            <th>æ—¶é—´</th>
                            <th>æŒç»­æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr><td colspan="10" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ä¸‹è·Œå¼ºåº¦åˆ†ç±» -->
        <div class="card" id="declineStrengthCard">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ“‰</span>
                    å¸‚åœºä¸‹è·Œå¼ºåº¦åˆ†æ
                </div>
            </div>
            <div style="padding: 25px;">
                <div id="strengthDisplay" style="display: flex; align-items: center; justify-content: space-between; padding: 20px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="font-size: 48px;" id="strengthIcon">ğŸ“Š</div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700; color: white; margin-bottom: 5px;" id="strengthName">åŠ è½½ä¸­...</div>
                            <div style="font-size: 16px; font-weight: 600; color: rgba(255,255,255,0.9);" id="strengthSuggestion">--</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: white;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ç©ºå•ç›ˆåˆ©ç»Ÿè®¡</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                            <div>â‰¥70%: <span id="count70" style="font-weight: 700;">0</span></div>
                            <div>â‰¥60%: <span id="count60" style="font-weight: 700;">0</span></div>
                            <div>â‰¥50%: <span id="count50" style="font-weight: 700;">0</span></div>
                            <div>â‰¥40%: <span id="count40" style="font-weight: 700;">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å½“å‰æŒä»“æƒ…å†µ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ’¼</span>
                    å½“å‰æŒä»“æƒ…å†µ
                    <span id="positionStats" style="margin-left: 15px; font-size: 16px; font-weight: 600; color: #4299e1;">
                        <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="font-size: 13px; color: #718096; display: flex; align-items: center; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="autoMaintainLong" style="margin-right: 5px; cursor: pointer; width: 16px; height: 16px;">
                            <span>ğŸŸ¢ è‡ªåŠ¨ç»´æŠ¤å¤šå•-10%</span>
                        </label>
                        <label style="font-size: 13px; color: #718096; display: flex; align-items: center; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="autoMaintainShort" style="margin-right: 5px; cursor: pointer; width: 16px; height: 16px;">
                            <span>ğŸ”´ è‡ªåŠ¨ç»´æŠ¤ç©ºå•-10%</span>
                        </label>
                        <label style="font-size: 13px; color: #ff6b35; display: flex; align-items: center; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="superMaintainLong" style="margin-right: 5px; cursor: pointer; width: 16px; height: 16px;">
                            <span>ğŸš€ è¶…çº§ç»´æŠ¤å¤šå•-10%</span>
                        </label>
                        <label style="font-size: 13px; color: #ff6b35; display: flex; align-items: center; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="superMaintainShort" style="margin-right: 5px; cursor: pointer; width: 16px; height: 16px;">
                            <span>ğŸš€ è¶…çº§ç»´æŠ¤ç©ºå•-10%</span>
                        </label>
                    </div>
                    <div class="update-time" id="currentPositionTime" style="font-size: 14px; color: #718096;">
                        æœ€åæ›´æ–°: --
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table id="currentPositionTable">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>æŒä»“é‡</th>
                            <th>å¼€ä»“å‡ä»·</th>
                            <th>æ ‡è®°ä»·æ ¼</th>
                            <th>æ æ†</th>
                            <th>æœªå®ç°ç›ˆäº</th>
                            <th>ä¿è¯é‡‘</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>ä»Šæ—¥ç»´æŠ¤</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="currentPositionBody">
                        <tr><td colspan="13" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å­è´¦æˆ·æŒä»“æƒ…å†µ -->
        <div class="card" style="border: 2px solid #667eea;">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span>ğŸ‘¥</span>
                    å­è´¦æˆ·æŒä»“æƒ…å†µ
                    <span id="subAccountStats" style="margin-left: 15px; font-size: 14px; font-weight: normal; opacity: 0.9;">
                        <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="font-size: 13px; color: white; display: flex; align-items: center; cursor: pointer; user-select: none; opacity: 0.9;">
                            <input type="checkbox" id="subSuperMaintainLong" style="margin-right: 5px; cursor: pointer; width: 16px; height: 16px;">
                            <span>ğŸš€ è¶…çº§ç»´æŠ¤å¤šå•-10%</span>
                        </label>
                        <label style="font-size: 13px; color: white; display: flex; align-items: center; cursor: pointer; user-select: none; opacity: 0.9;">
                            <input type="checkbox" id="subSuperMaintainShort" style="margin-right: 5px; cursor: pointer; width: 16px; height: 16px;">
                            <span>ğŸš€ è¶…çº§ç»´æŠ¤ç©ºå•-10%</span>
                        </label>
                    </div>
                    <button id="closeAllSubAccountPositions" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'">
                        ğŸš¨ ä¸€é”®å…¨éƒ¨å¹³ä»“
                    </button>
                    <div style="font-size: 13px; opacity: 0.9;">
                        è´¦æˆ·æ•°é‡: <strong id="subAccountCount">--</strong>
                    </div>
                    <div class="update-time" id="subAccountPositionTime" style="font-size: 14px; opacity: 0.9; color: white;">
                        æœ€åæ›´æ–°: --
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table id="subAccountPositionTable" style="width: 100%; table-layout: fixed;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #000;">
                            <th style="color: #000; width: 7%;">è´¦æˆ·å</th>
                            <th style="color: #000; width: 4%;">ç¼–å·</th>
                            <th style="color: #000; width: 10%;">å¸ç§</th>
                            <th style="color: #000; width: 5%;">æ–¹å‘</th>
                            <th style="color: #000; width: 7%;">æŒä»“é‡</th>
                            <th style="color: #000; width: 8%;">å¼€ä»“å‡ä»·</th>
                            <th style="color: #000; width: 8%;">æ ‡è®°ä»·æ ¼</th>
                            <th style="color: #000; width: 4%;">æ æ†</th>
                            <th style="color: #000; width: 10%;">æœªå®ç°ç›ˆäº</th>
                            <th style="color: #000; width: 9%;">ä¿è¯é‡‘</th>
                            <th style="color: #000; width: 7%;">æ”¶ç›Šç‡</th>
                            <th style="color: #000; width: 7%;">ä»Šæ—¥ç»´æŠ¤</th>
                            <th style="color: #000; width: 5%;">æ¸…é›¶</th>
                            <th style="color: #000; width: 6%;">çŠ¶æ€</th>
                            <th style="color: #000; width: 8%;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="subAccountPositionBody">
                        <tr><td colspan="16" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>


        <!-- å†å²ç›‘æ§è®°å½• -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ“‹</span>
                    å†å²ç›‘æ§è®°å½•
                </div>
            </div>
            <div class="table-container">
                <table id="monitorTable">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>æŒä»“é‡</th>
                            <th>å¼€ä»“å‡ä»·</th>
                            <th>æ ‡è®°ä»·æ ¼</th>
                            <th>æ æ†</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>å‘Šè­¦ç±»å‹</th>
                            <th>é€šçŸ¥çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="monitorBody">
                        <tr><td colspan="10" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç»´æŠ¤é”šç‚¹å•æˆäº¤è®°å½• -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ”§</span>
                    ç»´æŠ¤é”šç‚¹å•æˆäº¤è®°å½•
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="window.open('/anchor-snapshots', '_blank')" 
                            style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        ğŸ“¸ æŸ¥çœ‹å†å²å¿«ç…§
                    </button>
                    <span style="color: #718096; font-size: 14px;">æœ€è¿‘50æ¡è®°å½•</span>
                </div>
            </div>
            
            <!-- å½“å¤©è´¹ç”¨ç»Ÿè®¡ -->
            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ“Š è´¦æˆ·åç§°</div>
                        <div style="font-size: 24px; font-weight: 800;" id="accountName">JAMESYI</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ’° ä»Šæ—¥æ€»è´¹ç”¨</div>
                        <div style="font-size: 32px; font-weight: 800;" id="todayTotalCost">$0.0000</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ”§ ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°</div>
                        <div style="font-size: 32px; font-weight: 800;" id="todayMaintenanceCount">0</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ“ˆ ä»Šæ—¥å‡€ç›ˆäº</div>
                        <div style="font-size: 32px; font-weight: 800;" id="todayNetProfit">$0.0000</div>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="maintenanceTable">
                    <thead>
                        <tr>
                            <th>è´¦æˆ·</th>
                            <th>æ—¶é—´</th>
                            <th>å¸ç§</th>
                            <th>æ–¹å‘</th>
                            <th>åŸå§‹ä»“ä½</th>
                            <th>å¼€ä»“ç¬”æ•°</th>
                            <th>å¼€ä»“æ€»é‡</th>
                            <th>å¼€ä»“å‡ä»·</th>
                            <th>å¼€ä»“è´¹ç”¨</th>
                            <th>å¹³ä»“ç¬”æ•°</th>
                            <th>å¹³ä»“æ€»é‡</th>
                            <th>å¹³ä»“å‡ä»·</th>
                            <th>å¹³ä»“è´¹ç”¨</th>
                            <th>æ€»è´¹ç”¨</th>
                            <th>æ€»æˆæœ¬</th>
                            <th>è´¹ç‡</th>
                            <th>ç›ˆäº</th>
                            <th>å‡€ç›ˆäº</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="maintenanceBody">
                        <tr><td colspan="19" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å›¾è¡¨
        const profitChart = echarts.init(document.getElementById('profitChart'));

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // åŠ è½½è‡ªåŠ¨ç»´æŠ¤é…ç½®
                const configRes = await fetch('/api/anchor/auto-maintenance-config');
                const configData = await configRes.json();
                
                if (configData.success) {
                    const config = configData.config;
                    document.getElementById('autoMaintainLong').checked = config.auto_maintain_long_enabled || false;
                    document.getElementById('autoMaintainShort').checked = config.auto_maintain_short_enabled || false;
                    document.getElementById('superMaintainLong').checked = config.super_maintain_long_enabled || false;
                    document.getElementById('superMaintainShort').checked = config.super_maintain_short_enabled || false;
                }

                // åŠ è½½å­è´¦æˆ·é…ç½®
                const subConfigRes = await fetch('/api/sub-account/config');
                const subConfigData = await subConfigRes.json();
                
                if (subConfigData.success) {
                    const subConfig = subConfigData.config;
                    document.getElementById('subSuperMaintainLong').checked = subConfig.super_maintain_long_enabled || false;
                    document.getElementById('subSuperMaintainShort').checked = subConfig.super_maintain_short_enabled || false;
                }

                // åŠ è½½çŠ¶æ€
                const statusRes = await fetch('/api/anchor-system/status');
                const statusData = await statusRes.json();
                
                if (statusData.success) {
                    document.getElementById('totalMonitors').textContent = statusData.status.total_monitors;
                    document.getElementById('totalAlerts').textContent = statusData.status.total_alerts;
                    document.getElementById('profitTarget').textContent = '+' + statusData.status.config.profit_target + '%';
                    document.getElementById('lossLimit').textContent = statusData.status.config.loss_limit + '%';
                }

                // åŠ è½½æœ€æ–°è®¡æ¬¡æ•°æ®
                const countRes = await fetch('/api/latest');
                const countData = await countRes.json();
                
                if (countData && countData.count !== undefined) {
                    document.getElementById('currentCount').textContent = countData.count;
                    console.log('âœ… è®¡æ¬¡æ•°æ®åŠ è½½:', countData.count);
                } else {
                    document.getElementById('currentCount').textContent = '0';
                }

                // åŠ è½½ç›‘æ§è®°å½•
                const monitorsRes = await fetch('/api/anchor-system/monitors?limit=50');
                const monitorsData = await monitorsRes.json();
                
                if (monitorsData.success) {
                    renderMonitorTable(monitorsData.data);
                    renderProfitChart(monitorsData.data);
                }

                // åŠ è½½å‘Šè­¦è®°å½•
                const alertsRes = await fetch('/api/anchor-system/alerts?limit=10');
                const alertsData = await alertsRes.json();
                
                if (alertsData.success) {
                    renderAlerts(alertsData.data);
                }

                // åŠ è½½å†å²æå€¼è®°å½•ï¼ˆå®ç›˜ï¼‰
                const recordsRes = await fetch('/api/anchor-system/profit-records?trade_mode=real');
                const recordsData = await recordsRes.json();
                
                if (recordsData.success) {
                    renderRecordsTable(recordsData.records);
                }

                // åŠ è½½æœ€è¿‘1å°æ—¶çš„æå€¼ç»Ÿè®¡
                const hourlyStatsRes = await fetch('/api/anchor-system/real/hourly-extreme-stats');
                const hourlyStatsData = await hourlyStatsRes.json();
                
                if (hourlyStatsData.success) {
                    renderHourlyStats(hourlyStatsData.stats);
                }

                // åŠ è½½ä¸‹è·Œå¼ºåº¦åˆ†æ
                const strengthRes = await fetch('/api/anchor/decline-strength?trade_mode=real');
                const strengthData = await strengthRes.json();
                
                if (strengthData.success) {
                    renderDeclineStrength(strengthData.data);
                }

                // åŠ è½½å½“å‰æŒä»“æƒ…å†µï¼ˆå®ç›˜æ¨¡å¼ï¼‰
                const positionsRes = await fetch('/api/anchor-system/current-positions?trade_mode=real');
                const positionsData = await positionsRes.json();
                
                if (positionsData.success) {
                    renderCurrentPositions(positionsData.positions);
                    
                    // æ›´æ–°ä¸»è´¦æˆ·ç»Ÿè®¡å¡ç‰‡
                    const mainPositions = positionsData.positions || [];
                    const mainLongCount = mainPositions.filter(p => p.pos_side === 'long').length;
                    const mainShortCount = mainPositions.filter(p => p.pos_side === 'short').length;
                    const mainTotalCount = mainPositions.length;
                    const mainTotalUpl = mainPositions.reduce((sum, p) => sum + (p.upl || 0), 0);
                    const mainTotalMargin = mainPositions.reduce((sum, p) => sum + (p.margin || 0), 0);
                    const mainAvgProfitRate = mainTotalMargin > 0 ? (mainTotalUpl / mainTotalMargin * 100) : 0;
                    
                    document.getElementById('mainAccountTotalPositions').textContent = mainTotalCount;
                    document.getElementById('mainAccountPositionDetail').textContent = `å¤šå•: ${mainLongCount} | ç©ºå•: ${mainShortCount}`;
                    
                    // å¦‚æœå°‘äº22ä¸ªï¼Œæ˜¾ç¤ºä¸ºçº¢è‰²è­¦å‘Š
                    const mainCard = document.getElementById('mainAccountTotalPositions').closest('.stat-card');
                    if (mainTotalCount < 22) {
                        mainCard.style.border = '2px solid #fc8181';
                        mainCard.style.background = 'linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%)';
                        document.getElementById('mainAccountTotalPositions').style.color = '#742a2a';
                        document.getElementById('mainAccountPositionDetail').style.color = '#742a2a';
                        const label = mainCard.querySelector('.stat-label');
                        label.style.color = '#742a2a';
                        label.innerHTML = 'âš ï¸ ä¸»è´¦æˆ·æ€»æŒä»“';
                    }
                }

                // åŠ è½½å­è´¦æˆ·æŒä»“
                const subAccountRes = await fetch('/api/anchor-system/sub-account-positions');
                const subAccountData = await subAccountRes.json();
                
                if (subAccountData.success) {
                    renderSubAccountPositions(subAccountData.positions);
                    
                    // æ›´æ–°å­è´¦æˆ·ç»Ÿè®¡å¡ç‰‡
                    const subPositions = subAccountData.positions || [];
                    const subAccounts = new Set(subPositions.map(p => p.account_name));
                    const subTotalCount = subPositions.length;
                    const subAccountCount = subAccounts.size;
                    
                    document.getElementById('subAccountTotalPositions').textContent = subTotalCount;
                    document.getElementById('subAccountPositionDetail').textContent = `è´¦æˆ·æ•°: ${subAccountCount} | æŒä»“: ${subTotalCount}`;
                    
                    // æ›´æ–°æ€»ç›ˆäºå¡ç‰‡ï¼ˆåˆå¹¶ä¸»è´¦æˆ·å’Œå­è´¦æˆ·ï¼‰
                    const mainPositions = positionsData.success ? (positionsData.positions || []) : [];
                    const allPositions = [...mainPositions, ...subPositions];
                    const totalUpl = allPositions.reduce((sum, p) => sum + (p.upl || 0), 0);
                    const totalMargin = allPositions.reduce((sum, p) => sum + (p.margin || 0), 0);
                    const avgProfitRate = totalMargin > 0 ? (totalUpl / totalMargin * 100) : 0;
                    
                    const uplColor = totalUpl >= 0 ? '#22543d' : '#742a2a';
                    const rateColor = avgProfitRate >= 0 ? '#22543d' : '#742a2a';
                    
                    document.getElementById('totalProfitLoss').textContent = `${totalUpl >= 0 ? '+' : ''}${totalUpl.toFixed(2)}`;
                    document.getElementById('totalProfitLoss').style.color = uplColor;
                    document.getElementById('totalProfitLossDetail').textContent = `å¹³å‡æ”¶ç›Šç‡: ${avgProfitRate >= 0 ? '+' : ''}${avgProfitRate.toFixed(2)}%`;
                    document.getElementById('totalProfitLossDetail').style.color = rateColor;
                    
                    // æ›´æ–°å­è´¦æˆ·æ—¶é—´
                    const now = new Date();
                    document.getElementById('subAccountPositionTime').textContent = 
                        `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
                }

                // åŠ è½½å½“å‰é¢„è­¦ï¼ˆå®ç›˜æ¨¡å¼ï¼‰
                const warningsRes = await fetch('/api/anchor-system/warnings?trade_mode=real');
                const warningsData = await warningsRes.json();
                
                console.log('ğŸš¨ é¢„è­¦æ•°æ®åŠ è½½:', warningsData);
                
                if (warningsData.success) {
                    renderWarnings(warningsData.warnings);
                }

                // åŠ è½½ç»´æŠ¤é”šç‚¹å•æˆäº¤è®°å½•
                const maintenanceRes = await fetch('/api/anchor/maintenance-orders?limit=50');
                const maintenanceData = await maintenanceRes.json();
                
                if (maintenanceData.success) {
                    maintenanceRecordsData = maintenanceData.data;  // ä¿å­˜åˆ°å…¨å±€å˜é‡
                    renderMaintenanceOrders(maintenanceData.data);
                }

                // åŠ è½½ä»Šæ—¥ç»´æŠ¤ç»Ÿè®¡
                const todayStatsRes = await fetch('/api/anchor-system/today-statistics?trade_mode=real');
                const todayStatsData = await todayStatsRes.json();
                
                if (todayStatsData.success) {
                    const stats = todayStatsData.statistics;
                    
                    // åŠ è½½ç©ºå•ç›ˆåˆ©ç»Ÿè®¡ï¼ˆä»å¿«ç…§æ•°æ®åº“è·å–æœ€æ–°å€¼ï¼‰
                    try {
                        const now = new Date();
                        const startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().slice(0, 19).replace('T', ' ');
                        const endTime = now.toISOString().slice(0, 19).replace('T', ' ');
                        
                        const shortStatsRes = await fetch(`/api/anchor/snapshots/statistics?start_time=${encodeURIComponent(startTime)}&end_time=${encodeURIComponent(endTime)}&limit=200`);
                        const shortStatsData = await shortStatsRes.json();
                        
                        if (shortStatsData.success && shortStatsData.snapshots && shortStatsData.snapshots.length > 0) {
                            // è·å–æœ€æ–°çš„å„é¡¹ç»Ÿè®¡
                            const latestStats = {};
                            
                            // æŒ‰ç±»å‹åˆ†ç»„ï¼Œå–æœ€æ–°å€¼
                            shortStatsData.snapshots.forEach(snap => {
                                if (!latestStats[snap.stat_type] || snap.snapshot_time > latestStats[snap.stat_type].snapshot_time) {
                                    latestStats[snap.stat_type] = snap;
                                }
                            });
                            
                            // æ›´æ–°ç©ºå•ç›ˆåˆ©åˆ†çº§
                            if (latestStats['short_profit_lte_20']) {
                                document.getElementById('todayProfitBelow20').textContent = latestStats['short_profit_lte_20'].stat_value || 0;
                            }
                            
                            if (latestStats['short_profit_lte_10']) {
                                document.getElementById('todayProfitBelow10').textContent = latestStats['short_profit_lte_10'].stat_value || 0;
                            }
                            
                            if (latestStats['short_loss']) {
                                document.getElementById('todayLossCount').textContent = latestStats['short_loss'].stat_value || 0;
                            }
                            
                            // æ›´æ–°å†å²æå€¼ç»Ÿè®¡
                            if (latestStats['long_profit_count']) {
                                document.getElementById('longProfitCount').textContent = latestStats['long_profit_count'].stat_value || 0;
                            }
                            
                            if (latestStats['long_loss_count']) {
                                document.getElementById('longLossCount').textContent = latestStats['long_loss_count'].stat_value || 0;
                            }
                            
                            if (latestStats['short_profit_count']) {
                                document.getElementById('shortProfitCount').textContent = latestStats['short_profit_count'].stat_value || 0;
                            }
                            
                            if (latestStats['short_loss_count']) {
                                document.getElementById('shortLossCount').textContent = latestStats['short_loss_count'].stat_value || 0;
                            }
                        } else {
                            // å¦‚æœæ²¡æœ‰å¿«ç…§æ•°æ®ï¼Œè®¾ç½®ä¸º0
                            document.getElementById('todayProfitBelow20').textContent = '0';
                            document.getElementById('todayProfitBelow10').textContent = '0';
                            document.getElementById('todayLossCount').textContent = '0';
                            document.getElementById('longProfitCount').textContent = '0';
                            document.getElementById('longLossCount').textContent = '0';
                            document.getElementById('shortProfitCount').textContent = '0';
                            document.getElementById('shortLossCount').textContent = '0';
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç©ºå•ç›ˆåˆ©ç»Ÿè®¡å¤±è´¥:', error);
                        // è®¾ç½®é»˜è®¤å€¼
                        document.getElementById('todayProfitBelow20').textContent = '0';
                        document.getElementById('todayProfitBelow10').textContent = '0';
                        document.getElementById('todayLossCount').textContent = '0';
                        document.getElementById('longProfitCount').textContent = '0';
                        document.getElementById('longLossCount').textContent = '0';
                        document.getElementById('shortProfitCount').textContent = '0';
                        document.getElementById('shortLossCount').textContent = '0';
                    }
                }

                // æ›´æ–°æ—¶é—´
                const now = new Date();
                document.getElementById('updateTime').textContent = 
                    `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
                document.getElementById('currentPositionTime').textContent = 
                    `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨å½“å‰è®°å½•æ•°æ®
        let currentRecordsData = [];

        // è®¡ç®—æŒç»­æ—¶é—´çš„å‡½æ•°ï¼ˆç‹¬ç«‹æŠ½å–ï¼Œæ–¹ä¾¿å®šæ—¶æ›´æ–°ï¼‰
        function calculateDuration(timestamp) {
            if (!timestamp) return '--';
            
            try {
                const now = new Date();
                const recordTime = new Date(timestamp.replace(' ', 'T') + '+08:00');
                const diffMs = now - recordTime;
                const totalHours = diffMs / (1000 * 60 * 60);
                
                if (totalHours < 0) {
                    return '<span style="color: #718096;">åˆšåˆš</span>';
                }
                
                const hours = Math.floor(totalHours);
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const days = Math.floor(hours / 24);
                const remainHours = hours % 24;
                
                let color, text;
                
                if (hours < 1) {
                    color = '#10b981';
                    text = `${minutes}åˆ†é’Ÿ`;
                } else if (hours < 24) {
                    color = '#3b82f6';
                    text = `${hours}å°æ—¶${minutes}åˆ†`;
                } else if (days === 1) {
                    color = '#f59e0b';
                    text = `${days}å¤©${remainHours}å°æ—¶`;
                } else if (days === 2) {
                    color = '#f97316';
                    text = `${days}å¤©${remainHours}å°æ—¶`;
                } else {
                    color = '#ef4444';
                    text = `${days}å¤©${remainHours}å°æ—¶`;
                }
                
                return `<span style="color: ${color}; font-weight: 600;">${text}</span>`;
            } catch (e) {
                console.error('æ—¶é—´è§£æé”™è¯¯:', e, timestamp);
                return '--';
            }
        }

        // å­˜å‚¨å†å²ç›ˆåˆ©æ•°æ®ç”¨äºè®¡ç®—1å°æ—¶å†…å¢é‡
        let profitHistoryData = {
            profit110: [],
            profit100: [],
            profit90: [],
            profit80: [],
            profit70: [],
            profit60: [],
            profit50: [],
            profit40: [],
            profitBelow20: [],
            profitBelow10: [],
            lossCount: [],
            lastUpdate: null
        };

        // è®¡ç®—ä¸‹è·Œå¼ºåº¦åˆ†çº§
        function calculateDeclineStrength(stats) {
            const { profit100, profit90, profit80, profit70, profit60, profit50, profit40 } = stats;
            
            console.log('ğŸ” calculateDeclineStrength called with:', {
                profit100, profit90, profit80, profit70, profit60, profit50, profit40
            });
            
            let level = 0;
            let title = '';
            let suggestion = '';
            let bgColor = '';
            let icon = '';
            
            // ä¸‹è·Œå¼ºåº¦5çº§ï¼šæç«¯ä¸‹è·Œ
            if (profit100 <= 2 && profit90 <= 6 && profit80 <= 8 && profit70 <= 2 && profit60 <= 5 && profit50 <= 8 && profit40 <= 11) {
                level = 5;
                title = 'ä¸‹è·Œå¼ºåº¦5çº§ - æç«¯ä¸‹è·Œ';
                suggestion = 'å¤šå•ä¹°å…¥ç‚¹åœ¨100%ä»¥ä¸Š';
                bgColor = 'linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%)';
                icon = 'ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥';
            }
            // ä¸‹è·Œå¼ºåº¦4çº§ï¼šè¶…é«˜å¼ºåº¦ä¸‹è·Œ
            else if (profit90 <= 2 && profit80 <= 6 && profit70 <= 8 && profit60 <= 8 && profit50 <= 8 && profit40 <= 11) {
                level = 4;
                title = 'ä¸‹è·Œå¼ºåº¦4çº§ - è¶…é«˜å¼ºåº¦ä¸‹è·Œ';
                suggestion = 'å¤šå•ä¹°å…¥ç‚¹åœ¨90%';
                bgColor = 'linear-gradient(135deg, #991b1b 0%, #b91c1c 100%)';
                icon = 'ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥';
            }
            // ä¸‹è·Œå¼ºåº¦3çº§ï¼šé«˜å¼ºåº¦ä¸‹è·Œ
            else if (profit100 <= 2 && profit90 <= 6 && profit80 <= 8 && profit70 <= 2 && profit60 <= 5 && profit50 <= 8 && profit40 <= 11) {
                level = 3;
                title = 'ä¸‹è·Œå¼ºåº¦3çº§ - é«˜å¼ºåº¦ä¸‹è·Œ';
                suggestion = 'å¤šå•ä¹°å…¥ç‚¹åœ¨70-80%';
                bgColor = 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)';
                icon = 'ğŸ”¥ğŸ”¥ğŸ”¥';
            }
            // ä¸‹è·Œå¼ºåº¦2çº§ï¼šä¸­ç­‰å¼ºåº¦ä¸‹è·Œ
            else if (profit100 >= 0 && profit90 >= 0 && profit80 <= 0 && profit70 === 0 && profit60 <= 1 && profit50 <= 4 && profit40 <= 5) {
                level = 2;
                title = 'ä¸‹è·Œå¼ºåº¦2çº§ - ä¸­ç­‰å¼ºåº¦ä¸‹è·Œ';
                suggestion = 'å¤šå•ä¹°å…¥ç‚¹åœ¨60%';
                bgColor = 'linear-gradient(135deg, #f59e0b 0%, #f97316 100%)';
                icon = 'ğŸ”¥ğŸ”¥';
            }
            // ä¸‹è·Œå¼ºåº¦1çº§ï¼šè½»å¾®ä¸‹è·Œ
            else if (profit100 >= 0 && profit90 >= 0 && profit80 >= 0 && profit70 === 0 && profit60 === 0 && profit50 === 0 && profit40 <= 3) {
                level = 1;
                title = 'ä¸‹è·Œå¼ºåº¦1çº§ - è½»å¾®ä¸‹è·Œ';
                suggestion = 'å¤šå•ä¹°å…¥ç‚¹åœ¨50%';
                bgColor = 'linear-gradient(135deg, #fbbf24 0%, #fcd34d 100%)';
                icon = 'ğŸ”¥';
            }
            // æœªè¾¾åˆ°ä»»ä½•çº§åˆ«
            else {
                level = 0;
                title = 'å¸‚åœºæ­£å¸¸';
                suggestion = 'æš‚æ— æ˜æ˜¾ä¸‹è·Œä¿¡å·';
                bgColor = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                icon = 'âœ…';
            }
            
            console.log('ğŸ“Š ä¸‹è·Œå¼ºåº¦åˆ¤æ–­ç»“æœ:', { level, title, suggestion });
            
            // æ›´æ–°æ˜¾ç¤º
            const levelElement = document.getElementById('strengthLevel');
            const titleElement = document.getElementById('strengthTitle');
            const suggestionElement = document.getElementById('strengthSuggestion');
            const displayElement = document.getElementById('declineStrengthDisplay');
            
            if (levelElement && titleElement && suggestionElement && displayElement) {
                levelElement.textContent = icon;
                levelElement.style.color = level >= 3 ? '#dc2626' : (level >= 2 ? '#f59e0b' : '#10b981');
                titleElement.textContent = title;
                titleElement.style.color = level >= 3 ? '#991b1b' : (level >= 2 ? '#92400e' : '#065f46');
                suggestionElement.textContent = suggestion;
                displayElement.style.background = bgColor;
                displayElement.style.padding = '20px';
                displayElement.style.borderRadius = '15px';
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('stat100').textContent = profit100;
                document.getElementById('stat90').textContent = profit90;
                document.getElementById('stat80').textContent = profit80;
                document.getElementById('stat70').textContent = profit70;
                document.getElementById('stat60').textContent = profit60;
                document.getElementById('stat50').textContent = profit50;
                document.getElementById('stat40').textContent = profit40;
            }
        }

        // ä»…æ›´æ–°æŒç»­æ—¶é—´åˆ—ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼ï¼‰
        function updateDurations() {
            const tbody = document.getElementById('recordsBody');
            if (!tbody || currentRecordsData.length === 0) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (index < currentRecordsData.length) {
                    const item = currentRecordsData[index];
                    const durationCell = row.querySelector('td:nth-child(9)'); // ç¬¬9åˆ—æ˜¯æŒç»­æ—¶é—´
                    if (durationCell && item.timestamp) {
                        durationCell.innerHTML = calculateDuration(item.timestamp);
                    }
                }
            });
            
            console.log('â° æŒç»­æ—¶é—´å·²æ›´æ–°');
        }

        // æ¸²æŸ“1å°æ—¶å†…æå€¼ç»Ÿè®¡
        function renderHourlyStats(stats) {
            const statsElement = document.getElementById('hourlyStats');
            if (!statsElement) return;
            
            // æ„å»ºç»Ÿè®¡ä¿¡æ¯HTML
            const html = `
                <span style="color: #48bb78; margin-right: 10px;">
                    ğŸŸ¢ å¤šå•ç›ˆåˆ©: <strong>${stats.long_max_profit}</strong>
                </span>
                <span style="color: #f56565; margin-right: 10px;">
                    ğŸ”´ å¤šå•äºæŸ: <strong>${stats.long_max_loss}</strong>
                </span>
                <span style="color: #48bb78; margin-right: 10px;">
                    ğŸŸ¢ ç©ºå•ç›ˆåˆ©: <strong>${stats.short_max_profit}</strong>
                </span>
                <span style="color: #f56565;">
                    ğŸ”´ ç©ºå•äºæŸ: <strong>${stats.short_max_loss}</strong>
                </span>
                <span style="color: #a0aec0; margin-left: 10px; font-size: 12px;">
                    (æœ€è¿‘1å°æ—¶å†…åˆ›æ–°é«˜)
                </span>
            `;
            
            statsElement.innerHTML = html;
        }

        // æ¸²æŸ“ä¸‹è·Œå¼ºåº¦åˆ†æ
        function renderDeclineStrength(data) {
            if (!data) return;
            
            const display = document.getElementById('strengthDisplay');
            const icon = document.getElementById('strengthIcon');
            const name = document.getElementById('strengthName');
            const suggestion = document.getElementById('strengthSuggestion');
            const count70 = document.getElementById('count70');
            const count60 = document.getElementById('count60');
            const count50 = document.getElementById('count50');
            const count40 = document.getElementById('count40');
            
            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            if (data.statistics) {
                count70.textContent = data.statistics.profit_70 || 0;
                count60.textContent = data.statistics.profit_60 || 0;
                count50.textContent = data.statistics.profit_50 || 0;
                count40.textContent = data.statistics.profit_40 || 0;
            }
            
            // æ ¹æ®å¼ºåº¦çº§åˆ«è®¾ç½®å›¾æ ‡å’Œé¢œè‰²
            let bgGradient = '';
            let iconEmoji = 'ğŸ“Š';
            
            switch(data.strength_level) {
                case 1:
                    bgGradient = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                    iconEmoji = 'ğŸŸ¢';
                    break;
                case 2:
                    bgGradient = 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
                    iconEmoji = 'ğŸŸ¡';
                    break;
                case 3:
                    bgGradient = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                    iconEmoji = 'ğŸ”´';
                    break;
                case 4:
                    bgGradient = 'linear-gradient(135deg, #9f7aea 0%, #805ad5 100%)';
                    iconEmoji = 'âš ï¸';
                    break;
                default:
                    bgGradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    iconEmoji = 'ğŸ“Š';
            }
            
            // æ›´æ–°æ˜¾ç¤º
            display.style.background = bgGradient;
            icon.textContent = iconEmoji;
            name.textContent = data.strength_name || 'åŠ è½½ä¸­...';
            suggestion.textContent = data.buy_suggestion || '--';
        }

        // æ¸²æŸ“å†å²æå€¼è®°å½•è¡¨
        function renderRecordsTable(data) {
            currentRecordsData = data; // ä¿å­˜æ•°æ®ä¾›æŒç»­æ—¶é—´æ›´æ–°ä½¿ç”¨
            const tbody = document.getElementById('recordsBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }
            
            // å¸ç§ç¼–å·æ˜ å°„
            const coinNumbers = {
                'CFX-USDT-SWAP': 'NO.1',
                'FIL-USDT-SWAP': 'NO.2',
                'CRO-USDT-SWAP': 'NO.3',
                'UNI-USDT-SWAP': 'NO.4',
                'CRV-USDT-SWAP': 'NO.5',
                'LDO-USDT-SWAP': 'NO.6'
            };
            
            tbody.innerHTML = data.map(item => {
                // è®¡ç®—æŒç»­æ—¶é—´
                const durationHtml = calculateDuration(item.timestamp);
                // è·å–ç¼–å·
                const coinNumber = coinNumbers[item.inst_id] || '--';
                
                return `
                <tr>
                    <td style="font-weight: 700; color: #667eea;">${coinNumber}</td>
                    <td>${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${item.record_type === 'max_profit' ? 'badge-profit' : 'badge-loss'}">
                            ${item.record_type === 'max_profit' ? 'ğŸ† æœ€é«˜ç›ˆåˆ©' : 'ğŸ“‰ æœ€å¤§äºæŸ'}
                        </span>
                    </td>
                    <td style="color: ${(item.profit_rate || 0) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 16px;">
                        ${(item.profit_rate || 0) >= 0 ? '+' : ''}${(item.profit_rate || 0).toFixed(2)}%
                    </td>
                    <td>${Math.abs(item.pos_size || 0).toFixed(4)}</td>
                    <td>$${(item.avg_price || 0).toFixed(4)}</td>
                    <td>$${(item.mark_price || 0).toFixed(4)}</td>
                    <td>${item.timestamp}</td>
                    <td>${durationHtml}</td>
                </tr>
            `;
            }).join('');
        }

        // æ¸²æŸ“å½“å‰æŒä»“æƒ…å†µ
        function renderCurrentPositions(data) {
            const tbody = document.getElementById('currentPositionBody');
            const statsDiv = document.getElementById('positionStats');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="empty">å½“å‰æ— æŒä»“</td></tr>';
                statsDiv.innerHTML = '';
                // æ¸…ç©ºç›ˆåˆ©ç»Ÿè®¡æ˜¾ç¤º
                document.getElementById('profit110Plus').textContent = '0';
                document.getElementById('profit100Plus').textContent = '0';
                document.getElementById('profit90Plus').textContent = '0';
                document.getElementById('profit80Plus').textContent = '0';
                document.getElementById('profit70Plus').textContent = '0';
                document.getElementById('profit60Plus').textContent = '0';
                document.getElementById('profit50Plus').textContent = '0';
                document.getElementById('profit40Plus').textContent = '0';
                document.getElementById('profitBelow20').textContent = '0';
                document.getElementById('profitBelow10').textContent = '0';
                document.getElementById('lossCount').textContent = '0';
                document.getElementById('profit110Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit100Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit90Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit80Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit70Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit60Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit50Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profit40Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profitBelow20Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('profitBelow10Increase').textContent = '1å°æ—¶å†…: --';
                document.getElementById('lossCountIncrease').textContent = '1å°æ—¶å†…: --';
                return;
            }

            // ç»Ÿè®¡æŒä»“æ€»æ•°
            const longPositions = data.filter(item => item.pos_side === 'long');
            const shortPositions = data.filter(item => item.pos_side === 'short');
            const totalCount = data.length;
            const longCount = longPositions.length;
            const shortCount = shortPositions.length;
            
            // æ›´æ–°æŒä»“ç»Ÿè®¡æ˜¾ç¤º
            let statsColor = totalCount < 22 ? '#f56565' : '#48bb78';  // å°‘äº22ä¸ªç”¨çº¢è‰²ï¼Œå¦åˆ™ç”¨ç»¿è‰²
            let warningIcon = totalCount < 22 ? 'âš ï¸ ' : '';
            statsDiv.innerHTML = `
                ${warningIcon}æ€»è®¡: <span style="color: ${statsColor}; font-weight: 700;">${totalCount}</span> ä¸ª
                <span style="margin-left: 10px; color: #48bb78;">å¤šå•: ${longCount}</span>
                <span style="margin-left: 10px; color: #f56565;">ç©ºå•: ${shortCount}</span>
            `;

            // ç»Ÿè®¡åšç©ºæŒä»“å„ç›ˆåˆ©çº§åˆ«
            const profit110 = shortPositions.filter(item => item.profit_rate >= 110).length;
            const profit100 = shortPositions.filter(item => item.profit_rate >= 100).length;
            const profit90 = shortPositions.filter(item => item.profit_rate >= 90).length;
            const profit80 = shortPositions.filter(item => item.profit_rate >= 80).length;
            const profit70 = shortPositions.filter(item => item.profit_rate >= 70).length;
            const profit60 = shortPositions.filter(item => item.profit_rate >= 60).length;
            const profit50 = shortPositions.filter(item => item.profit_rate >= 50).length;
            const profit40 = shortPositions.filter(item => item.profit_rate >= 40).length;
            const profitBelow20 = shortPositions.filter(item => item.profit_rate > 0 && item.profit_rate <= 20).length;
            const profitBelow10 = shortPositions.filter(item => item.profit_rate > 0 && item.profit_rate <= 10).length;
            const lossCount = shortPositions.filter(item => item.profit_rate < 0).length;
            const lossBelow10 = shortPositions.filter(item => item.profit_rate <= -10).length;
            
            // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
            document.getElementById('profit110Plus').textContent = profit110;
            document.getElementById('profit100Plus').textContent = profit100;
            document.getElementById('profit90Plus').textContent = profit90;
            document.getElementById('profit80Plus').textContent = profit80;
            document.getElementById('profit70Plus').textContent = profit70;
            document.getElementById('profit60Plus').textContent = profit60;
            document.getElementById('profit50Plus').textContent = profit50;
            document.getElementById('profit40Plus').textContent = profit40;
            document.getElementById('profitBelow20').textContent = profitBelow20;
            document.getElementById('profitBelow10').textContent = profitBelow10;
            document.getElementById('lossCount').textContent = lossCount;
            
            // è®¡ç®—1å°æ—¶å†…å¢é‡
            const now = Date.now();
            const oneHourAgo = now - 60 * 60 * 1000;
            
            // ä¿å­˜å½“å‰æ•°æ®åˆ°å†å²
            if (!profitHistoryData.lastUpdate || now - profitHistoryData.lastUpdate > 60000) {
                // æ¯åˆ†é’Ÿè®°å½•ä¸€æ¬¡
                profitHistoryData.profit110.push({ time: now, count: profit110 });
                profitHistoryData.profit100.push({ time: now, count: profit100 });
                profitHistoryData.profit90.push({ time: now, count: profit90 });
                profitHistoryData.profit80.push({ time: now, count: profit80 });
                profitHistoryData.profit70.push({ time: now, count: profit70 });
                profitHistoryData.profit60.push({ time: now, count: profit60 });
                profitHistoryData.profit50.push({ time: now, count: profit50 });
                profitHistoryData.profit40.push({ time: now, count: profit40 });
                profitHistoryData.profitBelow20.push({ time: now, count: profitBelow20 });
                profitHistoryData.profitBelow10.push({ time: now, count: profitBelow10 });
                profitHistoryData.lossCount.push({ time: now, count: lossCount });
                profitHistoryData.lastUpdate = now;
                
                // æ¸…ç†è¶…è¿‡1å°æ—¶çš„æ•°æ®
                profitHistoryData.profit110 = profitHistoryData.profit110.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit100 = profitHistoryData.profit100.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit90 = profitHistoryData.profit90.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit80 = profitHistoryData.profit80.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit70 = profitHistoryData.profit70.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit60 = profitHistoryData.profit60.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit50 = profitHistoryData.profit50.filter(d => d.time > oneHourAgo);
                profitHistoryData.profit40 = profitHistoryData.profit40.filter(d => d.time > oneHourAgo);
                profitHistoryData.profitBelow20 = profitHistoryData.profitBelow20.filter(d => d.time > oneHourAgo);
                profitHistoryData.profitBelow10 = profitHistoryData.profitBelow10.filter(d => d.time > oneHourAgo);
                profitHistoryData.lossCount = profitHistoryData.lossCount.filter(d => d.time > oneHourAgo);
            }
            
            // è®¡ç®—å¢é‡
            function calcIncrease(historyArray, currentCount) {
                if (historyArray.length < 2) return '--';
                const oldestData = historyArray[0];
                const increase = currentCount - oldestData.count;
                if (increase > 0) {
                    return `+${increase}`;
                } else if (increase < 0) {
                    return `${increase}`;
                } else {
                    return '0';
                }
            }
            
            document.getElementById('profit110Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit110, profit110)}`;
            document.getElementById('profit100Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit100, profit100)}`;
            document.getElementById('profit90Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit90, profit90)}`;
            document.getElementById('profit80Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit80, profit80)}`;
            document.getElementById('profit70Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit70, profit70)}`;
            document.getElementById('profit60Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit60, profit60)}`;
            document.getElementById('profit50Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit50, profit50)}`;
            document.getElementById('profit40Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profit40, profit40)}`;
            document.getElementById('profitBelow20Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profitBelow20, profitBelow20)}`;
            document.getElementById('profitBelow10Increase').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.profitBelow10, profitBelow10)}`;
            document.getElementById('lossCountIncrease').textContent = `1å°æ—¶å†…: ${calcIncrease(profitHistoryData.lossCount, lossCount)}`;
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºä¸‹è·Œå¼ºåº¦
            calculateDeclineStrength({
                profit100,
                profit90,
                profit80,
                profit70,
                profit60,
                profit50,
                profit40
            });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            statsDiv.innerHTML = `
                <span style="display: inline-flex; align-items: center; gap: 15px;">
                    <span style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
                                 color: white; 
                                 padding: 4px 12px; 
                                 border-radius: 12px; 
                                 font-size: 13px;
                                 font-weight: 600;
                                 box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);">
                        ğŸ¯ ç›ˆåˆ©â‰¥40%: ${profit40}
                    </span>
                    <span style="background: linear-gradient(135deg, ${lossBelow10 > 0 ? '#f56565' : '#a0aec0'} 0%, ${lossBelow10 > 0 ? '#e53e3e' : '#718096'} 100%); 
                                 color: white; 
                                 padding: 4px 12px; 
                                 border-radius: 12px; 
                                 font-size: 13px;
                                 font-weight: 600;
                                 box-shadow: 0 2px 4px ${lossBelow10 > 0 ? 'rgba(245, 101, 101, 0.3)' : 'rgba(160, 174, 192, 0.3)'};">
                        âš ï¸ äºæŸâ‰¤-10%: ${lossBelow10}
                    </span>
                </span>
            `;

            // è°ƒè¯•æ—¥å¿—
            console.log('ğŸ” æ¸²æŸ“å½“å‰æŒä»“æ•°æ®:', data);
            console.log('ğŸ“Š åšç©ºç»Ÿè®¡: â‰¥70%:', profit70, 'â‰¥60%:', profit60, 'â‰¥50%:', profit50, 'â‰¥40%:', profit40, 
                        'â‰¤20%:', profitBelow20, 'â‰¤10%:', profitBelow10, 'äºæŸ:', lossCount, 'â‰¤-10%:', lossBelow10);
            if (data.length > 0) {
                console.log('ğŸ“Š ç¬¬ä¸€æ¡æ•°æ® pos_size:', data[0].pos_size, 'type:', typeof data[0].pos_size);
            }

            // å¸ç§ç¼–å·æ˜ å°„
            const coinNumbers = {
                'CFX-USDT-SWAP': 'NO.1',
                'FIL-USDT-SWAP': 'NO.2',
                'CRO-USDT-SWAP': 'NO.3',
                'UNI-USDT-SWAP': 'NO.4',
                'CRV-USDT-SWAP': 'NO.5',
                'LDO-USDT-SWAP': 'NO.6'
            };
            
            tbody.innerHTML = data.map(item => {
                const coinNumber = coinNumbers[item.inst_id] || '--';
                return `
                <tr>
                    <td style="font-weight: 700; color: #667eea;">${coinNumber}</td>
                    <td style="font-weight: 600;">${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>${(item.pos_size || 0).toFixed(4)}</td>
                    <td>$${item.avg_price.toFixed(4)}</td>
                    <td>$${item.mark_price.toFixed(4)}</td>
                    <td>${item.lever}x</td>
                    <td style="color: ${item.upl >= 0 ? '#48bb78' : '#f56565'}; font-weight: 600;">
                        ${item.upl >= 0 ? '+' : ''}${item.upl.toFixed(4)} USDT
                    </td>
                    <td>${item.margin.toFixed(4)} USDT</td>
                    <td style="color: ${item.profit_rate >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 16px;">
                        ${item.profit_rate >= 0 ? '+' : ''}${item.profit_rate.toFixed(2)}%
                    </td>
                    <td>
                        <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 13px;
                                     background: ${(item.maintenance_count_today || 0) > 0 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e2e8f0'};
                                     color: ${(item.maintenance_count_today || 0) > 0 ? 'white' : '#718096'};
                                     box-shadow: ${(item.maintenance_count_today || 0) > 0 ? '0 2px 4px rgba(102, 126, 234, 0.3)' : 'none'};">
                            ${(item.maintenance_count_today || 0)}æ¬¡
                        </span>
                    </td>
                    <td style="text-align: center;">
                        ${(item.maintenance_count_today || 0) > 0 ? `
                            <button class="btn-reset-maintenance-sub" 
                                    onclick="resetSubAccountMaintenance('${item.account_name}', '${item.inst_id}', '${item.pos_side}')"
                                    title="æ¸…é›¶ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°"
                                    style="background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
                                           color: white;
                                           border: none;
                                           padding: 4px 10px;
                                           border-radius: 6px;
                                           cursor: pointer;
                                           font-size: 11px;
                                           font-weight: 600;
                                           transition: all 0.3s;
                                           box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3);"
                                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(245, 101, 101, 0.4)';"
                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(245, 101, 101, 0.3)';">
                                ğŸ”„ æ¸…é›¶
                            </button>
                        ` : '-'}
                    </td>
                    <td>
                        <span class="badge ${
                            item.status_class === 'profit' ? 'badge-profit' : 
                            item.status_class === 'loss' ? 'badge-loss' : 
                            'badge-normal'
                        }">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn-maintain-anchor" 
                                onclick="maintainAnchor('${item.inst_id}', '${item.pos_side}', ${item.pos_size})"
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                       color: white;
                                       border: none;
                                       padding: 6px 12px;
                                       border-radius: 6px;
                                       cursor: pointer;
                                       font-size: 12px;
                                       font-weight: 600;
                                       transition: all 0.3s;
                                       box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
                            ğŸ”§ ç»´æŠ¤é”šç‚¹å•
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // æ¸²æŸ“é¢„è­¦è¡¨
        function renderWarnings(data) {
            const tbody = document.getElementById('warningsBody');
            const updateTime = document.getElementById('warningsUpdateTime');
            
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            updateTime.textContent = `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty">âœ… å½“å‰æ— é¢„è­¦</td></tr>';
                return;
            }

            console.log('âš ï¸ æ¸²æŸ“é¢„è­¦æ•°æ®:', data);

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td style="font-weight: 600;">${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>$${item.open_price.toFixed(4)}</td>
                    <td>$${item.current_price.toFixed(4)}</td>
                    <td>
                        <span class="profit-rate ${
                            item.warning_level === 'critical' ? 'critical-level' : 
                            item.warning_level === 'warning' ? 'warning-level' : ''
                        }">
                            ${item.profit_rate.toFixed(2)}%
                        </span>
                    </td>
                    <td>${item.open_size.toFixed(4)}</td>
                    <td>
                        <span class="warning-badge ${item.warning_level}">
                            ${item.warning_level === 'critical' ? 'ğŸ”´ ä¸´ç•Œ' : 
                              item.warning_level === 'warning' ? 'ğŸŸ¡ é¢„è­¦' : 
                              'ğŸ”µ ä¿¡æ¯'}
                        </span>
                    </td>
                    <td style="max-width: 300px; white-space: normal;">${item.alert_message}</td>
                    <td style="font-size: 12px; color: #718096;">${item.created_at}</td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“å­è´¦æˆ·æŒä»“
        function renderSubAccountPositions(data) {
            const tbody = document.getElementById('subAccountPositionBody');
            const statsSpan = document.getElementById('subAccountStats');
            const accountCountSpan = document.getElementById('subAccountCount');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="empty">æš‚æ— å­è´¦æˆ·æŒä»“</td></tr>';
                statsSpan.innerHTML = '';
                accountCountSpan.textContent = '0';
                return;
            }

            // ç»Ÿè®¡è´¦æˆ·æ•°
            const accounts = new Set(data.map(p => p.account_name));
            accountCountSpan.textContent = accounts.size;
            
            // ç»Ÿè®¡æ€»ç›ˆäº
            const totalUpl = data.reduce((sum, p) => sum + (p.upl || 0), 0);
            const totalMargin = data.reduce((sum, p) => sum + (p.margin || 0), 0);
            const avgProfitRate = totalMargin > 0 ? (totalUpl / totalMargin * 100) : 0;
            
            const uplColor = totalUpl >= 0 ? '#48bb78' : '#f56565';
            const rateColor = avgProfitRate >= 0 ? '#48bb78' : '#f56565';
            
            statsSpan.innerHTML = `
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 8px;">
                    æ€»æŒä»“: ${data.length}
                </span>
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 8px;">
                    æ€»ç›ˆäº: <strong style="color: ${uplColor};">${totalUpl >= 0 ? '+' : ''}$${totalUpl.toFixed(2)}</strong>
                </span>
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 8px;">
                    å¹³å‡æ”¶ç›Šç‡: <strong style="color: ${rateColor};">${avgProfitRate >= 0 ? '+' : ''}${avgProfitRate.toFixed(2)}%</strong>
                </span>
            `;

            // å¸ç§ç¼–å·æ˜ å°„
            const coinNumbers = {
                'CFX-USDT-SWAP': 'NO.1',
                'FIL-USDT-SWAP': 'NO.2',
                'CRO-USDT-SWAP': 'NO.3',
                'UNI-USDT-SWAP': 'NO.4',
                'CRV-USDT-SWAP': 'NO.5',
                'LDO-USDT-SWAP': 'NO.6'
            };
            
            tbody.innerHTML = data.map((item, index) => {
                const profitColor = (item.profit_rate || 0) >= 0 ? '#48bb78' : '#f56565';
                const uplColor = (item.upl || 0) >= 0 ? '#48bb78' : '#f56565';
                const coinNumber = coinNumbers[item.inst_id] || '--';
                const maxMaintenanceCount = 3;  // å­è´¦å·æœ€å¤š3æ¬¡ç»´æŠ¤
                const maintenanceCount = item.maintenance_count || 0;
                
                return `
                <tr>
                    <td style="font-weight: 700; font-size: 14px;">${item.account_name}</td>
                    <td style="font-weight: 700;">${coinNumber}</td>
                    <td style="font-weight: 600;">${item.inst_id}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>${Math.abs(item.pos_size || 0).toFixed(4)}</td>
                    <td>$${(item.avg_price || 0).toFixed(4)}</td>
                    <td>$${(item.mark_price || 0).toFixed(4)}</td>
                    <td>${item.leverage}x</td>
                    <td style="color: ${uplColor}; font-weight: 600;">
                        ${(item.upl || 0) >= 0 ? '+' : ''}${(item.upl || 0).toFixed(4)} USDT
                    </td>
                    <td>${(item.margin || 0).toFixed(4)} USDT</td>
                    <td style="color: ${profitColor}; font-weight: 700; font-size: 16px;">
                        ${(item.profit_rate || 0) >= 0 ? '+' : ''}${(item.profit_rate || 0).toFixed(2)}%
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 13px;
                                         background: ${maintenanceCount > 0 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e2e8f0'};
                                         color: ${maintenanceCount > 0 ? 'white' : '#718096'};
                                         box-shadow: ${maintenanceCount > 0 ? '0 2px 4px rgba(102, 126, 234, 0.3)' : 'none'};">
                                ${maintenanceCount}æ¬¡
                            </span>
                            ${maintenanceCount > 0 ? `
                                <button class="btn-reset-maintenance" 
                                        onclick="resetMaintenanceCount('${item.account_name}', '${item.inst_id}', '${item.pos_side}')"
                                        title="æ¸…é›¶ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°"
                                        style="background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
                                               color: white;
                                               border: none;
                                               padding: 4px 8px;
                                               border-radius: 6px;
                                               cursor: pointer;
                                               font-size: 11px;
                                               font-weight: 600;
                                               transition: all 0.3s;
                                               box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3);"
                                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(245, 101, 101, 0.4)';"
                                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(245, 101, 101, 0.3)';">
                                    ğŸ”„ æ¸…é›¶
                                </button>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge ${
                            (item.profit_rate || 0) >= 10 ? 'badge-profit' : 
                            (item.profit_rate || 0) <= -10 ? 'badge-loss' : 
                            'badge-normal'
                        }">
                            ${item.status || 'æ­£å¸¸'}
                        </span>
                    </td>
                    <td>
                        <button class="btn-maintain-anchor" 
                                onclick="maintainSubAccount('${item.account_name}', '${item.inst_id}', '${item.pos_side}', ${item.pos_size})"
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                       color: white;
                                       border: none;
                                       padding: 6px 12px;
                                       border-radius: 6px;
                                       cursor: pointer;
                                       font-size: 12px;
                                       font-weight: 600;
                                       transition: all 0.3s;
                                       box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
                            ğŸ”§ ç»´æŠ¤
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // æ¸²æŸ“ç»´æŠ¤é”šç‚¹å•æˆäº¤è®°å½•
        function renderMaintenanceOrders(data) {
            const tbody = document.getElementById('maintenanceBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" class="empty">æš‚æ— ç»´æŠ¤è®°å½•</td></tr>';
                // é‡ç½®ç»Ÿè®¡
                document.getElementById('todayTotalCost').textContent = '$0.0000';
                document.getElementById('todayMaintenanceCount').textContent = '0';
                document.getElementById('todayNetProfit').textContent = '$0.0000';
                return;
            }

            // è®¡ç®—ä»Šæ—¥ç»Ÿè®¡
            const today = new Date().toISOString().split('T')[0];  // YYYY-MM-DD
            const todayRecords = data.filter(item => {
                if (!item.created_at) return false;
                const itemDate = item.created_at.split(' ')[0];  // æå–æ—¥æœŸéƒ¨åˆ†
                return itemDate === today;
            });
            
            const todayTotalCost = todayRecords.reduce((sum, item) => {
                return sum + (item.total_cost || item.total_fee || 0);
            }, 0);
            
            const todayNetProfit = todayRecords.reduce((sum, item) => {
                return sum + (item.net_profit || 0);
            }, 0);
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('todayTotalCost').textContent = '$' + todayTotalCost.toFixed(4);
            document.getElementById('todayMaintenanceCount').textContent = todayRecords.length;
            
            const netProfitColor = todayNetProfit >= 0 ? '#48bb78' : '#f56565';
            const netProfitEl = document.getElementById('todayNetProfit');
            netProfitEl.textContent = (todayNetProfit >= 0 ? '+' : '') + '$' + todayNetProfit.toFixed(4);
            netProfitEl.style.color = netProfitColor;

            tbody.innerHTML = data.map((item, index) => {
                const profit = item.total_profit || 0;
                const netProfit = item.net_profit || 0;
                const totalCost = item.total_cost || (item.total_fee || 0);  // å…¼å®¹æ—§æ•°æ®
                const profitColor = profit > 0 ? '#48bb78' : profit < 0 ? '#f56565' : '#718096';
                const netProfitColor = netProfit > 0 ? '#48bb78' : netProfit < 0 ? '#f56565' : '#718096';
                const accountName = item.account_name || 'JAMESYI';  // é»˜è®¤è´¦æˆ·å
                
                return `
                <tr>
                    <td style="font-weight: 600; color: #667eea;">${accountName}</td>
                    <td style="font-size: 12px; color: #718096;">${item.created_at}</td>
                    <td style="font-weight: 600;">${item.inst_id}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>${(item.original_size || 0).toFixed(4)}</td>
                    <td style="color: #667eea; font-weight: 600;">${(item.open_fills || []).length}ç¬”</td>
                    <td style="color: #3182ce; font-weight: 600;">${(item.open_total_qty || item.open_size || 0).toFixed(4)}</td>
                    <td style="color: #3182ce;">$${(item.open_avg_price || 0).toFixed(4)}</td>
                    <td style="color: #f56565;">$${(item.open_total_fee || 0).toFixed(6)}</td>
                    <td style="color: #764ba2; font-weight: 600;">${(item.close_fills || []).length}ç¬”</td>
                    <td style="color: #e53e3e; font-weight: 600;">${(item.close_total_qty || item.close_size || 0).toFixed(4)}</td>
                    <td style="color: #e53e3e;">$${(item.close_avg_price || 0).toFixed(4)}</td>
                    <td style="color: #f56565;">$${(item.close_total_fee || 0).toFixed(6)}</td>
                    <td style="color: #f56565; font-weight: 700; font-size: 14px;">$${(item.total_fee || 0).toFixed(6)}</td>
                    <td style="color: #d69e2e; font-weight: 700; font-size: 14px;">$${totalCost.toFixed(6)}</td>
                    <td style="color: #ed8936; font-weight: 700; font-size: 14px;">${(item.fee_rate || 0).toFixed(4)}%</td>
                    <td style="color: ${profitColor}; font-weight: 700; font-size: 14px;">
                        ${profit > 0 ? '+' : ''}$${profit.toFixed(4)}
                    </td>
                    <td style="color: ${netProfitColor}; font-weight: 700; font-size: 14px;">
                        ${netProfit > 0 ? '+' : ''}$${netProfit.toFixed(4)}
                    </td>
                    <td>
                        <span class="badge badge-profit">
                            ${item.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
                        </span>
                    </td>
                </tr>
                `;
            }).join('');
        }
        
        // å…¨å±€å˜é‡å­˜å‚¨ç»´æŠ¤è®°å½•
        let maintenanceRecordsData = [];
        
        // æ˜¾ç¤ºç»´æŠ¤è¯¦æƒ…
        function showMaintenanceDetail(index) {
            const item = maintenanceRecordsData[index];
            if (!item) return;
            
            // æ„å»ºå¼€ä»“æ˜ç»†
            let openDetails = 'æš‚æ— è¯¦æƒ…';
            if (item.open_fills && item.open_fills.length > 0) {
                openDetails = item.open_fills.map((fill, i) => 
                    `  ${i+1}. æ•°é‡: ${fill.qty.toFixed(4)}, ä»·æ ¼: $${fill.price.toFixed(4)}, è´¹ç”¨: $${fill.fee.toFixed(4)}`
                ).join('\n');
            }
            
            // æ„å»ºå¹³ä»“æ˜ç»†
            let closeDetails = 'æš‚æ— è¯¦æƒ…';
            if (item.close_fills && item.close_fills.length > 0) {
                closeDetails = item.close_fills.map((fill, i) => 
                    `  ${i+1}. æ•°é‡: ${fill.qty.toFixed(4)}, ä»·æ ¼: $${fill.price.toFixed(4)}, è´¹ç”¨: $${fill.fee.toFixed(4)}`
                ).join('\n');
            }
            
            const message = `ğŸ”§ ç»´æŠ¤é”šç‚¹å•è¯¦æƒ…

ğŸ“ å¸ç§: ${item.inst_id}
ğŸ“Š æ–¹å‘: ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
ğŸ’¼ åŸå§‹ä»“ä½: ${(item.original_size || 0).toFixed(4)}

ğŸŸ¢ å¼€ä»“è¯¦æƒ…:
â€¢ è®¢å•ID: ${item.open_order_id}
â€¢ æ€»æ•°é‡: ${(item.open_total_qty || 0).toFixed(4)}
â€¢ å¹³å‡ä»·æ ¼: $${(item.open_avg_price || 0).toFixed(4)}
â€¢ æˆäº¤ç¬”æ•°: ${(item.open_fills || []).length}ç¬”
â€¢ å¼€ä»“è´¹ç”¨: $${(item.open_total_fee || 0).toFixed(4)}

æˆäº¤æ˜ç»†:
${openDetails}

ğŸ”´ å¹³ä»“è¯¦æƒ…:
â€¢ è®¢å•ID: ${item.close_order_id}
â€¢ æ€»æ•°é‡: ${(item.close_total_qty || 0).toFixed(4)}
â€¢ å¹³å‡ä»·æ ¼: $${(item.close_avg_price || 0).toFixed(4)}
â€¢ æˆäº¤ç¬”æ•°: ${(item.close_fills || []).length}ç¬”
â€¢ å¹³ä»“è´¹ç”¨: $${(item.close_total_fee || 0).toFixed(4)}

æˆäº¤æ˜ç»†:
${closeDetails}

ğŸ’° è´¹ç”¨ç»Ÿè®¡:
â€¢ æ€»è´¹ç”¨: $${(item.total_fee || 0).toFixed(4)} USDT
â€¢ è´¹ç‡: ${(item.fee_rate || 0).toFixed(4)}%
â€¢ å‰©ä½™ä»“ä½: ${(item.remaining_size || 0).toFixed(4)}

â° æ—¶é—´: ${item.created_at}`;

            alert(message);
        }

        // æ¸²æŸ“ç›‘æ§è®°å½•è¡¨
        function renderMonitorTable(data) {
            const tbody = document.getElementById('monitorBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty">æš‚æ— ç›‘æ§è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.timestamp}</td>
                    <td>${item.inst_id || '--'}</td>
                    <td>
                        <span class="badge ${item.pos_side === 'short' ? 'badge-short' : 'badge-long'}">
                            ${item.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'}
                        </span>
                    </td>
                    <td>${Math.abs(item.pos_size || 0).toFixed(4)}</td>
                    <td>$${(item.avg_price || 0).toFixed(4)}</td>
                    <td>$${(item.mark_price || 0).toFixed(4)}</td>
                    <td>${item.leverage}x</td>
                    <td style="color: ${(item.profit_rate || 0) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 600;">
                        ${(item.profit_rate || 0) >= 0 ? '+' : ''}${(item.profit_rate || 0).toFixed(2)}%
                    </td>
                    <td>
                        ${item.alert_type ? (() => {
                            if (item.alert_type === 'profit_target') {
                                return '<span class="badge badge-profit">ç›ˆåˆ©ç›®æ ‡</span>';
                            } else if (item.alert_type === 'loss_limit') {
                                return '<span class="badge badge-loss">æ­¢æŸè­¦å‘Š</span>';
                            } else if (item.alert_type === 'extreme_max_profit') {
                                return '<span class="badge badge-profit">æœ€é«˜ç›ˆåˆ©åˆ·æ–°</span>';
                            } else if (item.alert_type === 'extreme_max_loss') {
                                return '<span class="badge badge-loss">æœ€å¤§äºæŸåˆ·æ–°</span>';
                            } else {
                                return '<span class="badge badge-normal">å…¶ä»–å‘Šè­¦</span>';
                            }
                        })() : '--'}
                    </td>
                    <td>
                        ${item.alert_sent ? 
                            '<span class="badge badge-sent">å·²å‘é€</span>' : 
                            (item.alert_type ? '<span class="badge badge-pending">æœªå‘é€</span>' : '--')}
                    </td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“æ”¶ç›Šç‡å›¾è¡¨
        function renderProfitChart(data) {
            // åè½¬æ•°æ®é¡ºåºï¼ˆä»æ—§åˆ°æ–°ï¼‰
            const reversedData = [...data].reverse();
            
            const timestamps = reversedData.map(item => {
                const time = new Date(item.timestamp);
                return time.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            });
            
            const profitRates = reversedData.map(item => (item.profit_rate || 0).toFixed(2));

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `æ—¶é—´: ${data.name}<br/>æ”¶ç›Šç‡: ${data.value}%`;
                    }
                },
                grid: {
                    left: '50px',
                    right: '20px',
                    top: '20px',
                    bottom: '30px'
                },
                xAxis: {
                    type: 'category',
                    data: timestamps,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ”¶ç›Šç‡ (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'æ”¶ç›Šç‡',
                    type: 'line',
                    data: profitRates,
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: '#667eea'
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [
                                {offset: 0, color: 'rgba(102, 126, 234, 0.3)'},
                                {offset: 1, color: 'rgba(102, 126, 234, 0.05)'}
                            ]
                        }
                    }
                }]
            };

            profitChart.setOption(option);
        }

        // æ¸²æŸ“å‘Šè­¦åˆ—è¡¨
        function renderAlerts(data) {
            const alertList = document.getElementById('alertList');
            
            if (data.length === 0) {
                alertList.innerHTML = '<div class="empty">æš‚æ— å‘Šè­¦è®°å½•</div>';
                return;
            }

            alertList.innerHTML = data.map(alert => {
                // åˆ¤æ–­å‘Šè­¦ç±»å‹
                let alertTitle = '';
                let alertClass = '';
                
                if (alert.alert_type === 'profit_target') {
                    alertTitle = 'ğŸ‰ ç›ˆåˆ©ç›®æ ‡è¾¾æˆ';
                    alertClass = 'profit';
                } else if (alert.alert_type === 'loss_limit') {
                    alertTitle = 'âš ï¸ æ­¢æŸè­¦å‘Š';
                    alertClass = 'loss';
                } else if (alert.alert_type === 'extreme_max_profit') {
                    alertTitle = 'ğŸš€ æœ€é«˜ç›ˆåˆ©æå€¼åˆ·æ–°é¢„è­¦';
                    alertClass = 'profit';
                } else if (alert.alert_type === 'extreme_max_loss') {
                    alertTitle = 'ğŸ“‰ æœ€å¤§äºæŸæå€¼åˆ·æ–°é¢„è­¦';
                    alertClass = 'loss';
                } else {
                    alertTitle = 'ğŸ“¢ å‘Šè­¦';
                    alertClass = alert.profit_rate >= 0 ? 'profit' : 'loss';
                }
                
                return `
                    <div class="alert-item ${alertClass}">
                        <div class="alert-header">
                            <div class="alert-title">
                                ${alertTitle}
                            </div>
                            <div class="alert-time">${alert.timestamp}</div>
                        </div>
                        <div class="alert-details">
                            ${alert.inst_id} â€¢ ${alert.pos_side === 'short' ? 'åšç©º' : 'åšå¤š'} â€¢ 
                            <strong style="color: ${alert.profit_rate >= 0 ? '#48bb78' : '#f56565'}">
                                ${alert.profit_rate >= 0 ? '+' : ''}${alert.profit_rate.toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            console.log('ğŸ”„ åˆ·æ–°æ•°æ®...', new Date().toLocaleString('zh-CN'));
            loadData();
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', () => {
            profitChart.resize();
        });

        // ============================================================
        // é¡µé¢åˆå§‹åŒ–
        // ============================================================
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“Š å¼€å§‹åŠ è½½é”šç‚¹ç³»ç»Ÿæ•°æ®...', new Date().toLocaleString('zh-CN'));
            
            // åˆå§‹åŠ è½½æ•°æ®
            loadData();
            
            // è‡ªåŠ¨ç»´æŠ¤å¼€å…³äº‹ä»¶ç›‘å¬
            document.getElementById('autoMaintainLong').addEventListener('change', async function(e) {
                const enabled = e.target.checked;
                console.log(`ğŸŸ¢ è‡ªåŠ¨ç»´æŠ¤å¤šå•-10%: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                
                try {
                    const response = await fetch('/api/anchor/auto-maintenance-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            auto_maintain_long_enabled: enabled
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(enabled ? 'âœ… å¤šå•è‡ªåŠ¨ç»´æŠ¤å·²å¼€å¯' : 'âŒ å¤šå•è‡ªåŠ¨ç»´æŠ¤å·²å…³é—­', enabled ? 'success' : 'info');
                    } else {
                        showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                        e.target.checked = !enabled; // å›æ»š
                    }
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                    e.target.checked = !enabled; // å›æ»š
                }
            });
            
            document.getElementById('autoMaintainShort').addEventListener('change', async function(e) {
                const enabled = e.target.checked;
                console.log(`ğŸ”´ è‡ªåŠ¨ç»´æŠ¤ç©ºå•-10%: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                
                try {
                    const response = await fetch('/api/anchor/auto-maintenance-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            auto_maintain_short_enabled: enabled
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(enabled ? 'âœ… ç©ºå•è‡ªåŠ¨ç»´æŠ¤å·²å¼€å¯' : 'âŒ ç©ºå•è‡ªåŠ¨ç»´æŠ¤å·²å…³é—­', enabled ? 'success' : 'info');
                    } else {
                        showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                        e.target.checked = !enabled; // å›æ»š
                    }
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                    e.target.checked = !enabled; // å›æ»š
                }
            });
            
            // è¶…çº§ç»´æŠ¤å¼€å…³äº‹ä»¶ç›‘å¬
            document.getElementById('superMaintainLong').addEventListener('change', async function(e) {
                const enabled = e.target.checked;
                console.log(`ğŸš€ è¶…çº§ç»´æŠ¤å¤šå•-10%: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                
                try {
                    const response = await fetch('/api/anchor/auto-maintenance-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            super_maintain_long_enabled: enabled
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(enabled ? 'ğŸš€ å¤šå•è¶…çº§ç»´æŠ¤å·²å¼€å¯' : 'âŒ å¤šå•è¶…çº§ç»´æŠ¤å·²å…³é—­', enabled ? 'success' : 'info');
                    } else {
                        showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                        e.target.checked = !enabled;
                    }
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                    e.target.checked = !enabled;
                }
            });
            
            document.getElementById('superMaintainShort').addEventListener('change', async function(e) {
                const enabled = e.target.checked;
                console.log(`ğŸš€ è¶…çº§ç»´æŠ¤ç©ºå•-10%: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                
                try {
                    const response = await fetch('/api/anchor/auto-maintenance-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            super_maintain_short_enabled: enabled
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(enabled ? 'ğŸš€ ç©ºå•è¶…çº§ç»´æŠ¤å·²å¼€å¯' : 'âŒ ç©ºå•è¶…çº§ç»´æŠ¤å·²å…³é—­', enabled ? 'success' : 'info');
                    } else {
                        showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                        e.target.checked = !enabled;
                    }
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                    e.target.checked = !enabled;
                }
            });
            
            // å­è´¦æˆ·è¶…çº§ç»´æŠ¤å¤šå•å¼€å…³
            document.getElementById('subSuperMaintainLong').addEventListener('change', async function(e) {
                const enabled = e.target.checked;
                console.log(`ğŸš€ å­è´¦æˆ·è¶…çº§ç»´æŠ¤å¤šå•-10%: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                
                try {
                    const response = await fetch('/api/sub-account/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            super_maintain_long_enabled: enabled
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(enabled ? 'ğŸš€ å­è´¦æˆ·å¤šå•è¶…çº§ç»´æŠ¤å·²å¼€å¯' : 'âŒ å­è´¦æˆ·å¤šå•è¶…çº§ç»´æŠ¤å·²å…³é—­', enabled ? 'success' : 'info');
                    } else {
                        showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                        e.target.checked = !enabled;
                    }
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                    e.target.checked = !enabled;
                }
            });
            
            // å­è´¦æˆ·è¶…çº§ç»´æŠ¤ç©ºå•å¼€å…³
            document.getElementById('subSuperMaintainShort').addEventListener('change', async function(e) {
                const enabled = e.target.checked;
                console.log(`ğŸš€ å­è´¦æˆ·è¶…çº§ç»´æŠ¤ç©ºå•-10%: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                
                try {
                    const response = await fetch('/api/sub-account/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            super_maintain_short_enabled: enabled
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(enabled ? 'ğŸš€ å­è´¦æˆ·ç©ºå•è¶…çº§ç»´æŠ¤å·²å¼€å¯' : 'âŒ å­è´¦æˆ·ç©ºå•è¶…çº§ç»´æŠ¤å·²å…³é—­', enabled ? 'success' : 'info');
                    } else {
                        showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                        e.target.checked = !enabled;
                    }
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showToast('âš ï¸ é…ç½®ä¿å­˜å¤±è´¥', 'error');
                    e.target.checked = !enabled;
                }
            });
            
            // ä¸€é”®å…¨éƒ¨å¹³ä»“æŒ‰é’®
            document.getElementById('closeAllSubAccountPositions').addEventListener('click', async function() {
                // äºŒæ¬¡ç¡®è®¤
                const confirmMessage = 'âš ï¸ ç¡®è®¤è¦å¹³æ‰æ‰€æœ‰å­è´¦æˆ·æŒä»“å—ï¼Ÿ\n\nè¿™å°†å…³é—­æ‰€æœ‰å­è´¦æˆ·çš„æ‰€æœ‰æŒä»“ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼';
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                console.log('ğŸš¨ å¼€å§‹æ‰§è¡Œä¸€é”®å…¨éƒ¨å¹³ä»“...');
                showToast('ğŸ”„ æ­£åœ¨å¹³ä»“æ‰€æœ‰æŒä»“...', 'info');
                
                try {
                    const response = await fetch('/api/sub-account/close-all-positions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast(`âœ… å¹³ä»“å®Œæˆï¼æˆåŠŸ: ${data.success_count}ä¸ªï¼Œå¤±è´¥: ${data.fail_count}ä¸ª`, 'success');
                        // åˆ·æ–°æ•°æ®
                        setTimeout(() => {
                            loadData();
                        }, 2000);
                    } else {
                        showToast(`âŒ å¹³ä»“å¤±è´¥: ${data.message}`, 'error');
                    }
                } catch (error) {
                    console.error('ä¸€é”®å¹³ä»“å¤±è´¥:', error);
                    showToast('âŒ ä¸€é”®å¹³ä»“å¤±è´¥', 'error');
                }
            });
            
            // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                console.log('â° è‡ªåŠ¨åˆ·æ–°æ•°æ®...', new Date().toLocaleString('zh-CN'));
                refreshData();
            }, 30000);
            
            // æŒç»­æ—¶é—´ç‹¬ç«‹æ›´æ–°ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                console.log('â° æ›´æ–°æŒç»­æ—¶é—´...', new Date().toLocaleString('zh-CN'));
                updateDurations();
            }, 30000);
            
            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œ30ç§’è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼ˆæ•°æ®+æŒç»­æ—¶é—´ï¼‰');
            console.log('ğŸ“Œ é¡µé¢ç‰ˆæœ¬: 2026-01-01-02:00 - ä¸‹è·Œå¼ºåº¦æ¨¡å—å·²ä¿®å¤');
        });
        
        // Toastæç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                color: white;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                background: ${type === 'success' ? 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)' : 
                             type === 'error' ? 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)' : 
                             'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ç»´æŠ¤é”šç‚¹å•å‡½æ•°
        async function maintainAnchor(instId, posSide, posSize) {
            try {
                // å…ˆæŸ¥è¯¢ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°
                const statsRes = await fetch('/api/anchor/maintenance-stats');
                const statsData = await statsRes.json();
                
                let todayCount = 0;
                if (statsData.success) {
                    const key = `${instId}:${posSide}`;
                    todayCount = statsData.stats[key] || 0;
                }
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡ä¸Šé™
                if (todayCount >= 3) {
                    alert(`âš ï¸ ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°å·²è¾¾ä¸Šé™\n\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}\nä»Šæ—¥å·²ç»´æŠ¤: ${todayCount}/3æ¬¡\n\nè¯·æ˜å¤©å†è¯•ï¼`);
                    return;
                }
                
                if (!confirm(`ç¡®è®¤æ‰§è¡Œç»´æŠ¤é”šç‚¹å•æ“ä½œï¼Ÿ\n\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}\næŒä»“é‡: ${posSize}\nä»Šæ—¥å·²ç»´æŠ¤: ${todayCount}/3æ¬¡\n\nå°†ä»¥å¸‚ä»·ä¹°å…¥10å€åº•ä»“æ•°é‡ï¼ˆ10å€æ æ†ï¼‰ï¼Œç„¶åç«‹å³å¹³æ‰92%`)) {
                    return;
                }
            } catch (error) {
                console.error('æŸ¥è¯¢ç»´æŠ¤æ¬¡æ•°å¤±è´¥:', error);
                // ç»§ç»­æ‰§è¡Œï¼Œä¸é˜»å¡
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingToast = document.createElement('div');
                loadingToast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    z-index: 10000;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                `;
                loadingToast.textContent = 'â³ æ­£åœ¨æ‰§è¡Œç»´æŠ¤é”šç‚¹å•æ“ä½œ...';
                document.body.appendChild(loadingToast);
                
                const response = await fetch('/api/anchor/maintain-anchor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inst_id: instId,
                        pos_side: posSide,
                        pos_size: posSize
                    })
                });
                
                const result = await response.json();
                
                // ç§»é™¤åŠ è½½æç¤º
                document.body.removeChild(loadingToast);
                
                if (result.success) {
                    alert(`âœ… ç»´æŠ¤é”šç‚¹å•æ‰§è¡ŒæˆåŠŸï¼\n\n${result.message}\n\nè¯¦æƒ…:\nå¼€ä»“è®¢å•ID: ${result.data.open_order_id}\nå¹³ä»“è®¢å•ID: ${result.data.close_order_id}\nå¼€ä»“æ•°é‡: ${result.data.open_size}\nå¹³ä»“æ•°é‡: ${result.data.close_size}`);
                    
                    // åˆ·æ–°æŒä»“æ•°æ®
                    loadData();
                } else {
                    alert(`âŒ ç»´æŠ¤é”šç‚¹å•æ‰§è¡Œå¤±è´¥\n\n${result.message}`);
                }
            } catch (error) {
                console.error('ç»´æŠ¤é”šç‚¹å•é”™è¯¯:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // å­è´¦æˆ·ç»´æŠ¤å‡½æ•°
        async function maintainSubAccount(accountName, instId, posSide, posSize) {
            try {
                if (!confirm(`ç¡®è®¤æ‰§è¡Œå­è´¦æˆ·ç»´æŠ¤æ“ä½œï¼Ÿ\n\nè´¦æˆ·: ${accountName}\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}\næŒä»“é‡: ${posSize}\n\nå°†ä¹°å…¥100Uå¹¶ç«‹å³å¹³ä»“`)) {
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingToast = document.createElement('div');
                loadingToast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    z-index: 10000;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                `;
                loadingToast.textContent = 'â³ æ­£åœ¨æ‰§è¡Œå­è´¦æˆ·ç»´æŠ¤æ“ä½œ...';
                document.body.appendChild(loadingToast);
                
                const response = await fetch('/api/anchor/maintain-sub-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_name: accountName,
                        inst_id: instId,
                        pos_side: posSide,
                        pos_size: posSize
                    })
                });
                
                const result = await response.json();
                
                // ç§»é™¤åŠ è½½æç¤º
                document.body.removeChild(loadingToast);
                
                if (result.success) {
                    alert(`âœ… å­è´¦æˆ·ç»´æŠ¤æ‰§è¡ŒæˆåŠŸï¼\n\n${result.message || 'ç»´æŠ¤å®Œæˆ'}`);
                    
                    // åˆ·æ–°æŒä»“æ•°æ®
                    loadData();
                } else {
                    alert(`âŒ å­è´¦æˆ·ç»´æŠ¤æ‰§è¡Œå¤±è´¥\n\n${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å­è´¦æˆ·ç»´æŠ¤é”™è¯¯:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // æ¸…é›¶ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°
        async function resetMaintenanceCount(accountName, instId, posSide) {
            try {
                if (!confirm(`ç¡®è®¤æ¸…é›¶ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°ï¼Ÿ\n\nè´¦æˆ·: ${accountName}\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}\n\næ¸…é›¶åä»Šæ—¥ç»´æŠ¤æ¬¡æ•°å°†é‡ç½®ä¸º0`)) {
                    return;
                }
                
                const response = await fetch('/api/anchor/reset-maintenance-count', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_name: accountName,
                        inst_id: instId,
                        pos_side: posSide
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ç»´æŠ¤æ¬¡æ•°æ¸…é›¶æˆåŠŸï¼\n\nè´¦æˆ·: ${accountName}\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}`);
                    
                    // åˆ·æ–°æŒä»“æ•°æ®
                    loadData();
                } else {
                    alert(`âŒ æ¸…é›¶å¤±è´¥\n\n${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ¸…é›¶ç»´æŠ¤æ¬¡æ•°é”™è¯¯:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // å­è´¦æˆ·æ¸…é›¶å‡½æ•°
        async function resetSubAccountMaintenance(accountName, instId, posSide) {
            try {
                if (!confirm(`ç¡®è®¤æ¸…é›¶å­è´¦æˆ·ä»Šæ—¥ç»´æŠ¤æ¬¡æ•°ï¼Ÿ\n\nè´¦æˆ·: ${accountName}\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}\n\næ¸…é›¶åä»Šæ—¥ç»´æŠ¤æ¬¡æ•°å°†é‡ç½®ä¸º0`)) {
                    return;
                }
                
                const response = await fetch('/api/anchor/reset-sub-maintenance-count', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_name: accountName,
                        inst_id: instId,
                        pos_side: posSide
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… å­è´¦æˆ·ç»´æŠ¤æ¬¡æ•°æ¸…é›¶æˆåŠŸï¼\n\nè´¦æˆ·: ${accountName}\nå¸ç§: ${instId}\næ–¹å‘: ${posSide === 'short' ? 'åšç©º' : 'åšå¤š'}\nåŸæ¬¡æ•°: ${result.old_count}æ¬¡ â†’ æ–°æ¬¡æ•°: 0æ¬¡`);
                    
                    // åˆ·æ–°æŒä»“æ•°æ®
                    loadData();
                } else {
                    alert(`âŒ æ¸…é›¶å¤±è´¥\n\n${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ¸…é›¶å­è´¦æˆ·ç»´æŠ¤æ¬¡æ•°é”™è¯¯:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>
