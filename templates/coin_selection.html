<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <title>å¸ç§é€‰æ‹©ç³»ç»Ÿ - æ™ºèƒ½äº¤æ˜“è¾…åŠ©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* æ¡†æ¶1: å®æ—¶ç»Ÿè®¡ */
        .stats-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .stats-box h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-sub {
            font-size: 12px;
            color: #999;
        }

        /* æ¡†æ¶2: ç­›é€‰æ¡ä»¶ */
        .filter-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .filter-box h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-items {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .filter-item {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #4caf50;
        }

        .filter-item.disabled {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .filter-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .filter-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .filter-desc {
            font-size: 12px;
            color: #666;
        }

        /* æ¡†æ¶3: å°è¶‹åŠ¿ä»“ä½ */
        .position-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .position-box h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-content {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .position-main {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }

        .position-value {
            font-size: 72px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .position-label {
            font-size: 18px;
            opacity: 0.9;
        }

        .position-details {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .position-detail-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        /* æ¡†æ¶4: å¸ç§æ’å */
        .coins-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .coins-box h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coins-table {
            width: 100%;
            border-collapse: collapse;
        }

        .coins-table thead {
            background: #f8f9fa;
        }

        .coins-table th {
            padding: 12px;
            text-align: left;
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }

        .coins-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .coins-table tbody tr:hover {
            background: #f8f9fa;
        }

        .coin-symbol {
            font-weight: 600;
            color: #333;
        }

        .coin-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 4px;
            font-weight: 600;
        }

        .tag-v1 {
            background: #fff3cd;
            color: #856404;
        }

        .tag-v2 {
            background: #cfe2ff;
            color: #084298;
        }

        .tag-rush-up {
            background: #d1e7dd;
            color: #0a3622;
        }

        .tag-priority {
            background: #f8d7da;
            color: #58151c;
        }

        .positive {
            color: #4caf50;
            font-weight: 600;
        }

        .negative {
            color: #f44336;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">â† è¿”å›é¦–é¡µ</a>

        <!-- æ¡†æ¶1: å®æ—¶ç»Ÿè®¡ -->
        <div class="stats-box">
            <h2>ğŸ“Š å®æ—¶ç»Ÿè®¡</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å¸ç§æ± æ€»æ•°</div>
                    <div class="stat-value" id="pool-size" style="color: #667eea;">-</div>
                    <div class="stat-sub">ç­›é€‰åçš„å¸ç§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é«˜å¾—åˆ†</div>
                    <div class="stat-value" id="max-score" style="color: #fbbf24;">-</div>
                    <div class="stat-sub">å½“å‰æœ€ä¼˜å¸ç§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡å¾—åˆ†</div>
                    <div class="stat-value" id="avg-score" style="color: #10b981;">-</div>
                    <div class="stat-sub">æ± å†…å¹³å‡æ°´å¹³</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ›´æ–°æ—¶é—´</div>
                    <div class="stat-value" id="update-time" style="color: #6b7280; font-size: 14px;">-</div>
                    <div class="stat-sub">æœ€åæ•°æ®æ›´æ–°</div>
                </div>
            </div>
        </div>

        <!-- æ¡†æ¶2: ç­›é€‰æ¡ä»¶ (å¸‚åœºæ± ) -->
        <div class="filter-box">
            <h2>ğŸ” ç­›é€‰æ¡ä»¶ (å¸‚åœºæ± )</h2>
            <div class="filter-items">
                <div class="filter-item">
                    <div class="filter-icon">âœ…</div>
                    <div class="filter-title">V1/V2ç­›é€‰</div>
                    <div class="filter-desc" id="filter-v1v2">ratio2 â‰¥ 100%</div>
                </div>
                <div class="filter-item">
                    <div class="filter-icon">âœ…</div>
                    <div class="filter-title">æ€¥æ¶¨ä¼˜å…ˆ</div>
                    <div class="filter-desc" id="filter-rush">æ€¥æ¶¨ > æ€¥è·Œ</div>
                </div>
                <div class="filter-item">
                    <div class="filter-icon">âœ…</div>
                    <div class="filter-title">ä¼˜å…ˆçº§ç­›é€‰</div>
                    <div class="filter-desc" id="filter-priority">ä¼˜å…ˆçº§ â‰¥ 4</div>
                </div>
                <div class="filter-item">
                    <div class="filter-icon">â­</div>
                    <div class="filter-title">8å¤§å› å­è¯„åˆ†</div>
                    <div class="filter-desc" id="filter-factors">6å¤§å› å­ç»¼åˆæ‰“åˆ†</div>
                </div>
            </div>
        </div>

        <!-- æ¡†æ¶3: å°è¶‹åŠ¿ä»“ä½æƒ…å†µ -->
        <div class="position-box">
            <h2>ğŸ“ˆ å°è¶‹åŠ¿ä»“ä½æƒ…å†µ</h2>
            <div class="position-content">
                <div class="position-main">
                    <div class="position-value" id="total-position">-</div>
                    <div class="position-label" id="position-level">å»ºè®®æ€»ä»“ä½</div>
                </div>
                <div class="position-details">
                    <div class="position-detail-card">
                        <div class="detail-label">æ˜Ÿæ˜Ÿä»“ä½</div>
                        <div class="detail-value" id="star-position" style="color: #fbbf24;">-</div>
                    </div>
                    <div class="position-detail-card">
                        <div class="detail-label">æŒä»“é‡ä»“ä½</div>
                        <div class="detail-value" id="oi-position" style="color: #10b981;">-</div>
                    </div>
                    <div class="position-detail-card">
                        <div class="detail-label">è¶‹åŠ¿å¾—åˆ†</div>
                        <div class="detail-value" id="trend-score" style="color: #667eea;">-</div>
                    </div>
                    <div class="position-detail-card">
                        <div class="detail-label">è¶‹åŠ¿åˆ¤æ–­</div>
                        <div class="detail-value" id="trend-text" style="font-size: 18px;">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¡†æ¶4: å¸ç§æ’å (æŒ‰æ€»åˆ†æ’åº) -->
        <div class="coins-box">
            <h2>ğŸ’ å¸ç§æ’å (æŒ‰æ€»åˆ†æ’åº)</h2>
            <div id="coins-content" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <script>
        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // 1. è·å–å¼€ä»“é€»è¾‘æ•°æ®ï¼ˆå¤§è¶‹åŠ¿ + å°è¶‹åŠ¿ä»“ä½ï¼‰
                const openingRes = await fetch('/api/opening-logic/suggestion');
                const openingData = await openingRes.json();
                
                // 2. è·å–æ˜Ÿæ˜Ÿç³»ç»Ÿæ•°æ®ï¼ˆå¸ç§æ± ï¼‰
                const starRes = await fetch('/api/star-system/data');
                const starData = await starRes.json();
                
                // 3. è·å–å¸ç§é€‰æ‹©æ’åæ•°æ®
                const rankingRes = await fetch('/api/coin-selection/ranking');
                const rankingData = await rankingRes.json();
                
                // æ›´æ–°æ¡†æ¶3: å°è¶‹åŠ¿ä»“ä½æƒ…å†µ
                if (openingData.success && openingData.data) {
                    const data = openingData.data;
                    const posInfo = data.position_info;
                    
                    // æ€»ä»“ä½
                    document.getElementById('total-position').textContent = posInfo.position_percent + '%';
                    document.getElementById('position-level').textContent = posInfo.position_level;
                    
                    // ä»“ä½æ˜ç»†
                    document.getElementById('star-position').textContent = posInfo.star_position + '%';
                    document.getElementById('oi-position').textContent = posInfo.oi_position + '%';
                    
                    // è¶‹åŠ¿ä¿¡æ¯
                    document.getElementById('trend-score').textContent = data.trend_score + 'åˆ†';
                    document.getElementById('trend-text').textContent = data.trend;
                    
                    // æ ¹æ®è¶‹åŠ¿ç±»å‹è®¾ç½®é¢œè‰²
                    const posMain = document.querySelector('.position-main');
                    if (data.suggestion_type === 'long') {
                        posMain.style.background = 'linear-gradient(135deg, #4ade80 0%, #10b981 100%)';
                    } else if (data.suggestion_type === 'short') {
                        posMain.style.background = 'linear-gradient(135deg, #f87171 0%, #ef4444 100%)';
                    } else {
                        posMain.style.background = 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)';
                    }
                }
                
                // æ›´æ–°æ¡†æ¶1: å®æ—¶ç»Ÿè®¡
                if (rankingData.success && rankingData.data && rankingData.data.coins) {
                    const coins = rankingData.data.coins;
                    document.getElementById('pool-size').textContent = coins.length;
                    
                    // è®¡ç®—æœ€é«˜åˆ†å’Œå¹³å‡åˆ†ï¼ˆè¿™é‡Œæš‚æ—¶ç”¨ratio2ä½œä¸ºä¸´æ—¶å¾—åˆ†ï¼‰
                    if (coins.length > 0) {
                        const scores = coins.map(c => {
                            const ratio = typeof c.ratio2 === 'string' ? 
                                parseFloat(c.ratio2.replace('%', '')) : (c.ratio2 || 0);
                            return ratio;
                        });
                        const maxScore = Math.max(...scores).toFixed(1);
                        const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                        
                        document.getElementById('max-score').textContent = maxScore;
                        document.getElementById('avg-score').textContent = avgScore;
                    }
                    
                    document.getElementById('update-time').textContent = 
                        rankingData.update_time ? formatTime(rankingData.update_time) : '-';
                }
                
                // æ›´æ–°æ¡†æ¶2: ç­›é€‰æ¡ä»¶
                if (starData.success && starData.v1v2_coins && starData.coin_lists) {
                    const v1v2 = starData.v1v2_coins;
                    const lists = starData.coin_lists;
                    
                    document.getElementById('filter-v1v2').textContent = 
                        `V1: ${v1v2.v1_count || 0}ä¸ª, V2: ${v1v2.v2_count || 0}ä¸ª`;
                    document.getElementById('filter-rush').textContent = 
                        `æ€¥æ¶¨>æ€¥è·Œ: ${(lists.rush_up_gt_down_coins || []).length}ä¸ª`;
                    document.getElementById('filter-priority').textContent = 
                        `é«˜ä¼˜å…ˆçº§: ${(lists.priority_high_coins || []).length}ä¸ª`;
                }
                
                // æ›´æ–°æ¡†æ¶4: å¸ç§åˆ—è¡¨
                renderCoins((rankingData.data && rankingData.data.coins) || [], starData);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('coins-content').innerHTML = 
                    '<div class="error">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }
        
        // æ¸²æŸ“å¸ç§åˆ—è¡¨
        function renderCoins(coins, starData) {
            if (!coins || coins.length === 0) {
                document.getElementById('coins-content').innerHTML = 
                    '<div class="error">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¸ç§</div>';
                return;
            }
            
            const v1v2 = starData.v1v2_coins || {};
            const lists = starData.coin_lists || {};
            
            const v1Coins = new Set(v1v2.v1_coins || []);
            const v2Coins = new Set(v1v2.v2_coins || []);
            const rushUpCoins = new Set(lists.only_rush_up_coins || []);
            const priorityCoins = new Set(lists.priority_high_coins || []);
            
            let html = `
                <table class="coins-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å¸ç§</th>
                            <th>æ ‡ç­¾</th>
                            <th>24hæ¶¨è·Œ</th>
                            <th>æ€¥æ¶¨/æ€¥è·Œ</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>V1V2æ¯”å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            coins.forEach((coin, index) => {
                const symbol = coin.symbol.replace('-USDT-SWAP', '');
                const tags = [];
                
                if (v1Coins.has(symbol)) tags.push('<span class="coin-tag tag-v1">V1</span>');
                if (v2Coins.has(symbol)) tags.push('<span class="coin-tag tag-v2">V2</span>');
                if (rushUpCoins.has(symbol)) tags.push('<span class="coin-tag tag-rush-up">åªæ¶¨</span>');
                if (priorityCoins.has(symbol)) tags.push('<span class="coin-tag tag-priority">é«˜ä¼˜</span>');
                
                const changeClass = coin.change_24h >= 0 ? 'positive' : 'negative';
                const changeText = coin.change_24h >= 0 ? `+${coin.change_24h}%` : `${coin.change_24h}%`;
                
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><span class="coin-symbol">${symbol}</span></td>
                        <td>${tags.join(' ') || '-'}</td>
                        <td class="${changeClass}">${changeText}</td>
                        <td>${coin.rush_up || 0} / ${coin.rush_down || 0}</td>
                        <td>${coin.priority_level || '-'}</td>
                        <td>${coin.ratio2 || 0}%</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('coins-content').innerHTML = html;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            if (!timeStr) return '-';
            const time = timeStr.split(' ')[1] || timeStr;
            return time.substring(0, 5);
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        loadData();
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadData, 30000);
    </script>
</body>
</html>
