<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKXåŠ å¯†è´§å¸æŒ‡æ•° - 27å¸ç§åŠ æƒæŒ‡æ•°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f1229 0%, #1a1f3a 100%);
            color: #e0e6ed;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            color: #8b95a5;
            font-size: 14px;
            margin-top: 10px;
        }

        /* è¿”å›é¦–é¡µæŒ‰é’® */
        .home-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 217, 61, 0.3);
            border-radius: 25px;
            color: #ffd93d;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .home-button:hover {
            background: rgba(255, 217, 61, 0.2);
            border-color: rgba(255, 217, 61, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 217, 61, 0.3);
        }

        .home-button:active {
            transform: translateY(0);
        }

        /* æŒ‡æ•°ä¸»æ˜¾ç¤ºå¡ç‰‡ */
        .index-main-card {
            background: linear-gradient(135deg, rgba(255, 217, 61, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 217, 61, 0.3);
            box-shadow: 0 8px 32px rgba(255, 217, 61, 0.2);
        }

        .index-value-large {
            font-size: 72px;
            font-weight: 700;
            text-align: center;
            color: #ffd93d;
            text-shadow: 0 0 20px rgba(255, 217, 61, 0.5);
            margin-bottom: 20px;
        }

        .index-change-large {
            font-size: 36px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
        }

        .index-change-large.positive {
            color: #00ff88;
        }

        .index-change-large.negative {
            color: #ff6b6b;
        }

        .index-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .index-info-item {
            text-align: center;
        }

        .index-info-label {
            color: #8b95a5;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .index-info-value {
            color: #e0e6ed;
            font-size: 20px;
            font-weight: 600;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #e0e6ed;
        }

        .chart-canvas {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        /* æˆåˆ†å¸ç§è¡¨æ ¼ */
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .component-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .component-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 217, 61, 0.5);
            box-shadow: 0 6px 20px rgba(255, 217, 61, 0.15);
        }

        .component-card.large-weight {
            border: 2px solid rgba(255, 217, 61, 0.5);
            background: rgba(255, 217, 61, 0.08);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .component-name {
            font-size: 18px;
            font-weight: 600;
            color: #ffd93d;
        }

        .component-weight {
            font-size: 14px;
            color: #8b95a5;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .component-price {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e0e6ed;
        }

        .component-change {
            font-size: 16px;
            font-weight: 600;
        }

        .component-change.positive {
            color: #00ff88;
        }

        .component-change.negative {
            color: #ff6b6b;
        }

        .component-contribution {
            font-size: 12px;
            color: #8b95a5;
            margin-top: 5px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b95a5;
        }
    </style>
</head>
<body>
    <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
    <a href="/" class="home-button">
        <span>ğŸ </span>
        <span>è¿”å›é¦–é¡µ</span>
    </a>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“Š OKXåŠ å¯†è´§å¸æŒ‡æ•°</h1>
            <div class="subtitle">27ä¸ªä¸»æµå¸ç§åŠ æƒæŒ‡æ•° | BTC 10% + ETH 6% + å…¶ä»–25å¸ç§å„3.36% | æ¯10ç§’æ›´æ–°</div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">è¿æ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span id="updateTime">æ›´æ–°æ—¶é—´: --</span>
            </div>
        </div>

        <!-- æŒ‡æ•°ä¸»æ˜¾ç¤º -->
        <div class="index-main-card">
            <div class="index-value-large" id="indexValue">--</div>
            <div class="index-change-large" id="indexChange">--</div>
            
            <div class="index-info">
                <div class="index-info-item">
                    <div class="index-info-label">åŸºå‡†å€¼</div>
                    <div class="index-info-value" id="baseValue">1000.00</div>
                </div>
                <div class="index-info-item">
                    <div class="index-info-label">æœ‰æ•ˆæˆåˆ†</div>
                    <div class="index-info-value" id="validComponents">--</div>
                </div>
                <div class="index-info-item">
                    <div class="index-info-label">æ€»æˆåˆ†æ•°</div>
                    <div class="index-info-value">27</div>
                </div>
            </div>
        </div>

        <!-- å¹³å‡ä½ç½®æ˜¾ç¤º -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <div class="chart-title">ğŸ“ å¸‚åœºå¹³å‡ä½ç½®</div>
            <div class="index-info" style="margin-top: 0;">
                <div class="index-info-item">
                    <div class="index-info-label">4å°æ—¶å¹³å‡ä½ç½®</div>
                    <div class="index-info-value" id="position4h" style="color: #3b82f6;">--</div>
                </div>
                <div class="index-info-item">
                    <div class="index-info-label">12å°æ—¶å¹³å‡ä½ç½®</div>
                    <div class="index-info-value" id="position12h" style="color: #8b5cf6;">--</div>
                </div>
                <div class="index-info-item">
                    <div class="index-info-label">24å°æ—¶å¹³å‡ä½ç½®</div>
                    <div class="index-info-value" id="position24h" style="color: #ec4899;">--</div>
                </div>
                <div class="index-info-item">
                    <div class="index-info-label">48å°æ—¶å¹³å‡ä½ç½®</div>
                    <div class="index-info-value" id="position48h" style="color: #f59e0b;">--</div>
                </div>
            </div>
        </div>

        <!-- 12å°æ—¶èµ°åŠ¿å›¾ï¼ˆåˆ†é¡µï¼‰ -->
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="chart-title" style="margin-bottom: 0;">ğŸ“ˆ æŒ‡æ•°12å°æ—¶èµ°åŠ¿å›¾</div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button id="prevPageBtn" onclick="changePage(-1)" style="padding: 8px 16px; background: rgba(255, 217, 61, 0.2); border: 1px solid #ffd93d; border-radius: 6px; color: #ffd93d; cursor: pointer; font-size: 14px; transition: all 0.3s;">â† ä¸Šä¸€é¡µ</button>
                    <span id="pageInfo" style="color: #ffd93d; font-weight: 600; min-width: 120px; text-align: center;">ç¬¬ 1 / 1 é¡µ</span>
                    <button id="nextPageBtn" onclick="changePage(1)" style="padding: 8px 16px; background: rgba(255, 217, 61, 0.2); border: 1px solid #ffd93d; border-radius: 6px; color: #ffd93d; cursor: pointer; font-size: 14px; transition: all 0.3s;">ä¸‹ä¸€é¡µ â†’</button>
                </div>
            </div>
            <canvas id="indexChart" class="chart-canvas"></canvas>
        </div>

        <!-- 1åˆ†é’ŸKçº¿å›¾ + æˆäº¤é‡ -->
        <div class="chart-container">
            <div class="chart-title">ğŸ“Š 1åˆ†é’ŸKçº¿å›¾ + æˆäº¤é‡</div>
            <canvas id="klineChart" class="chart-canvas" style="height: 500px;"></canvas>
        </div>

        <!-- æˆåˆ†å¸ç§è¯¦æƒ… -->
        <div class="chart-container">
            <div class="chart-title">ğŸª™ æˆåˆ†å¸ç§è¯¦æƒ…</div>
            <div class="components-grid" id="componentsGrid">
                <div class="loading">æ­£åœ¨åŠ è½½æˆåˆ†æ•°æ®...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/index';
        const UPDATE_INTERVAL = 2000; // å‰ç«¯æ¯2ç§’åˆ·æ–°ä¸€æ¬¡

        let indexData = {};
        let chartCtx = null;
        let klineCtx = null;
        let currentPage = 1;
        let totalPages = 1;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            initKlineChart();
            startIndexMonitoring();
            startDataUpdate();
        });

        // åˆå§‹åŒ–æŒ‡æ•°å›¾è¡¨
        function initChart() {
            const canvas = document.getElementById('indexChart');
            chartCtx = canvas.getContext('2d');
            
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            chartCtx.scale(2, 2);
        }

        // åˆå§‹åŒ–Kçº¿å›¾è¡¨
        function initKlineChart() {
            const canvas = document.getElementById('klineChart');
            klineCtx = canvas.getContext('2d');
            
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            klineCtx.scale(2, 2);
        }

        // å¯åŠ¨æŒ‡æ•°ç›‘æ§
        async function startIndexMonitoring() {
            try {
                const response = await fetch(`${API_BASE}/start`, { method: 'POST' });
                const result = await response.json();
                console.log('æŒ‡æ•°ç›‘æ§å¯åŠ¨:', result);
            } catch (error) {
                console.error('å¯åŠ¨ç›‘æ§å¤±è´¥:', error);
            }
        }

        // å¼€å§‹æ•°æ®æ›´æ–°
        function startDataUpdate() {
            updateData();
            setInterval(updateData, UPDATE_INTERVAL);
        }

        // æ›´æ–°æ•°æ®
        async function updateData() {
            try {
                // è·å–å½“å‰æŒ‡æ•°å€¼
                const currentResponse = await fetch(`${API_BASE}/current`);
                const currentData = await currentResponse.json();

                // è·å–æˆåˆ†è¯¦æƒ…
                const componentsResponse = await fetch(`${API_BASE}/components`);
                const componentsData = await componentsResponse.json();

                // è·å–å†å²æ•°æ®ï¼ˆåˆ†é¡µï¼‰
                const historyResponse = await fetch(`${API_BASE}/history?page=${currentPage}`);
                const historyData = await historyResponse.json();

                // è·å–Kçº¿æ•°æ®
                const klinesResponse = await fetch(`${API_BASE}/klines`);
                const klinesData = await klinesResponse.json();

                // è·å–å¹³å‡ä½ç½®æ•°æ®
                const positionResponse = await fetch('/api/position/summary');
                const positionData = await positionResponse.json();

                if (currentData.success) {
                    updateIndexDisplay(currentData.data);
                    updateStatus(true);
                }

                if (componentsData.success) {
                    updateComponentsDisplay(componentsData.data);
                }

                if (historyData.success) {
                    totalPages = historyData.total_pages || 1;
                    currentPage = historyData.current_page || 1;
                    updatePageInfo();
                    drawChart(historyData.data);
                }

                if (klinesData.success) {
                    drawKlineChart(klinesData.data);
                }

                if (positionData.success && positionData.averages) {
                    updatePositionDisplay(positionData.averages);
                }

            } catch (error) {
                console.error('æ•°æ®æ›´æ–°å¤±è´¥:', error);
                updateStatus(false);
            }
        }

        // æ›´æ–°æŒ‡æ•°æ˜¾ç¤º
        function updateIndexDisplay(data) {
            document.getElementById('indexValue').textContent = data.value.toFixed(2);
            document.getElementById('baseValue').textContent = data.base_value.toFixed(2);
            document.getElementById('validComponents').textContent = `${data.valid_components} / 27`;

            const changeElement = document.getElementById('indexChange');
            const changePercent = data.change_percent;
            const changeSign = changePercent >= 0 ? '+' : '';
            
            changeElement.textContent = `${changeSign}${changePercent.toFixed(2)}%`;
            changeElement.className = `index-change-large ${changePercent >= 0 ? 'positive' : 'negative'}`;
        }

        // æ›´æ–°æˆåˆ†æ˜¾ç¤º
        function updateComponentsDisplay(components) {
            const grid = document.getElementById('componentsGrid');
            
            // æŒ‰æƒé‡æ’åºï¼ˆå¤§æƒé‡åœ¨å‰ï¼‰
            const sortedComponents = Object.values(components).sort((a, b) => b.weight - a.weight);
            
            grid.innerHTML = sortedComponents.map(comp => {
                const changePercent = comp.change_percent;
                const changeSign = changePercent >= 0 ? '+' : '';
                const changeClass = changePercent >= 0 ? 'positive' : 'negative';
                const isLargeWeight = comp.weight >= 0.06; // BTCå’ŒETH
                
                return `
                    <div class="component-card ${isLargeWeight ? 'large-weight' : ''}">
                        <div class="component-header">
                            <div class="component-name">${comp.name}</div>
                            <div class="component-weight">${(comp.weight * 100).toFixed(2)}%</div>
                        </div>
                        <div class="component-price">$${comp.price.toFixed(comp.price > 1000 ? 1 : 4)}</div>
                        <div class="component-change ${changeClass}">${changeSign}${changePercent.toFixed(2)}%</div>
                        <div class="component-contribution">æŒ‡æ•°è´¡çŒ®: ${changeSign}${comp.weighted_contribution.toFixed(3)}%</div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°å¹³å‡ä½ç½®æ˜¾ç¤º
        function updatePositionDisplay(positions) {
            document.getElementById('position4h').textContent = positions['4h'] !== undefined ? positions['4h'].toFixed(2) : '--';
            document.getElementById('position12h').textContent = positions['12h'] !== undefined ? positions['12h'].toFixed(2) : '--';
            document.getElementById('position24h').textContent = positions['24h'] !== undefined ? positions['24h'].toFixed(2) : '--';
            document.getElementById('position48h').textContent = positions['48h'] !== undefined ? positions['48h'].toFixed(2) : '--';
        }

        // ç¿»é¡µåŠŸèƒ½
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage < 1 || newPage > totalPages) return;
            currentPage = newPage;
            updateData();
        }

        // æ›´æ–°é¡µç ä¿¡æ¯
        function updatePageInfo() {
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
            prevBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
            nextBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
            nextBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
        }

        // ç»˜åˆ¶å›¾è¡¨ï¼ˆå¸¦æ—¥æœŸåˆ†å‰²çº¿ï¼‰
        function drawChart(history) {
            if (!history || history.length < 2) return;

            const canvas = document.getElementById('indexChart');
            const ctx = chartCtx;
            const rect = canvas.getBoundingClientRect();
            
            const padding = { top: 40, right: 80, bottom: 60, left: 60 };
            const chartWidth = rect.width - padding.left - padding.right;
            const chartHeight = rect.height - padding.top - padding.bottom;

            ctx.clearRect(0, 0, rect.width, rect.height);

            // æ‰¾åˆ°æœ€å°å’Œæœ€å¤§å˜åŒ–ç™¾åˆ†æ¯”
            const values = history.map(h => h.change_percent);
            let minChange = Math.min(...values);
            let maxChange = Math.max(...values);

            // æ·»åŠ è¾¹è·
            const range = maxChange - minChange;
            const margin = range * 0.1 || 0.1;
            minChange -= margin;
            maxChange += margin;

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.font = '12px Arial';
            ctx.fillStyle = '#8b95a5';

            // æ°´å¹³ç½‘æ ¼çº¿
            const ySteps = 8;
            for (let i = 0; i <= ySteps; i++) {
                const y = padding.top + (chartHeight / ySteps) * i;
                const changeValue = maxChange - ((maxChange - minChange) / ySteps) * i;

                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();

                const label = changeValue.toFixed(2) + '%';
                ctx.textAlign = 'right';
                ctx.fillText(label, padding.left - 10, y + 4);
            }

            // 0%çº¿
            if (minChange < 0 && maxChange > 0) {
                const zeroY = padding.top + chartHeight - ((0 - minChange) / (maxChange - minChange)) * chartHeight;
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding.left, zeroY);
                ctx.lineTo(padding.left + chartWidth, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // ç»˜åˆ¶æ›²çº¿
            ctx.strokeStyle = '#ffd93d';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = '#ffd93d';
            ctx.shadowBlur = 10;

            ctx.beginPath();
            history.forEach((point, index) => {
                const x = padding.left + (chartWidth / (history.length - 1)) * index;
                const normalizedY = (point.change_percent - minChange) / (maxChange - minChange);
                const y = padding.top + chartHeight - normalizedY * chartHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            ctx.shadowBlur = 0;

            // ç»˜åˆ¶ç»ˆç‚¹æ ‡è®°
            const lastPoint = history[history.length - 1];
            const lastX = padding.left + chartWidth;
            const lastNormalizedY = (lastPoint.change_percent - minChange) / (maxChange - minChange);
            const lastY = padding.top + chartHeight - lastNormalizedY * chartHeight;

            ctx.fillStyle = '#ffd93d40';
            ctx.beginPath();
            ctx.arc(lastX, lastY, 8, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#ffd93d';
            ctx.beginPath();
            ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
            ctx.fill();

            ctx.font = 'bold 14px Arial';
            const label = (lastPoint.change_percent >= 0 ? '+' : '') + lastPoint.change_percent.toFixed(2) + '%';
            ctx.fillText(label, lastX + 12, lastY + 5);

            // ç»˜åˆ¶æ—¥æœŸåˆ†å‰²ç«–çº¿
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([]);
            ctx.font = '12px Arial';
            ctx.fillStyle = '#ffd93d';
            ctx.textAlign = 'center';

            let lastDate = null;
            history.forEach((point, index) => {
                const date = new Date(point.time);
                const dateStr = date.toLocaleDateString('zh-CN');
                
                // å½“æ—¥æœŸå˜åŒ–æ—¶ï¼Œç»˜åˆ¶ç«–çº¿
                if (lastDate && dateStr !== lastDate) {
                    const x = padding.left + (chartWidth / (history.length - 1)) * index;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, padding.top);
                    ctx.lineTo(x, padding.top + chartHeight);
                    ctx.stroke();
                    
                    // ç»˜åˆ¶æ—¥æœŸæ ‡ç­¾
                    ctx.fillText(dateStr, x, padding.top + chartHeight + 30);
                }
                lastDate = dateStr;
            });

            // ç»˜åˆ¶ç¬¬ä¸€ä¸ªæ—¥æœŸæ ‡ç­¾
            if (history.length > 0) {
                const firstDate = new Date(history[0].time);
                const firstDateStr = firstDate.toLocaleDateString('zh-CN');
                ctx.fillText(firstDateStr, padding.left, padding.top + chartHeight + 30);
            }
        }

        // ç»˜åˆ¶Kçº¿å›¾ï¼ˆèœ¡çƒ›å›¾ + æˆäº¤é‡ï¼‰
        function drawKlineChart(klines) {
            if (!klines || klines.length < 1) return;

            const canvas = document.getElementById('klineChart');
            const ctx = klineCtx;
            const rect = canvas.getBoundingClientRect();
            
            // å›¾è¡¨åˆ†åŒºï¼šä¸Šæ–¹70%ä¸ºKçº¿ï¼Œä¸‹æ–¹30%ä¸ºæˆäº¤é‡
            const padding = { top: 40, right: 80, bottom: 100, left: 60 };
            const totalHeight = rect.height - padding.top - padding.bottom;
            const klineHeight = totalHeight * 0.7;
            const volumeHeight = totalHeight * 0.25;
            const volumeTop = padding.top + klineHeight + 20;
            const chartWidth = rect.width - padding.left - padding.right;

            ctx.clearRect(0, 0, rect.width, rect.height);

            // æ‰¾åˆ°Kçº¿ä»·æ ¼èŒƒå›´
            const prices = klines.flatMap(k => [k.high, k.low]);
            let minPrice = Math.min(...prices);
            let maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice;
            const priceMargin = priceRange * 0.1 || 1;
            minPrice -= priceMargin;
            maxPrice += priceMargin;

            // æ‰¾åˆ°æˆäº¤é‡èŒƒå›´
            const volumes = klines.map(k => k.volume);
            const maxVolume = Math.max(...volumes);

            // ç»˜åˆ¶Kçº¿åŒºåŸŸç½‘æ ¼
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.font = '12px Arial';
            ctx.fillStyle = '#8b95a5';

            // æ°´å¹³ç½‘æ ¼çº¿ï¼ˆä»·æ ¼ï¼‰
            const ySteps = 6;
            for (let i = 0; i <= ySteps; i++) {
                const y = padding.top + (klineHeight / ySteps) * i;
                const priceValue = maxPrice - ((maxPrice - minPrice) / ySteps) * i;

                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();

                const label = priceValue.toFixed(2);
                ctx.textAlign = 'right';
                ctx.fillText(label, padding.left - 10, y + 4);
            }

            // ç»˜åˆ¶Kçº¿
            const candleWidth = Math.max(3, (chartWidth / klines.length) * 0.7);
            const candleGap = (chartWidth / klines.length) * 0.3;

            klines.forEach((kline, index) => {
                const x = padding.left + (chartWidth / klines.length) * index + candleGap / 2;
                
                // è®¡ç®—ä»·æ ¼ä½ç½®
                const openY = padding.top + klineHeight - ((kline.open - minPrice) / (maxPrice - minPrice)) * klineHeight;
                const closeY = padding.top + klineHeight - ((kline.close - minPrice) / (maxPrice - minPrice)) * klineHeight;
                const highY = padding.top + klineHeight - ((kline.high - minPrice) / (maxPrice - minPrice)) * klineHeight;
                const lowY = padding.top + klineHeight - ((kline.low - minPrice) / (maxPrice - minPrice)) * klineHeight;

                // åˆ¤æ–­æ¶¨è·Œ
                const isRising = kline.close >= kline.open;
                const color = isRising ? '#00ff88' : '#ff6b6b';

                // ç»˜åˆ¶ä¸Šä¸‹å½±çº¿
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + candleWidth / 2, highY);
                ctx.lineTo(x + candleWidth / 2, lowY);
                ctx.stroke();

                // ç»˜åˆ¶å®ä½“
                const bodyTop = Math.min(openY, closeY);
                const bodyHeight = Math.abs(closeY - openY) || 1;
                
                if (isRising) {
                    ctx.fillStyle = color;
                    ctx.fillRect(x, bodyTop, candleWidth, bodyHeight);
                } else {
                    ctx.fillStyle = color;
                    ctx.fillRect(x, bodyTop, candleWidth, bodyHeight);
                }

                // ç»˜åˆ¶æˆäº¤é‡æŸ±
                const volumeBarHeight = (kline.volume / maxVolume) * volumeHeight;
                const volumeY = volumeTop + volumeHeight - volumeBarHeight;
                ctx.fillStyle = isRising ? 'rgba(0, 255, 136, 0.5)' : 'rgba(255, 107, 107, 0.5)';
                ctx.fillRect(x, volumeY, candleWidth, volumeBarHeight);
            });

            // ç»˜åˆ¶æˆäº¤é‡åŒºåŸŸæ ‡ç­¾
            ctx.fillStyle = '#8b95a5';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('æˆäº¤é‡', padding.left, volumeTop - 10);

            // æˆäº¤é‡åˆ»åº¦
            ctx.font = '12px Arial';
            const volLabel = (maxVolume / 1000000).toFixed(1) + 'M';
            ctx.textAlign = 'right';
            ctx.fillText(volLabel, padding.left - 10, volumeTop + 15);

            // ç»˜åˆ¶æ—¶é—´è½´
            const timeStep = Math.ceil(klines.length / 6);
            for (let i = 0; i < klines.length; i += timeStep) {
                const x = padding.left + (chartWidth / klines.length) * i;
                const kline = klines[i];
                const date = new Date(kline.timestamp);
                const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                ctx.fillStyle = '#8b95a5';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(timeStr, x, volumeTop + volumeHeight + 30);
            }

            // æ ‡é¢˜
            ctx.fillStyle = '#ffd93d';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Kçº¿æ•°é‡: ${klines.length}æ ¹`, padding.left, padding.top - 15);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(isOnline = true) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const updateTime = document.getElementById('updateTime');

            if (isOnline) {
                statusDot.style.background = '#00ff88';
                statusText.textContent = 'æŒ‡æ•°å®æ—¶æ›´æ–°ä¸­';
                updateTime.textContent = 'æ›´æ–°æ—¶é—´: ' + new Date().toLocaleTimeString('zh-CN');
            } else {
                statusDot.style.background = '#ff6b6b';
                statusText.textContent = 'è¿æ¥å¤±è´¥';
                updateTime.textContent = 'æ›´æ–°æ—¶é—´: --';
            }
        }
    </script>
</body>
</html>
