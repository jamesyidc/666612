<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€ƒé¡¶ä¿¡å·æ•°ç»Ÿè®¡ - è¯Šæ–­é¡µé¢</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .log {
            background: #2a2a2a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #4ade80;
        }
        .error {
            border-left-color: #ef4444;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” é€ƒé¡¶ä¿¡å·æ•°ç»Ÿè®¡ - è¯Šæ–­é¡µé¢</h1>
    
    <div>
        <button onclick="testAPI()">æµ‹è¯• API</button>
        <button onclick="testRender()">æµ‹è¯•æ¸²æŸ“</button>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div id="logs"></div>
    
    <script>
        function log(message, isError = false) {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log' + (isError ? ' error' : '');
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function testAPI() {
            log('å¼€å§‹æµ‹è¯• API...');
            
            try {
                const startTime = performance.now();
                log('å‘é€è¯·æ±‚: /api/support-resistance/escape-stats-history?hours=24&limit=1000');
                
                const response = await fetch('/api/support-resistance/escape-stats-history?hours=24&limit=1000');
                const fetchTime = performance.now() - startTime;
                log(`âœ… è¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${fetchTime.toFixed(2)}ms`);
                
                const parseStart = performance.now();
                const result = await response.json();
                const parseTime = performance.now() - parseStart;
                log(`âœ… JSONè§£æå®Œæˆï¼Œè€—æ—¶: ${parseTime.toFixed(2)}ms`);
                
                if (result.success) {
                    log(`âœ… APIè¿”å›æˆåŠŸï¼Œè®°å½•æ•°: ${result.data.length}`);
                    log(`  - ç¬¬ä¸€æ¡: ${result.data[0].stat_time}`);
                    log(`  - æœ€åä¸€æ¡: ${result.data[result.data.length - 1].stat_time}`);
                    
                    // æµ‹è¯•æ•°æ®å¤„ç†
                    const calcStart = performance.now();
                    const max24h = Math.max(...result.data.map(d => d.signal_24h_count));
                    const max2h = Math.max(...result.data.map(d => d.signal_2h_count));
                    const calcTime = performance.now() - calcStart;
                    log(`âœ… ç»Ÿè®¡è®¡ç®—å®Œæˆï¼Œè€—æ—¶: ${calcTime.toFixed(2)}ms`);
                    log(`  - 24hæœ€å¤§: ${max24h}`);
                    log(`  - 2hæœ€å¤§: ${max2h}`);
                } else {
                    log(`âŒ APIè¿”å›å¤±è´¥: ${result.message}`, true);
                }
                
                const totalTime = performance.now() - startTime;
                log(`ğŸ‰ æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, true);
                console.error(error);
            }
        }
        
        async function testRender() {
            log('å¼€å§‹æµ‹è¯•æ¸²æŸ“...');
            
            try {
                const response = await fetch('/api/support-resistance/escape-stats-history?hours=24&limit=100');
                const result = await response.json();
                
                if (!result.success) {
                    log(`âŒ APIè¿”å›å¤±è´¥: ${result.message}`, true);
                    return;
                }
                
                log(`âœ… è·å–åˆ° ${result.data.length} æ¡è®°å½•`);
                
                const renderStart = performance.now();
                const html = result.data.map((row, index) => {
                    return `<div>${index + 1}. ${row.stat_time} | 24h: ${row.signal_24h_count} | 2h: ${row.signal_2h_count}</div>`;
                }).join('');
                const renderTime = performance.now() - renderStart;
                
                log(`âœ… HTMLç”Ÿæˆå®Œæˆï¼Œè€—æ—¶: ${renderTime.toFixed(2)}ms`);
                log(`  - HTMLå¤§å°: ${html.length} å­—ç¬¦`);
                
                // æµ‹è¯•DOMæ’å…¥
                const insertStart = performance.now();
                const testDiv = document.createElement('div');
                testDiv.innerHTML = html;
                const insertTime = performance.now() - insertStart;
                
                log(`âœ… DOMæ’å…¥å®Œæˆï¼Œè€—æ—¶: ${insertTime.toFixed(2)}ms`);
                
                const totalTime = performance.now() - renderStart;
                log(`ğŸ‰ æ¸²æŸ“æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, true);
                console.error(error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
