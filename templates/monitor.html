<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®é‡‡é›†ç›‘æ§ - åŠ å¯†è´§å¸æ•°æ®åˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .status-card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-normal {
            background: #10b981;
        }

        .status-warning {
            background: #f59e0b;
        }

        .status-error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .info-value {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .info-value.success {
            color: #10b981;
        }

        .info-value.warning {
            color: #f59e0b;
        }

        .info-value.error {
            color: #ef4444;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #10b981;
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table th {
            background: #f9fafb;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        .history-table td {
            color: #333;
        }

        .history-table tbody tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .log-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .home-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .home-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="home-link">â† è¿”å›é¦–é¡µ</a>

        <div class="header">
            <h1>ğŸ” æ•°æ®é‡‡é›†ç›‘æ§ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§æ•°æ®é‡‡é›†çŠ¶æ€ï¼Œè‡ªåŠ¨æ£€æµ‹å¹¶æ¢å¤æ¼é‡‡æ•°æ®</p>
        </div>

        <div class="status-card">
            <h2>
                <span class="status-indicator" id="statusIndicator"></span>
                å®æ—¶çŠ¶æ€
            </h2>

            <div id="alertContainer"></div>

            <div class="info-grid" id="statusGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshStatus()">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
                <button class="btn btn-secondary" onclick="checkAndRecover()" id="checkBtn">
                    âœ… æ£€æŸ¥å¹¶æ¢å¤
                </button>
                <button class="btn btn-danger" onclick="forceCollect()" id="forceBtn">
                    ğŸš€ å¼ºåˆ¶é‡‡é›†
                </button>
            </div>

            <div id="logOutput" style="display: none;">
                <h3 style="margin-bottom: 10px;">æ‰§è¡Œæ—¥å¿—</h3>
                <div class="log-output" id="logContent"></div>
            </div>
        </div>

        <div class="status-card">
            <h2>ğŸ”§ æ‰€æœ‰æ¨¡å—ç›‘æ§</h2>
            <p style="color: #666; margin-bottom: 20px;">ç›‘æ§æ‰€æœ‰æ•°æ®é‡‡é›†æ¨¡å—çš„æ›´æ–°çŠ¶æ€</p>
            
            <div id="modulesContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="refreshModules()">
                    ğŸ”„ åˆ·æ–°æ‰€æœ‰æ¨¡å—
                </button>
                <button class="btn btn-secondary" onclick="checkAllModules()" id="checkAllBtn">
                    âœ… æ£€æŸ¥å¹¶æ¢å¤æ‰€æœ‰
                </button>
            </div>

            <div id="moduleLogOutput" style="display: none;">
                <h3 style="margin-bottom: 10px;">æ›´æ–°æ—¥å¿—</h3>
                <div class="log-output" id="moduleLogContent"></div>
            </div>
        </div>

        <div class="status-card">
            <h2>ğŸ“Š é‡‡é›†å†å²</h2>
            <p style="color: #666; margin-bottom: 20px;">æœ€è¿‘2å°æ—¶çš„æ•°æ®é‡‡é›†è®°å½•</p>
            
            <div id="historyContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            refreshStatus();
            loadHistory();
            loadModules();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            autoRefreshInterval = setInterval(() => {
                refreshStatus();
                loadHistory();
                loadModules();
            }, 30000);
        };

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            try {
                const response = await fetch('/api/monitor/status');
                const data = await response.json();
                
                if (data.success) {
                    displayStatus(data.status);
                } else {
                    showAlert('error', 'è·å–çŠ¶æ€å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showAlert('error', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function displayStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const grid = document.getElementById('statusGrid');
            
            // æ›´æ–°æŒ‡ç¤ºå™¨
            if (status.need_collection) {
                indicator.className = 'status-indicator status-error';
                showAlert('warning', status.reason);
            } else {
                indicator.className = 'status-indicator status-normal';
                showAlert('success', status.reason);
            }
            
            // æ„å»ºä¿¡æ¯ç½‘æ ¼
            let html = '';
            
            html += `
                <div class="info-item">
                    <div class="info-label">å½“å‰æ—¶é—´</div>
                    <div class="info-value">${status.current_time}</div>
                </div>
            `;
            
            if (status.latest_snapshot) {
                html += `
                    <div class="info-item">
                        <div class="info-label">æœ€æ–°å¿«ç…§</div>
                        <div class="info-value">${status.latest_snapshot}</div>
                    </div>
                `;
            }
            
            if (status.coin_count) {
                html += `
                    <div class="info-item">
                        <div class="info-label">å¸ç§æ•°é‡</div>
                        <div class="info-value success">${status.coin_count} ä¸ª</div>
                    </div>
                `;
            }
            
            if (status.minutes_since_last !== null) {
                const className = status.minutes_since_last > 12 ? 'error' : 'success';
                html += `
                    <div class="info-item">
                        <div class="info-label">è·ç¦»ä¸Šæ¬¡é‡‡é›†</div>
                        <div class="info-value ${className}">${status.minutes_since_last} åˆ†é’Ÿ</div>
                    </div>
                `;
            }
            
            if (status.expected_next) {
                html += `
                    <div class="info-item">
                        <div class="info-label">é¢„æœŸä¸‹æ¬¡é‡‡é›†</div>
                        <div class="info-value">${status.expected_next}</div>
                    </div>
                `;
            }
            
            if (status.overdue_minutes) {
                html += `
                    <div class="info-item">
                        <div class="info-label">âš ï¸ è¶…æœŸæ—¶é—´</div>
                        <div class="info-value error">${status.overdue_minutes} åˆ†é’Ÿ</div>
                    </div>
                `;
            }
            
            if (status.next_check_in) {
                html += `
                    <div class="info-item">
                        <div class="info-label">ä¸‹æ¬¡æ£€æŸ¥</div>
                        <div class="info-value success">${status.next_check_in} åˆ†é’Ÿå</div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        // åŠ è½½å†å²
        async function loadHistory() {
            try {
                const response = await fetch('/api/monitor/history?hours=2');
                const data = await response.json();
                
                if (data.success) {
                    displayHistory(data.history);
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        `<div class="alert alert-error">è·å–å†å²å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('historyContainer').innerHTML = 
                    `<div class="alert alert-error">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºå†å²
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— é‡‡é›†å†å²</div>';
                return;
            }
            
            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>å¿«ç…§æ—¶é—´</th>
                            <th>å¸ç§æ•°é‡</th>
                            <th>é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            history.forEach(item => {
                let statusBadge = '';
                if (item.status === 'normal') {
                    statusBadge = '<span class="badge badge-success">âœ“ æ­£å¸¸</span>';
                } else if (item.status === 'gap') {
                    statusBadge = '<span class="badge badge-error">âœ— æ¼é‡‡</span>';
                } else if (item.status === 'too_frequent') {
                    statusBadge = '<span class="badge badge-warning">âš  è¿‡é¢‘</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">-</span>';
                }
                
                html += `
                    <tr>
                        <td>${item.snapshot_time}</td>
                        <td>${item.coin_count}</td>
                        <td>${item.interval_to_next !== null ? item.interval_to_next : '-'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        // æ£€æŸ¥å¹¶æ¢å¤
        async function checkAndRecover() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            btn.textContent = 'â³ æ£€æŸ¥ä¸­...';
            
            document.getElementById('logOutput').style.display = 'block';
            document.getElementById('logContent').textContent = 'æ­£åœ¨æ£€æŸ¥æ•°æ®é‡‡é›†çŠ¶æ€...\n';
            
            try {
                const response = await fetch('/api/monitor/check', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    const result = data.result;
                    let log = `æ£€æŸ¥å®Œæˆ!\n\n`;
                    log += `çŠ¶æ€: ${result.status.reason}\n`;
                    
                    if (result.action_taken) {
                        log += `\nâœ… å·²è§¦å‘æ•°æ®é‡‡é›†\n`;
                        if (result.collection_result) {
                            log += `é‡‡é›†ç»“æœ: ${result.collection_result.message}\n`;
                            if (result.collection_result.output) {
                                log += `\nè¾“å‡º:\n${result.collection_result.output}`;
                            }
                        }
                    } else {
                        log += `\nâœ“ æ•°æ®é‡‡é›†æ­£å¸¸ï¼Œæ— éœ€æ“ä½œ\n`;
                    }
                    
                    document.getElementById('logContent').textContent = log;
                    
                    // åˆ·æ–°çŠ¶æ€
                    setTimeout(() => {
                        refreshStatus();
                        loadHistory();
                    }, 2000);
                } else {
                    document.getElementById('logContent').textContent = 'âŒ æ£€æŸ¥å¤±è´¥: ' + data.error;
                }
            } catch (error) {
                document.getElementById('logContent').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ… æ£€æŸ¥å¹¶æ¢å¤';
            }
        }

        // å¼ºåˆ¶é‡‡é›†
        async function forceCollect() {
            if (!confirm('ç¡®å®šè¦ç«‹å³å¼ºåˆ¶é‡‡é›†æ•°æ®å—ï¼Ÿ')) {
                return;
            }
            
            const btn = document.getElementById('forceBtn');
            btn.disabled = true;
            btn.textContent = 'â³ é‡‡é›†ä¸­...';
            
            document.getElementById('logOutput').style.display = 'block';
            document.getElementById('logContent').textContent = 'æ­£åœ¨å¼ºåˆ¶è§¦å‘æ•°æ®é‡‡é›†...\n';
            
            try {
                const response = await fetch('/api/monitor/trigger', { method: 'POST' });
                const data = await response.json();
                
                if (data.success && data.result) {
                    let log = data.result.message + '\n\n';
                    if (data.result.output) {
                        log += data.result.output;
                    }
                    document.getElementById('logContent').textContent = log;
                    
                    // åˆ·æ–°çŠ¶æ€
                    setTimeout(() => {
                        refreshStatus();
                        loadHistory();
                    }, 2000);
                } else {
                    let log = 'âŒ é‡‡é›†å¤±è´¥\n\n';
                    if (data.result && data.result.error) {
                        log += data.result.error;
                    } else {
                        log += data.error || 'æœªçŸ¥é”™è¯¯';
                    }
                    document.getElementById('logContent').textContent = log;
                }
            } catch (error) {
                document.getElementById('logContent').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ å¼ºåˆ¶é‡‡é›†';
            }
        }

        // åŠ è½½æ‰€æœ‰æ¨¡å—çŠ¶æ€
        async function loadModules() {
            try {
                const response = await fetch('/api/monitor/all-modules');
                const data = await response.json();
                
                if (data.success) {
                    displayModules(data.modules);
                } else {
                    document.getElementById('modulesContainer').innerHTML = 
                        `<div class="alert alert-error">è·å–æ¨¡å—çŠ¶æ€å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('modulesContainer').innerHTML = 
                    `<div class="alert alert-error">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ¨¡å—
        function refreshModules() {
            loadModules();
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—çŠ¶æ€
        function displayModules(modules) {
            const container = document.getElementById('modulesContainer');
            
            if (!modules || Object.keys(modules).length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æ¨¡å—æ•°æ®</div>';
                return;
            }
            
            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ¨¡å—</th>
                            <th>æœ€æ–°æ›´æ–°</th>
                            <th>è·ä»Š(åˆ†é’Ÿ)</th>
                            <th>è®°å½•æ•°</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const [key, module] of Object.entries(modules)) {
                let statusBadge = '';
                if (module.status === 'normal') {
                    statusBadge = '<span class="badge badge-success">âœ“ æ­£å¸¸</span>';
                } else if (module.status === 'outdated') {
                    statusBadge = '<span class="badge badge-error">âœ— è¿‡æœŸ</span>';
                } else if (module.status === 'no_data') {
                    statusBadge = '<span class="badge badge-warning">âš  æ— æ•°æ®</span>';
                } else {
                    statusBadge = '<span class="badge badge-warning">? æœªçŸ¥</span>';
                }
                
                const latestTime = module.latest_time || '-';
                const minutesSince = module.minutes_since_last !== null ? module.minutes_since_last : '-';
                const recordCount = module.record_count || 0;
                
                html += `
                    <tr>
                        <td>${module.icon} ${module.module_name}</td>
                        <td>${latestTime}</td>
                        <td>${minutesSince}</td>
                        <td>${recordCount}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-danger" 
                                    onclick="forceUpdateModule('${key}')" 
                                    style="padding: 6px 12px; font-size: 12px;"
                                    ${module.status === 'normal' ? 'disabled' : ''}>
                                ğŸš€ å¼ºåˆ¶æ›´æ–°
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        // æ£€æŸ¥æ‰€æœ‰æ¨¡å—å¹¶è‡ªåŠ¨æ¢å¤
        async function checkAllModules() {
            const btn = document.getElementById('checkAllBtn');
            btn.disabled = true;
            btn.textContent = 'â³ æ£€æŸ¥ä¸­...';
            
            document.getElementById('moduleLogOutput').style.display = 'block';
            document.getElementById('moduleLogContent').textContent = 'æ­£åœ¨æ£€æŸ¥æ‰€æœ‰æ¨¡å—çŠ¶æ€...\n';
            
            try {
                const response = await fetch('/api/monitor/check-all', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    const result = data.result;
                    let log = `æ£€æŸ¥å®Œæˆ!\n\n`;
                    log += `æ€»æ¨¡å—æ•°: ${result.total_modules}\n`;
                    log += `éœ€è¦æ›´æ–°çš„æ¨¡å—: ${result.outdated_modules}\n\n`;
                    
                    if (result.updates_triggered && result.updates_triggered.length > 0) {
                        log += `=== è§¦å‘çš„æ›´æ–° ===\n\n`;
                        result.updates_triggered.forEach(update => {
                            log += `${update.module_name}:\n`;
                            log += `  çŠ¶æ€: ${update.update_result.message}\n`;
                            if (update.update_result.success) {
                                log += `  âœ… æ›´æ–°æˆåŠŸ\n`;
                            } else {
                                log += `  âŒ æ›´æ–°å¤±è´¥\n`;
                                if (update.update_result.error) {
                                    log += `  é”™è¯¯: ${update.update_result.error}\n`;
                                }
                            }
                            log += `\n`;
                        });
                    } else {
                        log += `âœ“ æ‰€æœ‰æ¨¡å—çŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€æ›´æ–°\n`;
                    }
                    
                    document.getElementById('moduleLogContent').textContent = log;
                    
                    // åˆ·æ–°æ¨¡å—çŠ¶æ€
                    setTimeout(() => {
                        loadModules();
                    }, 2000);
                } else {
                    document.getElementById('moduleLogContent').textContent = 'âŒ æ£€æŸ¥å¤±è´¥: ' + data.error;
                }
            } catch (error) {
                document.getElementById('moduleLogContent').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ… æ£€æŸ¥å¹¶æ¢å¤æ‰€æœ‰';
            }
        }

        // å¼ºåˆ¶æ›´æ–°æŒ‡å®šæ¨¡å—
        async function forceUpdateModule(moduleKey) {
            if (!confirm(`ç¡®å®šè¦å¼ºåˆ¶æ›´æ–°è¯¥æ¨¡å—å—ï¼Ÿ`)) {
                return;
            }
            
            document.getElementById('moduleLogOutput').style.display = 'block';
            document.getElementById('moduleLogContent').textContent = `æ­£åœ¨å¼ºåˆ¶æ›´æ–°æ¨¡å— ${moduleKey}...\n`;
            
            try {
                const response = await fetch(`/api/monitor/force-update/${moduleKey}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success && data.result) {
                    let log = data.result.message + '\n\n';
                    if (data.result.output) {
                        log += data.result.output;
                    }
                    document.getElementById('moduleLogContent').textContent = log;
                    
                    // åˆ·æ–°æ¨¡å—çŠ¶æ€
                    setTimeout(() => {
                        loadModules();
                    }, 2000);
                } else {
                    let log = 'âŒ æ›´æ–°å¤±è´¥\n\n';
                    if (data.result && data.result.error) {
                        log += data.result.error;
                    } else {
                        log += data.error || 'æœªçŸ¥é”™è¯¯';
                    }
                    document.getElementById('moduleLogContent').textContent = log;
                }
            } catch (error) {
                document.getElementById('moduleLogContent').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const iconMap = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            };
            
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <span>${iconMap[type]}</span>
                    <span>${message}</span>
                </div>
            `;
        }
    </script>
</body>
</html>
