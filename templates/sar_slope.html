<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARæ–œç‡ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #1e2139;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 30px;
            color: #00d4ff;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
        }
        
        .back-btn {
            background: rgba(59, 125, 255, 0.2);
            border: 1px solid rgba(59, 125, 255, 0.4);
            color: #00d4ff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(59, 125, 255, 0.3);
            border-color: rgba(59, 125, 255, 0.6);
        }
        
        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .crypto-card {
            background: rgba(42, 45, 71, 0.8);
            border: 1px solid rgba(59, 125, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .crypto-card:hover {
            background: rgba(59, 125, 255, 0.15);
            border-color: rgba(59, 125, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .crypto-name {
            font-size: 18px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        .crypto-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #8b92b8;
            margin-bottom: 8px;
        }
        
        .position-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .position-long {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }
        
        .position-short {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
        }
        
        .duration-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(139, 146, 184, 0.2);
        }
        
        .duration-title {
            font-size: 12px;
            color: #8b92b8;
            margin-bottom: 8px;
        }
        
        .duration-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 4px 0;
            color: #d0d4e8;
        }
        
        .duration-label {
            color: #8b92b8;
        }
        
        .duration-value {
            font-weight: 500;
            color: #00d4ff;
        }
        
        .loading {
            text-align: center;
            font-size: 18px;
            color: #8b92b8;
            padding: 50px;
        }
        
        .error {
            text-align: center;
            font-size: 16px;
            color: #ff4444;
            padding: 30px;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(42, 45, 71, 0.8);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(59, 125, 255, 0.3);
        }
        
        .stat-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-count {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stat-count.bullish {
            color: #26ff82;
        }
        
        .stat-count.bearish {
            color: #ff4444;
        }
        
        .stat-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .stat-symbol {
            background: rgba(59, 125, 255, 0.2);
            border: 1px solid rgba(59, 125, 255, 0.4);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .stat-symbol.bullish {
            background: rgba(38, 255, 130, 0.15);
            border-color: rgba(38, 255, 130, 0.4);
            color: #26ff82;
        }
        
        .stat-symbol.bearish {
            background: rgba(255, 68, 68, 0.15);
            border-color: rgba(255, 68, 68, 0.4);
            color: #ff4444;
        }
        
        .stat-empty {
            color: #8b92b8;
            font-size: 14px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SAR æ–œç‡ç³»ç»Ÿ - å¸ç§åˆ—è¡¨</h1>
            <div style="display: flex; gap: 10px;">
                <a href="/sar-bias-trend" class="back-btn" style="background: rgba(38, 214, 57, 0.2); border-color: rgba(38, 214, 57, 0.4); color: #26d639;">
                    ğŸ“Š åå‘è¶‹åŠ¿å›¾
                </a>
                <a href="/" class="back-btn">â† è¿”å›é¦–é¡µ</a>
            </div>
        </div>
        
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="statistics" class="statistics" style="display: none;">
            <div class="stat-card">
                <div class="stat-title">
                    <span>ğŸ“ˆ</span>
                    <span>åå¤šå æ¯” > 80%</span>
                </div>
                <div class="stat-count bullish" id="bullishCount">0</div>
                <div class="stat-list" id="bullishList"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">
                    <span>ğŸ“‰</span>
                    <span>åç©ºå æ¯” > 80%</span>
                </div>
                <div class="stat-count bearish" id="bearishCount">0</div>
                <div class="stat-list" id="bearishList"></div>
            </div>
        </div>
        
        <div id="cryptoGrid" class="crypto-grid"></div>
    </div>

    <script>
        // åŠ è½½æ•°æ®
        async function loadData() {
            console.log('[Main] Starting loadData()...');
            try {
                console.log('[Main] Fetching /api/sar-slope/latest...');
                const response = await fetch('/api/sar-slope/latest');
                const data = await response.json();
                console.log('[Main] Got response:', data.success, 'data count:', data.data?.length);
                
                if (!data.success) {
                    throw new Error(data.error || 'åŠ è½½æ•°æ®å¤±è´¥');
                }
                
                // å…ˆæ˜¾ç¤ºå¸ç§åˆ—è¡¨
                console.log('[Main] Hiding loading, rendering crypto grid...');
                document.getElementById('loading').style.display = 'none';
                renderCryptoGrid(data.data);
                
                // åå°å¼‚æ­¥åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆä¸é˜»å¡é¡µé¢ï¼‰
                console.log('[Main] Starting loadDetailedStatistics in background...');
                document.getElementById('statistics').style.display = 'grid';
                document.getElementById('bullishList').innerHTML = '<div class="stat-empty">æ­£åœ¨åŠ è½½...</div>';
                document.getElementById('bearishList').innerHTML = '<div class="stat-empty">æ­£åœ¨åŠ è½½...</div>';
                
                loadDetailedStatistics(data.data).catch(error => {
                    console.error('[Main] ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥:', error);
                    document.getElementById('bullishList').innerHTML = '<div class="stat-empty">åŠ è½½å¤±è´¥</div>';
                    document.getElementById('bearishList').innerHTML = '<div class="stat-empty">åŠ è½½å¤±è´¥</div>';
                });
                
            } catch (error) {
                console.error('[Main] Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message;
            }
        }
        
        // åŠ è½½è¯¦ç»†ç»Ÿè®¡æ•°æ®ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
        async function loadDetailedStatistics(cryptos) {
            console.log('[Statistics] Starting to load detailed statistics for', cryptos.length, 'cryptos');
            const bullishSymbols = [];
            const bearishSymbols = [];
            
            let completed = 0;
            const total = cryptos.length;
            
            // æ‰¹é‡åŠ è½½æ¯ä¸ªå¸ç§çš„åå‘ç»Ÿè®¡ï¼ˆé™åˆ¶å¹¶å‘æ•°é‡ï¼‰
            const batchSize = 5; // æ¯æ‰¹5ä¸ªè¯·æ±‚
            for (let i = 0; i < cryptos.length; i += batchSize) {
                const batch = cryptos.slice(i, i + batchSize);
                console.log(`[Statistics] Processing batch ${Math.floor(i/batchSize) + 1}:`, batch.map(c => c.symbol).join(', '));
                
                await Promise.all(batch.map(async (crypto) => {
                    try {
                        const response = await fetch(`/api/sar-slope/current-cycle/${crypto.symbol}?_t=${Date.now()}`, {
                            signal: AbortSignal.timeout(5000) // 5ç§’è¶…æ—¶
                        });
                        const data = await response.json();
                        
                        if (data.success && data.bias_statistics) {
                            const stats = data.bias_statistics;
                            const bullishRatio = stats.bullish_ratio || 0;
                            const bearishRatio = stats.bearish_ratio || 0;
                            
                            console.log(`[Statistics] ${crypto.symbol}: bullish=${bullishRatio.toFixed(1)}%, bearish=${bearishRatio.toFixed(1)}%`);
                            
                            // åå¤šå æ¯” > 80%
                            if (bullishRatio > 80) {
                                bullishSymbols.push({
                                    symbol: crypto.symbol,
                                    ratio: bullishRatio
                                });
                                console.log(`[Statistics] âœ“ ${crypto.symbol} added to bullish (${bullishRatio.toFixed(1)}%)`);
                            }
                            
                            // åç©ºå æ¯” > 80%
                            if (bearishRatio > 80) {
                                bearishSymbols.push({
                                    symbol: crypto.symbol,
                                    ratio: bearishRatio
                                });
                                console.log(`[Statistics] âœ“ ${crypto.symbol} added to bearish (${bearishRatio.toFixed(1)}%)`);
                            }
                        }
                    } catch (error) {
                        console.error(`[Statistics] Failed to load ${crypto.symbol}:`, error);
                    }
                    
                    completed++;
                    // æ›´æ–°è¿›åº¦
                    document.getElementById('bullishList').innerHTML = `<div class="stat-empty">åŠ è½½ä¸­... ${completed}/${total}</div>`;
                }));
            }
            
            console.log('[Statistics] Finished loading. Bullish:', bullishSymbols.length, 'Bearish:', bearishSymbols.length);
            // æ˜¾ç¤ºç»Ÿè®¡ç»“æœ
            renderStatistics(bullishSymbols, bearishSymbols);
        }
        
        // æ¸²æŸ“ç»Ÿè®¡ç»“æœ
        function renderStatistics(bullishSymbols, bearishSymbols) {
            document.getElementById('statistics').style.display = 'grid';
            
            // åå¤šç»Ÿè®¡
            document.getElementById('bullishCount').textContent = bullishSymbols.length;
            const bullishList = document.getElementById('bullishList');
            if (bullishSymbols.length > 0) {
                bullishList.innerHTML = bullishSymbols
                    .sort((a, b) => b.ratio - a.ratio)
                    .map(item => `<span class="stat-symbol bullish">${item.symbol} (${item.ratio.toFixed(1)}%)</span>`)
                    .join('');
            } else {
                bullishList.innerHTML = '<div class="stat-empty">æš‚æ— å¸ç§</div>';
            }
            
            // åç©ºç»Ÿè®¡
            document.getElementById('bearishCount').textContent = bearishSymbols.length;
            const bearishList = document.getElementById('bearishList');
            if (bearishSymbols.length > 0) {
                bearishList.innerHTML = bearishSymbols
                    .sort((a, b) => b.ratio - a.ratio)
                    .map(item => `<span class="stat-symbol bearish">${item.symbol} (${item.ratio.toFixed(1)}%)</span>`)
                    .join('');
            } else {
                bearishList.innerHTML = '<div class="stat-empty">æš‚æ— å¸ç§</div>';
            }
        }
        
        // æ¸²æŸ“å¸ç§ç½‘æ ¼
        function renderCryptoGrid(cryptos) {
            const grid = document.getElementById('cryptoGrid');
            grid.innerHTML = '';
            
            cryptos.forEach(crypto => {
                const card = document.createElement('div');
                card.className = 'crypto-card';
                card.onclick = () => window.location.href = `/sar-slope/${crypto.symbol}`;
                
                const positionClass = crypto.current_position === 'long' ? 'position-long' : 'position-short';
                const positionText = crypto.current_position === 'long' ? 'å¤šå¤´' : 'ç©ºå¤´';
                
                card.innerHTML = `
                    <div class="crypto-name">${crypto.symbol}</div>
                    <div class="crypto-info">
                        <span>å½“å‰çŠ¶æ€:</span>
                        <span class="position-badge ${positionClass}">${positionText} ${crypto.current_sequence}</span>
                    </div>
                    <div class="crypto-info">
                        <span>Kçº¿æ•°é‡:</span>
                        <span>${crypto.total_klines}</span>
                    </div>
                    <div class="crypto-info">
                        <span>æœ€åæ›´æ–°:</span>
                        <span>${crypto.last_kline_time}</span>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        loadData();
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadData, 30000);
    </script>
</body>
</html>
