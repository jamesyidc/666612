<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>åšå¤šåšç©ºè¯„åˆ†æ€»è§ˆ - 19å¸ç§å¤šæ—¶é—´æ®µåˆ†æ v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1229 100%);
            border-radius: 12px;
            border: 2px solid #2a3558;
        }

        .header h1 {
            font-size: 28px;
            color: #fff;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 14px;
            color: #8b8fa4;
        }

        .update-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 13px;
        }

        .update-info .item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .update-info .dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px #00ff88; }
            50% { opacity: 0.5; box-shadow: 0 0 16px #00ff88; }
        }

        .summary-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #0f1229;
            border-radius: 12px;
            border: 2px solid #2a3558;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-card {
            padding: 15px;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(139, 143, 164, 0.2);
            text-align: center;
        }

        .summary-card .label {
            font-size: 12px;
            color: #8b8fa4;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 20px;
            font-weight: 600;
        }

        .summary-card .value.long {
            color: #00ff88;
        }

        .summary-card .value.short {
            color: #ff4d4f;
        }

        .summary-card .value.diff {
            color: #ffa726;
        }

        .table-container {
            overflow-x: auto;
            background: #0f1229;
            border-radius: 12px;
            border: 2px solid #2a3558;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #1a1f3a;
            color: #fff;
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #2a3558;
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #2a3558;
        }

        tr:nth-child(even) {
            background: rgba(26, 31, 58, 0.3);
        }

        tr:hover {
            background: rgba(42, 53, 88, 0.5);
        }

        .coin-name {
            font-weight: 600;
            color: #64b5f6;
            font-size: 14px;
        }

        .score-long {
            color: #00ff88;
            font-weight: 600;
        }

        .score-short {
            color: #ff4d4f;
            font-weight: 600;
        }

        .score-diff {
            font-weight: 600;
        }

        .score-diff.positive {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .score-diff.negative {
            color: #ff4d4f;
            background: rgba(255, 77, 79, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .trend-label {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .trend-label.bullish {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .trend-label.bearish {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
            border: 1px solid #ff4d4f;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b8fa4;
            font-size: 16px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 255, 136, 0.2);
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š åšå¤šåšç©ºè¯„åˆ†æ€»è§ˆ</h1>
        <div class="subtitle">å¤šæ—¶é—´æ®µæ·±åº¦è¯„åˆ†åˆ†æ - å®æ—¶ç›‘æ§å„å¸ç§åšå¤šåšç©ºè¶‹åŠ¿</div>
        <div class="update-info">
            <div class="item">
                <div class="dot"></div>
                <span>è‡ªåŠ¨åˆ·æ–°: 30ç§’/æ¬¡</span>
            </div>
            <div class="item">
                <span>ä¸Šæ¬¡æ›´æ–°: <span id="lastUpdateTime">--</span></span>
            </div>
        </div>
    </div>

    <!-- å¹³å‡è¯„åˆ†æ±‡æ€» -->
    <div class="summary-section">
        <div class="summary-title">
            <span>ğŸ“ˆ</span>
            <span>å…¨å¸ç§å¹³å‡è¯„åˆ†ï¼ˆå„æ—¶é—´æ®µï¼‰</span>
        </div>
        <div class="summary-grid" id="summaryGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th rowspan="2">å¸ç§</th>
                    <th colspan="3">3åˆ†é’Ÿ</th>
                    <th colspan="3">1å°æ—¶</th>
                    <th colspan="3">3å°æ—¶</th>
                    <th colspan="3">6å°æ—¶</th>
                    <th colspan="3">12å°æ—¶</th>
                    <th colspan="3">24å°æ—¶</th>
                </tr>
                <tr>
                    <!-- 3åˆ†é’Ÿ -->
                    <th>åšå¤š</th>
                    <th>åšç©º</th>
                    <th>å·®å€¼</th>
                    <!-- 1å°æ—¶ -->
                    <th>åšå¤š</th>
                    <th>åšç©º</th>
                    <th>å·®å€¼</th>
                    <!-- 3å°æ—¶ -->
                    <th>åšå¤š</th>
                    <th>åšç©º</th>
                    <th>å·®å€¼</th>
                    <!-- 6å°æ—¶ -->
                    <th>åšå¤š</th>
                    <th>åšç©º</th>
                    <th>å·®å€¼</th>
                    <!-- 12å°æ—¶ -->
                    <th>åšå¤š</th>
                    <th>åšç©º</th>
                    <th>å·®å€¼</th>
                    <!-- 24å°æ—¶ -->
                    <th>åšå¤š</th>
                    <th>åšç©º</th>
                    <th>å·®å€¼</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <tr>
                    <td colspan="19" class="loading">
                        <div class="loading-spinner"></div>
                        <div>åŠ è½½æ•°æ®ä¸­...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // APIé…ç½® - ä½¿ç”¨ç›¸å¯¹è·¯å¾„è‡ªåŠ¨é€‚é…
        const HISTORY_API_PORT = 5011;
        const HISTORY_API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? `http://localhost:${HISTORY_API_PORT}`
            : window.location.protocol + '//' + window.location.hostname.replace('3000-', `${HISTORY_API_PORT}-`);
        
        // å¸ç§åˆ—è¡¨ - 19ä¸ªå¸ç§
        const SYMBOLS = [
            'BTC-USDT-SWAP',
            'ETH-USDT-SWAP',
            'XRP-USDT-SWAP',
            'BNB-USDT-SWAP',
            'SOL-USDT-SWAP',
            'LTC-USDT-SWAP',
            'DOGE-USDT-SWAP',
            'SUI-USDT-SWAP',
            'TRX-USDT-SWAP',
            'TON-USDT-SWAP',
            'ETC-USDT-SWAP',
            'BCH-USDT-SWAP',
            'HBAR-USDT-SWAP',
            'XLM-USDT-SWAP',
            'FIL-USDT-SWAP',
            'LINK-USDT-SWAP',
            'CRO-USDT-SWAP',
            'DOT-USDT-SWAP',
            'AAVE-USDT-SWAP',
            'UNI-USDT-SWAP',
            'NEAR-USDT-SWAP',
            'APT-USDT-SWAP',
            'CFX-USDT-SWAP',
            'CRV-USDT-SWAP',
            'STX-USDT-SWAP',
            'LDO-USDT-SWAP',
            'TAO-USDT-SWAP'
        ];

        // æ—¶é—´èŒƒå›´
        const TIME_RANGES = ['3m', '1h', '3h', '6h', '12h', '24h'];
        const RANGE_LABELS = {
            '3m': '3åˆ†é’Ÿ',
            '1h': '1å°æ—¶',
            '3h': '3å°æ—¶',
            '6h': '6å°æ—¶',
            '12h': '12å°æ—¶',
            '24h': '24å°æ—¶'
        };

        // æ•°æ®å­˜å‚¨
        let allData = {};

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½æ‰€æœ‰å¸ç§å’Œæ—¶é—´æ®µæ•°æ®...');
            console.log('ğŸ“¡ API URL:', HISTORY_API_URL);
            
            const promises = [];
            
            for (const symbol of SYMBOLS) {
                for (const range of TIME_RANGES) {
                    promises.push(
                        fetch(`${HISTORY_API_URL}/api/depth/history/${symbol}?range=${range}`)
                            .then(res => res.json())
                            .then(data => ({
                                symbol,
                                range,
                                data
                            }))
                            .catch(error => {
                                console.error(`âŒ ${symbol} ${range} åŠ è½½å¤±è´¥:`, error);
                                return { symbol, range, data: { success: false } };
                            })
                    );
                }
            }

            const results = await Promise.all(promises);
            
            // ç»„ç»‡æ•°æ®
            allData = {};
            for (const result of results) {
                if (!allData[result.symbol]) {
                    allData[result.symbol] = {};
                }
                allData[result.symbol][result.range] = result.data;
            }

            console.log('âœ… æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
            updateDisplay();
        }

        // è®¡ç®—å¹³å‡å€¼
        function calculateAverage(values) {
            if (values.length === 0) return 0;
            const sum = values.reduce((a, b) => a + b, 0);
            return sum / values.length;
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            updateSummary();
            updateTable();
            updateLastUpdateTime();
        }

        // æ›´æ–°æ±‡æ€»åŒºåŸŸ
        function updateSummary() {
            const summaryGrid = document.getElementById('summaryGrid');
            
            const averages = {};
            
            // è®¡ç®—æ¯ä¸ªæ—¶é—´æ®µçš„å¹³å‡å€¼
            for (const range of TIME_RANGES) {
                const longScores = [];
                const shortScores = [];
                
                for (const symbol of SYMBOLS) {
                    const data = allData[symbol]?.[range];
                    if (data?.success && data?.history?.length > 0) {
                        const avgLong = calculateAverage(data.history.map(d => d.long_score));
                        const avgShort = calculateAverage(data.history.map(d => d.short_score));
                        longScores.push(avgLong);
                        shortScores.push(avgShort);
                    }
                }
                
                const avgLong = calculateAverage(longScores);
                const avgShort = calculateAverage(shortScores);
                const diff = avgLong - avgShort;
                
                averages[range] = {
                    long: avgLong,
                    short: avgShort,
                    diff: diff
                };
            }

            // ç”ŸæˆHTML
            let html = '';
            for (const range of TIME_RANGES) {
                const avg = averages[range];
                html += `
                    <div class="summary-card">
                        <div class="label">${RANGE_LABELS[range]}</div>
                        <div class="value long">${avg.long.toFixed(1)}</div>
                        <div class="label" style="margin-top: 8px;">åšç©º</div>
                        <div class="value short">${avg.short.toFixed(1)}</div>
                        <div class="label" style="margin-top: 8px;">å·®å€¼</div>
                        <div class="value diff">${avg.diff > 0 ? '+' : ''}${avg.diff.toFixed(1)}</div>
                        <div class="trend-label ${avg.diff > 0 ? 'bullish' : 'bearish'}" style="margin-top: 8px;">
                            ${avg.diff > 0 ? 'åšå¤šåŒºé—´' : 'åšç©ºåŒºé—´'}
                        </div>
                    </div>
                `;
            }
            
            summaryGrid.innerHTML = html;
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            let html = '';

            for (const symbol of SYMBOLS) {
                const coinName = symbol.split('-')[0];
                html += `<tr><td class="coin-name">${coinName}</td>`;

                for (const range of TIME_RANGES) {
                    const data = allData[symbol]?.[range];
                    
                    if (data?.success && data?.history?.length > 0) {
                        const avgLong = calculateAverage(data.history.map(d => d.long_score));
                        const avgShort = calculateAverage(data.history.map(d => d.short_score));
                        const diff = avgLong - avgShort;
                        
                        html += `
                            <td class="score-long">${avgLong.toFixed(1)}</td>
                            <td class="score-short">${avgShort.toFixed(1)}</td>
                            <td><span class="score-diff ${diff > 0 ? 'positive' : 'negative'}">${diff > 0 ? '+' : ''}${diff.toFixed(1)}</span></td>
                        `;
                    } else {
                        html += `
                            <td>--</td>
                            <td>--</td>
                            <td>--</td>
                        `;
                    }
                }

                html += '</tr>';
            }

            tbody.innerHTML = html;
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('lastUpdateTime').textContent = timeStr;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“Š è¯„åˆ†æ€»è§ˆé¡µé¢åˆå§‹åŒ–');
            loadAllData();
            
            // 30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(() => {
                console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°æ•°æ®...');
                loadAllData();
            }, 30000);
        });
    </script>
</body>
</html>
