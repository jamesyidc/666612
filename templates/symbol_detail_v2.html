<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ symbol }} Kçº¿å›¾ - æŠ€æœ¯æŒ‡æ ‡åˆ†æ v6.0</title>
    <!-- å¼ºåˆ¶åˆ·æ–°ç‰ˆæœ¬: 2025-12-11-22:00-CACHE-BUSTER -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #0e1117;
            color: #e0e0e0;
        }
        
        .header {
            background: #1a1d29;
            padding: 20px;
            border-bottom: 2px solid #2d3348;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #00d4aa;
        }
        
        .header .nav {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .header .nav a {
            color: #888;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .header .nav a:hover {
            background: #2d3348;
            color: #00d4aa;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 10px;
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 20px;
            flex-shrink: 0;
        }
        
        .timeframe-tabs {
            display: flex;
            gap: 10px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: #1a1d29;
            border: 2px solid #2d3348;
            color: #888;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #00d4aa;
            color: #0e1117;
            border-color: #00d4aa;
        }
        
        .tab-btn:hover:not(.active) {
            border-color: #00d4aa;
            color: #00d4aa;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-btn {
            padding: 10px 20px;
            background: #1a1d29;
            border: 2px solid #2d3348;
            color: #00d4aa;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #00d4aa;
            color: #0e1117;
        }
        
        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .page-info {
            color: #888;
            font-size: 14px;
        }
        
        .chart-container {
            background: #1a1d29;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #00d4aa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-range {
            font-size: 14px;
            color: #888;
            font-weight: normal;
        }
        
        .chart {
            width: 100%;
            height: 600px;
            min-height: 600px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .spinner {
            border: 3px solid #2d3348;
            border-top: 3px solid #00d4aa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #1a1d29;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00d4aa;
        }
        
        .stat-label {
            color: #888;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        /* éšè—ç»Ÿè®¡å’Œè¾…åŠ©å›¾è¡¨ï¼Œåªæ˜¾ç¤ºä¸»Kçº¿å›¾ */
        .stats-grid,
        #rsi-container,
        #indicators-container {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ symbol }} - Kçº¿å›¾æŠ€æœ¯åˆ†æ</h1>
        <div class="nav">
            <a href="/">â† è¿”å›é¦–é¡µ</a>
            <a href="/kline-indicators">æŠ€æœ¯æŒ‡æ ‡æ€»è§ˆ</a>
        </div>
    </div>
    
    <div class="container">
        <div class="controls">
            <div class="timeframe-tabs">
                <button class="tab-btn active" onclick="switchTimeframe('5m')">5åˆ†é’Ÿ</button>
                <button class="tab-btn" onclick="switchTimeframe('1h')">1å°æ—¶</button>
            </div>
            
            <div class="pagination">
                <button class="page-btn" id="prev-btn" onclick="prevPage()">â† ä¸Šä¸€é¡µ</button>
                <div class="page-info" id="page-info">ç¬¬ 1 é¡µ</div>
                <button class="page-btn" id="next-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â†’</button>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">
                <span>Kçº¿å›¾ & æˆäº¤é‡</span>
                <span style="color: #00d4aa; font-size: 12px; margin-left: 10px;">[v4.0-FINAL]</span>
                <span class="date-range" id="date-range"></span>
            </div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½æ•°æ®ä¸­...</p>
            </div>
            <div id="kline-chart" class="chart" style="display:none; height: 600px;"></div>
        </div>
        
        <div class="stats-grid" id="stats-grid" style="display:none;">
            <div class="stat-card">
                <div class="stat-label">å½“å‰ä»·æ ¼</div>
                <div class="stat-value" id="stat-price">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">RSI(14)</div>
                <div class="stat-value" id="stat-rsi">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">SARä½ç½®</div>
                <div class="stat-value" id="stat-sar-position">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">SARå€¼</div>
                <div class="stat-value" id="stat-sar-value">-</div>
            </div>
        </div>
        
        <div class="chart-container" style="display:none;" id="rsi-container">
            <div class="chart-title">RSI æŒ‡æ ‡ (14)</div>
            <div id="rsi-chart" class="chart" style="height:300px;"></div>
        </div>
        
        <div class="chart-container" style="display:none;" id="indicators-container">
            <div class="chart-title">SAR & å¸ƒæ—å¸¦æŒ‡æ ‡</div>
            <div id="indicators-chart" class="chart" style="height:400px;"></div>
        </div>
    </div>
    
    <script>
        // ============================================
        // ç‰ˆæœ¬æ§åˆ¶: v6.0 - 2025-12-11-22:00
        // å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬ç¼“å­˜
        // ============================================
        const CURRENT_VERSION = 'v6.0';
        const VERSION_KEY = 'kline_chart_version';
        
        // æ£€æŸ¥ç‰ˆæœ¬å¹¶å¼ºåˆ¶åˆ·æ–°
        (function checkVersion() {
            const savedVersion = localStorage.getItem(VERSION_KEY);
            console.log(`%c[ç‰ˆæœ¬æ£€æŸ¥] å½“å‰ç‰ˆæœ¬: ${CURRENT_VERSION}, ç¼“å­˜ç‰ˆæœ¬: ${savedVersion}`, 'color: #00d4aa; font-size: 14px; font-weight: bold');
            
            if (savedVersion !== CURRENT_VERSION) {
                console.log(`%c[ç‰ˆæœ¬æ›´æ–°] æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼æ¸…é™¤æ—§ç¼“å­˜...`, 'color: #ff4444; font-size: 14px; font-weight: bold');
                localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
                
                // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
            }
            
            console.log(`%c[${CURRENT_VERSION}] Kçº¿å›¾è¡¨ç³»ç»Ÿå·²åŠ è½½`, 'color: #00d4aa; font-size: 16px; font-weight: bold');
        })();
        
        const symbol = '{{ symbol }}';
        let currentTimeframe = '5m';
        let allKlineData = [];
        let allIndicatorsData = [];
        let currentPage = 0;
        let klineChart, rsiChart, indicatorsChart;
        
        // æ¯é¡µæ˜¾ç¤º12å°æ—¶çš„æ•°æ®
        const RECORDS_PER_PAGE = {
            '5m': 144,   // 12å°æ—¶ Ã— 12æ ¹/å°æ—¶ = 144æ ¹
            '1h': 12     // 12å°æ—¶ = 12æ ¹
        };
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            klineChart = echarts.init(document.getElementById('kline-chart'));
            // rsiChartå’ŒindicatorsChartå·²éšè—ï¼Œä¸éœ€è¦åˆå§‹åŒ–
            
            window.addEventListener('resize', () => {
                klineChart.resize();
            });
        }
        
        // åŠ è½½æ•°æ®
        async function loadData(timeframe) {
            currentTimeframe = timeframe;
            currentPage = 0;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('kline-chart').style.display = 'none';
            document.getElementById('stats-grid').style.display = 'none';
            document.getElementById('rsi-container').style.display = 'none';
            document.getElementById('indicators-container').style.display = 'none';
            
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®...', { symbol, timeframe });
                const [klineRes, indicatorsRes] = await Promise.all([
                    fetch(`/api/symbol/${symbol}/kline?timeframe=${timeframe}`),
                    fetch(`/api/symbol/${symbol}/indicators?timeframe=${timeframe}`)
                ]);
                
                const klineData = await klineRes.json();
                const indicatorsData = await indicatorsRes.json();
                
                console.log('æ•°æ®åŠ è½½å®Œæˆ:', {
                    klineSuccess: klineData.success,
                    klineCount: klineData.data?.length,
                    indicatorsSuccess: indicatorsData.success,
                    indicatorsCount: indicatorsData.data?.length
                });
                
                if (klineData.success && indicatorsData.success) {
                    allKlineData = klineData.data;
                    allIndicatorsData = indicatorsData.data;
                    console.log('å¼€å§‹æ¸²æŸ“é¡µé¢...');
                    renderCurrentPage();
                    console.log('é¡µé¢æ¸²æŸ“å®Œæˆ');
                } else {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', { klineData, indicatorsData });
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å‡ºé”™:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // æ¸²æŸ“å½“å‰é¡µæ•°æ®
        function renderCurrentPage() {
            const recordsPerPage = RECORDS_PER_PAGE[currentTimeframe];
            const totalPages = Math.ceil(allKlineData.length / recordsPerPage);
            
            // è®¡ç®—å½“å‰é¡µæ•°æ®èŒƒå›´ï¼ˆä»æœ€æ–°æ•°æ®å¼€å§‹ï¼‰
            const startIdx = Math.max(0, allKlineData.length - (currentPage + 1) * recordsPerPage);
            const endIdx = allKlineData.length - currentPage * recordsPerPage;
            
            const pageKlineData = allKlineData.slice(startIdx, endIdx);
            
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šåŸºäºtimestampå¯¹é½æŒ‡æ ‡æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç›¸åŒç´¢å¼•
            // åˆ›å»ºä¸€ä¸ªtimestampåˆ°æŒ‡æ ‡çš„æ˜ å°„
            const indicatorsByTimestamp = {};
            allIndicatorsData.forEach(ind => {
                indicatorsByTimestamp[ind.timestamp] = ind;
            });
            
            // ä¸ºæ¯ä¸ªKçº¿æ‰¾åˆ°åŒ¹é…çš„æŒ‡æ ‡æ•°æ®
            const pageIndicatorsData = pageKlineData.map(kline => {
                return indicatorsByTimestamp[kline.timestamp] || {
                    timestamp: kline.timestamp,
                    sar: null,
                    bb_upper: null,
                    bb_middle: null,
                    bb_lower: null,
                    rsi: null
                };
            });
            
            renderCharts(pageKlineData, pageIndicatorsData);
            updatePagination(totalPages);
            
            if (pageIndicatorsData.length > 0 && pageIndicatorsData[pageIndicatorsData.length - 1].sar !== null) {
                updateStats(pageIndicatorsData[pageIndicatorsData.length - 1]);
            }
        }
        
        // æ›´æ–°åˆ†é¡µæŒ‰é’®
        function updatePagination(totalPages) {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInfo = document.getElementById('page-info');
            
            prevBtn.disabled = currentPage >= totalPages - 1;
            nextBtn.disabled = currentPage === 0;
            
            pageInfo.textContent = `ç¬¬ ${currentPage + 1} / ${totalPages} é¡µ`;
        }
        
        // ä¸Šä¸€é¡µ
        function prevPage() {
            currentPage++;
            renderCurrentPage();
        }
        
        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage > 0) {
                currentPage--;
                renderCurrentPage();
            }
        }
        
        // è®¡ç®—æ—¥æœŸåˆ†å‰²çº¿
        function getDateSeparators(times) {
            const separators = [];
            let lastDate = null;
            
            times.forEach((time, index) => {
                const date = new Date(parseInt(time)).toLocaleDateString('zh-CN');
                if (lastDate && date !== lastDate) {
                    separators.push({
                        xAxis: index,
                        label: { formatter: date }
                    });
                }
                lastDate = date;
            });
            
            return separators;
        }
        
        // æ¸²æŸ“å›¾è¡¨
        function renderCharts(klineData, indicatorsData) {
            console.log('renderCharts è¢«è°ƒç”¨:', {
                klineDataLength: klineData.length,
                indicatorsDataLength: indicatorsData.length,
                klineChartExists: !!klineChart,
                firstKline: klineData[0],
                firstIndicator: indicatorsData[0]
            });
            
            const times = klineData.map(item => {
                const date = new Date(parseInt(item.timestamp));
                return date.toLocaleString('zh-CN', { 
                    timeZone: 'Asia/Shanghai',
                    month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                });
            });
            
            const ohlc = klineData.map(item => item.data);
            const volumes = klineData.map(item => item.volume);
            
            // [v6.0] è°ƒè¯•æ•°æ®ç»“æ„
            console.log('%c========================================', 'color: #ff4444; font-size: 14px; font-weight: bold');
            console.log('%c[v6.0 æ•°æ®éªŒè¯] Kçº¿æ•°æ®ç»“æ„æ£€æŸ¥', 'color: #ff4444; font-size: 14px; font-weight: bold');
            console.log('%c========================================', 'color: #ff4444; font-size: 14px; font-weight: bold');
            console.log('[v6.0] First K-line raw data:', klineData[0]);
            console.log('[v6.0] First OHLC array:', ohlc[0]);
            console.log('%c[v6.0] OHLCæ ¼å¼: [å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]', 'color: #00d4aa; font-weight: bold');
            console.log('[v6.0] è§£æåçš„å€¼:', {
                å¼€ç›˜ä»·: ohlc[0][0],
                æ”¶ç›˜ä»·: ohlc[0][1],
                æœ€ä½ä»·: ohlc[0][2],
                æœ€é«˜ä»·: ohlc[0][3],
                æˆäº¤é‡: volumes[0]
            });
            console.log('%c========================================', 'color: #ff4444; font-size: 14px; font-weight: bold');
            
            // ä½¿ç”¨indicators APIæä¾›çš„çœŸå®æ•°æ®ï¼ˆä¸Kçº¿timestampå¯¹é½ï¼‰
            const rsi = indicatorsData.map(item => item.rsi);
            const sar = indicatorsData.map(item => item.sar);
            const bbUpper = indicatorsData.map(item => item.bb_upper);
            const bbMiddle = indicatorsData.map(item => item.bb_middle);
            const bbLower = indicatorsData.map(item => item.bb_lower);
            
            // æ£€æŸ¥æ•°æ®å€¼èŒƒå›´
            const ohlcValues = ohlc.flat().filter(v => v !== null);
            const sarValues = sar.filter(v => v !== null && v !== undefined);
            const bbValues = [...bbUpper, ...bbMiddle, ...bbLower].filter(v => v !== null && v !== undefined);
            
            console.log('æ•°æ®æ•°ç»„:', {
                times: times.length,
                ohlc: ohlc.length,
                volumes: volumes.length,
                sar: sar.length,
                bbUpper: bbUpper.length,
                bbMiddle: bbMiddle.length,
                bbLower: bbLower.length
            });
            
            console.log('æ•°æ®å€¼èŒƒå›´:', {
                ohlcRange: `${Math.min(...ohlcValues).toFixed(4)} - ${Math.max(...ohlcValues).toFixed(4)}`,
                sarRange: sarValues.length > 0 ? `${Math.min(...sarValues).toFixed(4)} - ${Math.max(...sarValues).toFixed(4)}` : 'No values',
                bbRange: bbValues.length > 0 ? `${Math.min(...bbValues).toFixed(4)} - ${Math.max(...bbValues).toFixed(4)}` : 'No values',
                sarValidCount: sarValues.length,
                bbValidCount: bbValues.length
            });
            
            console.log('æ ·æœ¬æ•°æ®:', {
                firstOhlc: ohlc[0],
                firstSar: sar[0],
                firstBbUpper: bbUpper[0],
                firstBbMiddle: bbMiddle[0],
                firstBbLower: bbLower[0],
                lastOhlc: ohlc[ohlc.length-1],
                lastSar: sar[sar.length-1],
                lastBbUpper: bbUpper[bbUpper.length-1]
            });
            
            // æ—¥æœŸåˆ†å‰²çº¿
            const dateSeparators = getDateSeparators(klineData.map(item => item.timestamp));
            
            // æ›´æ–°æ—¥æœŸèŒƒå›´æ˜¾ç¤º
            if (klineData.length > 0) {
                const startDate = new Date(parseInt(klineData[0].timestamp)).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
                const endDate = new Date(parseInt(klineData[klineData.length - 1].timestamp)).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
                document.getElementById('date-range').textContent = `${startDate} ~ ${endDate}`;
            }
            
            // Kçº¿å›¾é…ç½®
            const klineOption = {
                backgroundColor: 'transparent',
                legend: {
                    data: ['Kçº¿', 'å¸ƒæ—ä¸Šè½¨', 'å¸ƒæ—ä¸­è½¨', 'å¸ƒæ—ä¸‹è½¨', 'SAR', 'æˆäº¤é‡'],
                    top: '1%',
                    left: 'center',
                    textStyle: {
                        color: '#888',
                        fontSize: 12
                    },
                    icon: 'roundRect',
                    itemWidth: 12,
                    itemHeight: 8,
                    itemGap: 15
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(26, 29, 41, 0.95)',
                    borderColor: '#2d3348',
                    textStyle: { color: '#e0e0e0' },
                    formatter: function(params) {
                        let result = `<span style="color:#ff4444;font-weight:bold">[v6.0]</span> ${params[0].axisValue}<br/>`;
                        
                        // è·å–å½“å‰æ•°æ®ç‚¹çš„ç´¢å¼•
                        const dataIndex = params[0].dataIndex;
                        
                        params.forEach(item => {
                            if (item.seriesName === 'Kçº¿') {
                                const ohlcData = item.data;
                                const open = parseFloat(ohlcData[0]);
                                const close = parseFloat(ohlcData[1]);
                                const low = parseFloat(ohlcData[2]);
                                const high = parseFloat(ohlcData[3]);
                                
                                // [v6.0] è°ƒè¯•æ—¥å¿— - éªŒè¯æ•°æ®æ­£ç¡®æ€§
                                console.log('%c[v6.0 TOOLTIP] é¼ æ ‡æ‚¬åœæ•°æ®:', 'color: #ff4444; font-weight: bold', {
                                    raw_array: ohlcData,
                                    parsed: { open, close, low, high },
                                    dataIndex: dataIndex,
                                    timestamp: params[0].axisValue
                                });
                                
                                // è®¡ç®—æ¶¨è·Œå¹…: (æ”¶ç›˜ä»· - å¼€ç›˜ä»·) / å¼€ç›˜ä»· Ã— 100%
                                const changePct = ((close - open) / open * 100).toFixed(2);
                                const changeColor = changePct >= 0 ? '#00d4aa' : '#ff4444';
                                const changeSign = changePct >= 0 ? '+' : '';
                                
                                // è®¡ç®—éœ‡è¡å¹…åº¦: (æœ€é«˜ä»· - æœ€ä½ä»·) / å¼€ç›˜ä»· Ã— 100%
                                const volatilityPct = ((high - low) / open * 100).toFixed(2);
                                
                                console.log(`%c[v6.0 è®¡ç®—ç»“æœ] æ¶¨è·Œå¹…=${changeSign}${changePct}% éœ‡è¡å¹…åº¦=${volatilityPct}%`, 'color: #00d4aa; font-weight: bold');
                                
                                result += `å¼€: ${open.toFixed(3)}<br/>`;
                                result += `æ”¶: ${close.toFixed(3)}<br/>`;
                                result += `ä½: ${low.toFixed(3)}<br/>`;
                                result += `é«˜: ${high.toFixed(3)}<br/>`;
                                result += `<span style="color:${changeColor}">æ¶¨è·Œå¹…: ${changeSign}${changePct}%</span><br/>`;
                                result += `éœ‡è¡å¹…åº¦: ${volatilityPct}%<br/>`;
                                
                                // æ·»åŠ RSIæŒ‡æ ‡ï¼ˆä»rsiæ•°ç»„ä¸­è·å–å¯¹åº”ç´¢å¼•çš„å€¼ï¼‰
                                if (typeof rsi !== 'undefined' && rsi[dataIndex] !== null && rsi[dataIndex] !== undefined) {
                                    const rsiValue = parseFloat(rsi[dataIndex]);
                                    let rsiColor = '#888';
                                    if (rsiValue >= 70) {
                                        rsiColor = '#ff4444'; // è¶…ä¹°ï¼Œçº¢è‰²
                                    } else if (rsiValue <= 30) {
                                        rsiColor = '#00d4aa'; // è¶…å–ï¼Œç»¿è‰²
                                    }
                                    result += `<span style="color:${rsiColor}">RSI: ${rsiValue.toFixed(2)}</span><br/>`;
                                }
                            } else if (item.seriesName === 'æˆäº¤é‡') {
                                result += `<span style="color:${item.color}">â— ${item.seriesName}: ${item.data}</span><br/>`;
                            } else if (item.seriesName === 'SAR') {
                                result += `<span style="color:${item.color}">â— ${item.seriesName}: ${item.data ? item.data.toFixed(4) : '-'}</span><br/>`;
                            } else if (item.seriesName.includes('å¸ƒæ—')) {
                                result += `<span style="color:${item.color}">â” ${item.seriesName}: ${item.data ? item.data.toFixed(4) : '-'}</span><br/>`;
                            }
                        });
                        return result;
                    }
                },
                grid: [
                    { left: '3%', right: '2%', top: '8%', height: '65%' },
                    { left: '3%', right: '2%', top: '77%', height: '18%' }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: times,
                        gridIndex: 0,
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { 
                            color: '#888',
                            rotate: 0,
                            fontSize: 10,
                            interval: function(index, value) {
                                // æ˜¾ç¤ºæ¯12ä¸ªæ ‡ç­¾ï¼ˆ5åˆ†é’Ÿå‘¨æœŸæ¯å°æ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼‰
                                return index % 12 === 0;
                            }
                        }
                    },
                    {
                        type: 'category',
                        data: times,
                        gridIndex: 1,
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { show: false }
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        gridIndex: 0,
                        splitLine: { lineStyle: { color: '#2d3348' } },
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { color: '#888' }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitLine: { show: false },
                        axisLine: { lineStyle: { color: '#2d3348' } },
                        axisLabel: { color: '#888' }
                    }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: ohlc,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#00d4aa',
                            color0: '#ff4444',
                            borderColor: '#00d4aa',
                            borderColor0: '#ff4444'
                        },
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: {
                                color: '#888',
                                type: 'solid',
                                width: 1
                            },
                            data: dateSeparators
                        }
                    },
                    {
                        name: 'å¸ƒæ—ä¸Šè½¨',
                        type: 'line',
                        data: bbUpper,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        smooth: true,
                        lineStyle: {
                            color: '#f39c12',
                            width: 1,
                            type: 'dashed'
                        },
                        showSymbol: false,
                        z: 1
                    },
                    {
                        name: 'å¸ƒæ—ä¸­è½¨',
                        type: 'line',
                        data: bbMiddle,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        smooth: true,
                        lineStyle: {
                            color: '#3498db',
                            width: 1.5
                        },
                        showSymbol: false,
                        z: 1
                    },
                    {
                        name: 'å¸ƒæ—ä¸‹è½¨',
                        type: 'line',
                        data: bbLower,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        smooth: true,
                        lineStyle: {
                            color: '#f39c12',
                            width: 1,
                            type: 'dashed'
                        },
                        showSymbol: false,
                        z: 1
                    },
                    {
                        name: 'SAR',
                        type: 'scatter',
                        data: sar,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        symbol: 'circle',
                        symbolSize: 4,
                        itemStyle: {
                            color: function(params) {
                                // æ ¹æ®SARä½ç½®åˆ¤æ–­å¤šç©º
                                const sarValue = params.value;
                                const ohlcValue = ohlc[params.dataIndex];
                                if (sarValue && ohlcValue) {
                                    const closePrice = ohlcValue[1]; // close price
                                    // SARåœ¨ä»·æ ¼ä¸‹æ–¹ä¸ºå¤šå¤´ï¼ˆç»¿è‰²ï¼‰ï¼ŒSARåœ¨ä»·æ ¼ä¸Šæ–¹ä¸ºç©ºå¤´ï¼ˆçº¢è‰²ï¼‰
                                    return sarValue < closePrice ? '#00d4aa' : '#ff4444';
                                }
                                return '#888';
                            }
                        },
                        z: 2
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        data: volumes,
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        itemStyle: {
                            color: function(params) {
                                const idx = params.dataIndex;
                                const isUp = ohlc[idx][1] >= ohlc[idx][0];
                                return isUp ? 'rgba(0, 212, 170, 0.5)' : 'rgba(255, 68, 68, 0.5)';
                            }
                        }
                    }
                ]
            };
            
            // å…ˆæ˜¾ç¤ºå›¾è¡¨å®¹å™¨
            document.getElementById('kline-chart').style.display = 'block';
            
            // è®¾ç½®å›¾è¡¨é…ç½®
            klineChart.setOption(klineOption, true);
            
            // ç«‹å³resizeä¸€æ¬¡
            klineChart.resize();
            
            // å†æ¬¡å»¶è¿Ÿresizeç¡®ä¿æ­£ç¡®æ¸²æŸ“
            setTimeout(() => {
                klineChart.resize();
                console.log('å›¾è¡¨å·²resize:', {
                    width: document.getElementById('kline-chart').offsetWidth,
                    height: document.getElementById('kline-chart').offsetHeight,
                    seriesCount: klineOption.series.length
                });
            }, 100);
            // éšè—ç»Ÿè®¡å’Œè¾…åŠ©å›¾è¡¨
            // document.getElementById('stats-grid').style.display = 'grid';
            // document.getElementById('rsi-container').style.display = 'block';
            // document.getElementById('indicators-container').style.display = 'block';
            
            // RSIå›¾
            const rsiOption = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(26, 29, 41, 0.95)',
                    borderColor: '#2d3348',
                    textStyle: { color: '#e0e0e0' }
                },
                grid: { left: '5%', right: '3%', top: '10%', bottom: '10%' },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#2d3348' } },
                    axisLabel: { show: false }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    splitLine: { lineStyle: { color: '#2d3348' } },
                    axisLine: { lineStyle: { color: '#2d3348' } },
                    axisLabel: { color: '#888' }
                },
                visualMap: {
                    show: false,
                    pieces: [
                        { gte: 70, color: '#ff4444' },
                        { gte: 30, lte: 70, color: '#888' },
                        { lte: 30, color: '#00d4aa' }
                    ]
                },
                series: [{
                    name: 'RSI',
                    type: 'line',
                    data: rsi,
                    smooth: true,
                    lineStyle: { width: 2 },
                    markLine: {
                        silent: true,
                        symbol: 'none',
                        data: [
                            { yAxis: 70, lineStyle: { color: '#ff4444', type: 'dashed' } },
                            { yAxis: 30, lineStyle: { color: '#00d4aa', type: 'dashed' } }
                        ]
                    }
                }]
            };
            
            // rsiChartå·²éšè—ï¼Œä¸éœ€è¦æ¸²æŸ“
            // rsiChart.setOption(rsiOption, true);
            
            // SAR & å¸ƒæ—å¸¦å›¾
            const indicatorsOption = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(26, 29, 41, 0.95)',
                    borderColor: '#2d3348',
                    textStyle: { color: '#e0e0e0' }
                },
                legend: {
                    data: ['SAR', 'BBä¸Šè½¨', 'BBä¸­è½¨', 'BBä¸‹è½¨'],
                    textStyle: { color: '#888' },
                    top: 0
                },
                grid: { left: '5%', right: '3%', top: '15%', bottom: '10%' },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#2d3348' } },
                    axisLabel: { show: false }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    splitLine: { lineStyle: { color: '#2d3348' } },
                    axisLine: { lineStyle: { color: '#2d3348' } },
                    axisLabel: { color: '#888' }
                },
                series: [
                    {
                        name: 'SAR',
                        type: 'scatter',
                        data: sar,
                        symbolSize: 4,
                        itemStyle: { color: '#ffd700' }
                    },
                    {
                        name: 'BBä¸Šè½¨',
                        type: 'line',
                        data: bbUpper,
                        lineStyle: { color: '#ff4444', width: 1 },
                        showSymbol: false
                    },
                    {
                        name: 'BBä¸­è½¨',
                        type: 'line',
                        data: bbMiddle,
                        lineStyle: { color: '#888', width: 1 },
                        showSymbol: false
                    },
                    {
                        name: 'BBä¸‹è½¨',
                        type: 'line',
                        data: bbLower,
                        lineStyle: { color: '#00d4aa', width: 1 },
                        showSymbol: false
                    }
                ]
            };
            
            // indicatorsChartå·²éšè—ï¼Œä¸éœ€è¦æ¸²æŸ“
            // indicatorsChart.setOption(indicatorsOption, true);
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(latestIndicator) {
            document.getElementById('stat-price').textContent = '$' + latestIndicator.price.toFixed(4);
            document.getElementById('stat-rsi').textContent = latestIndicator.rsi.toFixed(2);
            document.getElementById('stat-sar-position').textContent = latestIndicator.sar_position || '-';
            document.getElementById('stat-sar-value').textContent = latestIndicator.sar ? '$' + latestIndicator.sar.toFixed(4) : '-';
        }
        
        // åˆ‡æ¢æ—¶é—´å‘¨æœŸ
        function switchTimeframe(timeframe) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadData(timeframe);
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            console.log('window.onload è§¦å‘');
            console.log('ECharts æ˜¯å¦åŠ è½½:', typeof echarts !== 'undefined');
            console.log('ECharts ç‰ˆæœ¬:', typeof echarts !== 'undefined' ? echarts.version : 'N/A');
            initCharts();
            loadData('5m');
        };
    </script>
</body>
</html>
