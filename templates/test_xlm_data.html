<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>XLMæ•°æ®æµ‹è¯•é¡µ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1d2e;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2a2d47;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            color: #3b7dff;
            border-bottom: 2px solid #3b7dff;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3a3d5c;
        }
        th {
            background: #3a3d5c;
            font-weight: bold;
        }
        .value {
            font-family: 'Courier New', monospace;
        }
        .good {
            color: #67C23A;
        }
        .error {
            color: #F56C6C;
        }
        pre {
            background: #1a1d2e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” XLM Kçº¿æ•°æ®è¯Šæ–­</h1>
        
        <div class="section">
            <h2>1. APIåŸå§‹å“åº”æµ‹è¯•</h2>
            <p>URL: <code id="api-url"></code></p>
            <p>çŠ¶æ€: <span id="api-status"></span></p>
            <p>æ•°æ®æ¡æ•°: <span id="data-count"></span></p>
            
            <h3>æœ€å5æ¡Kçº¿OHLCæ•°æ®</h3>
            <table id="ohlc-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´æˆ³</th>
                        <th>å¼€ç›˜(Open)</th>
                        <th>æœ€é«˜(High)</th>
                        <th>æœ€ä½(Low)</th>
                        <th>æ”¶ç›˜(Close)</th>
                        <th>æˆäº¤é‡</th>
                    </tr>
                </thead>
                <tbody id="ohlc-tbody"></tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>2. æ•°æ®å­—æ®µå®Œæ•´æ€§æ£€æŸ¥</h2>
            <table>
                <tr>
                    <td>âœ… dataå­—æ®µå­˜åœ¨</td>
                    <td id="has-data-field" class="value"></td>
                </tr>
                <tr>
                    <td>âœ… dataæ˜¯æ•°ç»„</td>
                    <td id="data-is-array" class="value"></td>
                </tr>
                <tr>
                    <td>âœ… dataé•¿åº¦ä¸º4 (OHLC)</td>
                    <td id="data-length-4" class="value"></td>
                </tr>
                <tr>
                    <td>âœ… markerså­—æ®µå­˜åœ¨</td>
                    <td id="has-markers" class="value"></td>
                </tr>
            </table>
        </div>
        
        <div class="section">
            <h2>3. å®Œæ•´JSON (æœ€å1æ¡)</h2>
            <pre id="full-json"></pre>
        </div>
        
        <div class="section">
            <h2>4. ä»·æ ¼ç»Ÿè®¡</h2>
            <table>
                <tr>
                    <td>å¼€ç›˜ä»·èŒƒå›´</td>
                    <td id="open-range" class="value"></td>
                </tr>
                <tr>
                    <td>æœ€é«˜ä»·èŒƒå›´</td>
                    <td id="high-range" class="value"></td>
                </tr>
                <tr>
                    <td>æœ€ä½ä»·èŒƒå›´</td>
                    <td id="low-range" class="value"></td>
                </tr>
                <tr>
                    <td>æ”¶ç›˜ä»·èŒƒå›´</td>
                    <td id="close-range" class="value"></td>
                </tr>
                <tr>
                    <td>âŒ æ˜¯å¦æœ‰0.22å¼‚å¸¸</td>
                    <td id="has-022" class="value"></td>
                </tr>
            </table>
        </div>
    </div>
    
    <script>
        const symbol = 'XLM-USDT-SWAP';
        const timeframe = '5m';
        const apiUrl = `/api/symbol/${symbol}/kline?timeframe=${timeframe}&_=${Date.now()}`;
        
        document.getElementById('api-url').textContent = apiUrl;
        
        async function loadAndTestData() {
            try {
                console.log('ğŸ“Š å¼€å§‹è·å–APIæ•°æ®...');
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    document.getElementById('api-status').innerHTML = '<span class="error">âŒ å¤±è´¥</span>';
                    return;
                }
                
                const data = result.data;
                document.getElementById('api-status').innerHTML = '<span class="good">âœ… æˆåŠŸ</span>';
                document.getElementById('data-count').innerHTML = `<span class="good">${data.length}</span>`;
                
                // æ˜¾ç¤ºæœ€å5æ¡OHLC
                const tbody = document.getElementById('ohlc-tbody');
                const last5 = data.slice(-5);
                
                last5.forEach(item => {
                    const row = tbody.insertRow();
                    const ohlc = item.data || [];
                    const ts = new Date(parseInt(item.timestamp)).toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    row.innerHTML = `
                        <td>${ts}</td>
                        <td class="value ${ohlc[0] ? 'good' : 'error'}">${ohlc[0] ? ohlc[0].toFixed(6) : 'null'}</td>
                        <td class="value ${ohlc[1] ? 'good' : 'error'}">${ohlc[1] ? ohlc[1].toFixed(6) : 'null'}</td>
                        <td class="value ${ohlc[2] ? 'good' : 'error'}">${ohlc[2] ? ohlc[2].toFixed(6) : 'null'}</td>
                        <td class="value ${ohlc[3] ? 'good' : 'error'}">${ohlc[3] ? ohlc[3].toFixed(6) : 'null'}</td>
                        <td class="value">${item.volume ? item.volume.toFixed(2) : '-'}</td>
                    `;
                });
                
                // å­—æ®µå®Œæ•´æ€§æ£€æŸ¥
                const lastItem = data[data.length - 1];
                document.getElementById('has-data-field').innerHTML = 
                    lastItem.data !== undefined ? '<span class="good">âœ… å­˜åœ¨</span>' : '<span class="error">âŒ ä¸å­˜åœ¨</span>';
                document.getElementById('data-is-array').innerHTML = 
                    Array.isArray(lastItem.data) ? '<span class="good">âœ… æ˜¯æ•°ç»„</span>' : '<span class="error">âŒ ä¸æ˜¯æ•°ç»„</span>';
                document.getElementById('data-length-4').innerHTML = 
                    lastItem.data && lastItem.data.length === 4 ? '<span class="good">âœ… é•¿åº¦ä¸º4</span>' : `<span class="error">âŒ é•¿åº¦ä¸º${lastItem.data ? lastItem.data.length : 0}</span>`;
                document.getElementById('has-markers').innerHTML = 
                    lastItem.markers ? '<span class="good">âœ… å­˜åœ¨</span>' : '<span class="error">âŒ ä¸å­˜åœ¨</span>';
                
                // å®Œæ•´JSON
                document.getElementById('full-json').textContent = JSON.stringify(lastItem, null, 2);
                
                // ä»·æ ¼ç»Ÿè®¡
                const opens = data.filter(d => d.data && d.data[0]).map(d => d.data[0]);
                const highs = data.filter(d => d.data && d.data[1]).map(d => d.data[1]);
                const lows = data.filter(d => d.data && d.data[2]).map(d => d.data[2]);
                const closes = data.filter(d => d.data && d.data[3]).map(d => d.data[3]);
                
                if (opens.length > 0) {
                    document.getElementById('open-range').textContent = 
                        `${Math.min(...opens).toFixed(6)} ~ ${Math.max(...opens).toFixed(6)}`;
                    document.getElementById('high-range').textContent = 
                        `${Math.min(...highs).toFixed(6)} ~ ${Math.max(...highs).toFixed(6)}`;
                    document.getElementById('low-range').textContent = 
                        `${Math.min(...lows).toFixed(6)} ~ ${Math.max(...lows).toFixed(6)}`;
                    document.getElementById('close-range').textContent = 
                        `${Math.min(...closes).toFixed(6)} ~ ${Math.max(...closes).toFixed(6)}`;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰0.22çš„å¼‚å¸¸å€¼
                    const has022 = [...opens, ...highs, ...lows, ...closes].some(v => Math.abs(v - 0.22) < 0.00001);
                    document.getElementById('has-022').innerHTML = has022 ? 
                        '<span class="error">âŒ å‘ç°0.22å¼‚å¸¸å€¼</span>' : 
                        '<span class="good">âœ… æ— 0.22å¼‚å¸¸</span>';
                } else {
                    document.getElementById('open-range').innerHTML = '<span class="error">æ— æ•°æ®</span>';
                }
                
                console.log('âœ… æ•°æ®æµ‹è¯•å®Œæˆ');
                
            } catch (err) {
                console.error('âŒ é”™è¯¯:', err);
                document.getElementById('api-status').innerHTML = `<span class="error">âŒ ${err.message}</span>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
        loadAndTestData();
    </script>
</body>
</html>
